head	1.2;
access;
symbols;
locks
	mibl:1.2; strict;
comment	@# @;


1.2
date	2004.08.27.08.35.28;	author mibl;	state Exp;
branches;
next	1.1;

1.1
date	2004.08.26.09.48.35;	author mibl;	state Exp;
branches;
next	;


desc
@Started new version of upload, to handle problems with timeouts.
This upload will redirect the userr to a link where the result
will be presented iun[D[3~instead
@


1.2
log
@Foxed Javasscript refresh of progressbar
@
text
@#!/usr/bin/perl 
# $Id: upload2.cgi,v 1.1 2004/08/26 09:48:35 mibl Exp mibl $

# This version redirects the user to a statuspage, where the results will be
# displayed instead.
# This is to accomodate for long timeouts during analysis, which 
# the httpd daemon doesn't handle well.

 
use CGI; 

use Sys::Syslog;                          # all except setlogsock, or:
use Sys::Syslog qw(:DEFAULT setlogsock);  # default set, plus setlogsock
use Fcntl ':flock'; # import LOCK_* constants

$SECSRCH = '/usr/local/slac/secsrch.pl';
$FWSECSRCH = '/usr/local/slac/fw1-secsrch.pl';
$upload_dir = '/var/tmp';

$query = new CGI;

slog("Remote host: " . $query->remote_host());
slog("Request method: " . $query->request_method());
slog("HTTP Headers: " . $query->http());

foreach $x ($query->http()) {
    slog($x . ': ' . $query->http($x));
}

#exit;

slog("Retrieved POST value-pairs:");
%P = $query->Vars;
#slog("%P");
foreach $p1 (keys %P) {
    slog("  $p1\: $P{$p1}");
}

$filename = $query->param("logfile"); 
slog("Filename: $filename");
$email_address = $query->param("email_address"); 
slog("Email address: $email_adddress");
$type = $query->param("type");
slog("Type: $type");

# Check for correctly filled in params befor processing

if ($filename =~ m/^$/) {
    slog("Missing filename. Exiting");
    print $query->header(-type=>'text/html');
    print $query->start_html();
    print "Missing filename!<br>Hit 'Back' in your browser and select a file before submitting.";
    print $query->end_html();
    exit;
}

$filename =~ s/.*[\/\\](.*)/$1/; 
$file = $upload_dir . '/' . $$ . $filename;

$ssparam = '';   # String of parameters to send to analysis prog

#print $query->redirect('http://www.google.com');

if ($query->param("nr") eq '') { $ssparam .= ' -N '; }
if ($query->param('output') eq 'xml') { 
    $ssparam .= ' -X '; 
    print $query->header(-type=>'text/xml'); 
} else {
    #$dispos = 'attachment; filename=' . $filename . '.slac.txt';
    $dispos = 'filename=' . $filename . '.slac.txt';
    print $query->header(-Content_Disposition=>$dispos,
			 -type=>'text/plain'); 
}

$uploadid = $query->param('UploadID');

if ($query->param('explan') =~ m/^on$/i) {
    slog("Adding Explanatory texts");
    $ssparam .= ' -p ';
}

if ($type =~ m/^fw$/i) {
    $ANALYSIS = $FWSECSRCH;
    $ssparam .= ' -i ';
} elsif ($type =~ m/^web$/i) {
    $ANALYSIS = $SECSRCH;
    $ssparam .= ' -i '; 
} else {
    slog("Someone is fooling around with 'type' param. Exiting!");
    exit;
}
    


#######   Start receiving file from client
slog("Started Receiving file: $filename"); 
$upload_filehandle = $query->upload("logfile"); 
$statfile = "/var/tmp/$uploadid.log";
open UPLOADFILE, ">$file";
binmode UPLOADFILE;
while ( <$upload_filehandle> ) { 
    print UPLOADFILE; 
    #slog("  Input Length: " . length());
    $total_recv += length(); 

    # Write progress to status file, for reading from 'progressbar.cgi'
    pstatus($filename,$total_recv,"Receiving file...");
} 

close UPLOADFILE; 

slog("Received bytes totally: $total_recv");



if ( ! -f $file ) {
    slog("Exiting. File '$file' does not exist.");
    die "Exiting. File '$file' does not exist.";
} else {
    slog("File uploaded: $file.");
}

pstatus($filename, $total_recv, "Analysis in progress. Please wait.");

($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime,$ctime,$blksize,$blocks) = stat "$file";

$run = $ANALYSIS . " $ssparam $file " . '-o -';

slog("Command to run: " . $run);

#$result = system($run);
$result = qx/$run/;

# Write progress to status file, for reading from 'progressbar.cgi'
$filename =~ s/\.gz//g;  # Remove '.gz' from filename because IE cant handle it
pstatus($filename, $total_recv, "Analysis completed.");

slog("Results returned with error " . ($? >> 8));
# Print result to STDOUT (browser) 
print $result;

# Also print to a file for later retrieval.
$outfile = "/var/wwwtornado/htdocs/slac/results/$uploadid.$filename.txt";
open OUTFILE,">$outfile";
print OUTFILE $result;
close OUTFILE;



exit;

print <<END_HTML; 

<HTML> 
    <HEAD> 
    <TITLE>Thanks!</TITLE> 
    </HEAD> 

    <BODY> 

    <P>Your file was received and will be processed shortly.</P> 
    <P>Your email address: $email_address</P> 
    <P>Your Logfile: $filename</P> 
    <P>Starttime: $starttime</P>
    <table>
    <tr><td>Parameters:</td><td>$ssparam</td></tr>
    <tr><td>Receieved bytes: </td><td>$size</td></tr>
    <tr><td>atime</td><td>$atime</td></tr>
    
    </table>

    Processing will commence immediately, and the results will be shown below.<br><br><br>

    <font "courier,sans serif">

END_HTML



$result = system($run);


print <<END_HTML2;

$result



    </font>
    </BODY> 
</HTML> 


END_HTML2




sub slog {
    setlogsock('unix');
    openlog('upload.cgi', 'cons,pid', 'local2');
    syslog('info', '%s', @@_);
    closelog;
}

sub pstatus {
    # Print progress to status file, for reading from 'progressbar.cgi'
    $filename = @@_[0];
    $total_recv = @@_[1];
    $status = @@_[2];
    
    open STATUS, ">$statfile";
    flock(STATUS,LOCK_EX);
    print STATUS "$filename\n";
    print STATUS "$total_recv\n";
    print STATUS "$status\n";
    flock(STATUS,LOCK_UN);
    close STATUS;
}
@


1.1
log
@Initial revision
@
text
@d2 1
a2 1
# $Id: upload.cgi,v 1.4 2004/08/25 12:07:52 mibl Exp $
d4 6
d14 1
d57 2
d60 1
d62 1
a62 1
$ssparam = '';   # String of parameters to send to analysis prog
d69 4
a72 1
    print $query->header(-type=>'text/plain'); 
d75 2
a92 2
$filename =~ s/.*[\/\\](.*)/$1/; 
$file = $upload_dir . '/' . $$ . $filename;
d95 2
a96 1
# Start receiving file from client
d98 1
d103 5
a107 1
    
d112 3
a114 1
#$file = '/var/tmp/30290ex000916.log';
d123 1
d134 6
a139 5
#print $query->header(-type => "text/xml"); 
#print "Content-Type: text/xml\n\n";
#$starttime = localtime();
#print $query->start_html();
#print "gyfebglk";
d141 9
a149 1
#print $query->end_html();
d205 15
@
