head	1.93;
access;
symbols;
locks
	mibl:1.93;
comment	@# @;


1.93
date	2008.02.20.08.00.13;	author mibl;	state Exp;
branches;
next	1.92;

1.92
date	2007.12.03.15.38.40;	author mibl;	state Exp;
branches;
next	1.91;

1.91
date	2007.08.27.13.17.41;	author mibl;	state Exp;
branches;
next	1.90;

1.90
date	2004.12.04.07.00.03;	author mibl;	state Exp;
branches;
next	1.89;

1.89
date	2004.09.06.10.43.48;	author mibl;	state Exp;
branches;
next	1.88;

1.88
date	2004.09.06.07.11.51;	author mibl;	state Exp;
branches;
next	1.87;

1.87
date	2004.09.06.06.52.48;	author mibl;	state Exp;
branches;
next	1.86;

1.86
date	2004.08.25.11.26.35;	author mibl;	state Exp;
branches;
next	1.85;

1.85
date	2004.05.14.09.26.33;	author mibl;	state Exp;
branches;
next	1.84;

1.84
date	2004.05.11.08.45.59;	author mibl;	state Exp;
branches;
next	1.83;

1.83
date	2004.05.08.17.07.56;	author mibl;	state Exp;
branches;
next	1.82;

1.82
date	2004.05.06.09.42.44;	author mibl;	state Exp;
branches;
next	1.81;

1.81
date	2004.05.04.10.02.32;	author mibl;	state Exp;
branches;
next	1.80;

1.80
date	2004.05.04.09.13.41;	author mibl;	state Exp;
branches;
next	1.79;

1.79
date	2004.05.04.07.26.51;	author mibl;	state Exp;
branches;
next	1.78;

1.78
date	2003.11.24.22.07.48;	author mibl;	state Exp;
branches;
next	1.77;

1.77
date	2003.11.23.19.48.30;	author mibl;	state Exp;
branches;
next	1.76;

1.76
date	2003.11.23.19.40.13;	author mibl;	state Exp;
branches;
next	1.75;

1.75
date	2003.10.21.09.59.21;	author mibl;	state Exp;
branches;
next	1.74;

1.74
date	2003.10.19.06.50.49;	author mibl;	state Exp;
branches;
next	1.73;

1.73
date	2003.10.19.06.05.45;	author mibl;	state Exp;
branches;
next	1.72;

1.72
date	2003.08.08.11.54.27;	author mibl;	state Exp;
branches;
next	1.71;

1.71
date	2003.08.08.11.52.30;	author mibl;	state Exp;
branches;
next	1.70;

1.70
date	2003.08.05.05.45.18;	author mibl;	state Exp;
branches;
next	1.69;

1.69
date	2003.07.11.19.35.32;	author mibl;	state Exp;
branches;
next	1.68;

1.68
date	2003.07.03.11.48.10;	author mibl;	state Exp;
branches;
next	1.67;

1.67
date	2003.06.29.20.50.28;	author mibl;	state Exp;
branches;
next	1.66;

1.66
date	2003.06.29.08.27.35;	author mibl;	state Exp;
branches;
next	1.65;

1.65
date	2003.06.29.08.25.41;	author mibl;	state Exp;
branches;
next	1.64;

1.64
date	2003.06.22.20.12.14;	author mibl;	state Exp;
branches;
next	1.63;

1.63
date	2003.06.22.20.11.20;	author mibl;	state Exp;
branches;
next	1.62;

1.62
date	2003.06.10.14.10.23;	author mibl;	state Exp;
branches;
next	1.61;

1.61
date	2003.06.02.18.54.21;	author mibl;	state Exp;
branches;
next	1.60;

1.60
date	2003.06.02.18.25.53;	author mibl;	state Exp;
branches;
next	1.59;

1.59
date	2003.05.26.19.42.00;	author mibl;	state Exp;
branches;
next	1.58;

1.58
date	2003.05.26.19.39.49;	author mibl;	state Exp;
branches;
next	1.57;

1.57
date	2003.05.22.21.23.28;	author mibl;	state Exp;
branches;
next	1.56;

1.56
date	2003.05.08.07.29.33;	author mibl;	state Exp;
branches;
next	1.55;

1.55
date	2003.05.06.13.42.57;	author mibl;	state Exp;
branches;
next	1.54;

1.54
date	2003.04.27.22.05.58;	author mibl;	state Exp;
branches;
next	1.53;

1.53
date	2003.04.27.21.18.29;	author mibl;	state Exp;
branches;
next	1.52;

1.52
date	2003.04.27.21.17.34;	author mibl;	state Exp;
branches;
next	1.51;

1.51
date	2003.04.27.21.16.03;	author mibl;	state Exp;
branches;
next	1.50;

1.50
date	2003.04.27.20.12.22;	author mibl;	state Exp;
branches;
next	1.49;

1.49
date	2003.04.16.16.00.09;	author mibl;	state Exp;
branches;
next	1.48;

1.48
date	2003.04.16.14.43.31;	author mibl;	state Exp;
branches;
next	1.47;

1.47
date	2003.04.16.14.09.33;	author mibl;	state Exp;
branches;
next	1.46;

1.46
date	2003.04.16.13.27.06;	author mibl;	state Exp;
branches;
next	1.45;

1.45
date	2003.04.16.12.27.06;	author mibl;	state Exp;
branches;
next	1.44;

1.44
date	2003.04.14.12.30.59;	author mibl;	state Exp;
branches;
next	1.43;

1.43
date	2003.04.08.09.04.22;	author mibl;	state Exp;
branches;
next	1.42;

1.42
date	2003.03.31.20.23.21;	author mibl;	state Exp;
branches;
next	1.41;

1.41
date	2003.03.31.14.22.56;	author mibl;	state Exp;
branches;
next	1.40;

1.40
date	2003.03.31.12.28.17;	author mibl;	state Exp;
branches;
next	1.39;

1.39
date	2003.03.30.19.49.05;	author mibl;	state Exp;
branches;
next	1.38;

1.38
date	2003.03.28.14.04.12;	author mibl;	state Exp;
branches;
next	1.37;

1.37
date	2003.03.28.12.47.49;	author mibl;	state Exp;
branches;
next	1.36;

1.36
date	2003.03.28.12.46.47;	author mibl;	state Exp;
branches;
next	1.35;

1.35
date	2003.03.25.21.43.20;	author mibl;	state Exp;
branches;
next	1.34;

1.34
date	2003.03.25.08.47.18;	author mibl;	state Exp;
branches;
next	1.33;

1.33
date	2003.03.24.20.17.34;	author mibl;	state Exp;
branches;
next	1.32;

1.32
date	2003.03.24.19.51.01;	author mibl;	state Exp;
branches;
next	1.31;

1.31
date	2003.03.24.13.16.10;	author root;	state Exp;
branches;
next	1.30;

1.30
date	2003.03.24.08.40.07;	author root;	state Exp;
branches;
next	1.29;

1.29
date	2003.03.20.14.49.20;	author root;	state Exp;
branches;
next	1.28;

1.28
date	2003.03.19.13.27.17;	author root;	state Exp;
branches;
next	1.27;

1.27
date	2003.03.18.21.52.36;	author root;	state Exp;
branches;
next	1.26;

1.26
date	2003.03.18.09.53.20;	author root;	state Exp;
branches;
next	1.25;

1.25
date	2003.03.18.09.47.57;	author root;	state Exp;
branches;
next	1.24;

1.24
date	2003.03.18.08.00.37;	author root;	state Exp;
branches;
next	1.23;

1.23
date	2003.03.18.07.58.33;	author root;	state Exp;
branches;
next	1.22;

1.22
date	2003.02.20.21.28.42;	author root;	state Exp;
branches;
next	1.21;

1.21
date	2003.02.11.09.03.34;	author mibl;	state Exp;
branches;
next	1.20;

1.20
date	2003.01.14.12.45.34;	author mibl;	state Exp;
branches;
next	1.19;

1.19
date	2003.01.14.12.42.04;	author mibl;	state Exp;
branches;
next	1.18;

1.18
date	2002.11.27.08.23.24;	author mibl;	state Exp;
branches;
next	1.17;

1.17
date	2002.11.26.13.17.07;	author root;	state Exp;
branches;
next	1.16;

1.16
date	2002.07.02.08.22.44;	author root;	state Exp;
branches;
next	1.15;

1.15
date	2002.06.25.15.23.25;	author root;	state Exp;
branches;
next	1.14;

1.14
date	2002.06.25.14.35.25;	author root;	state Exp;
branches;
next	1.13;

1.13
date	2002.06.18.10.18.40;	author root;	state Exp;
branches;
next	1.12;

1.12
date	2002.06.18.09.22.46;	author root;	state Exp;
branches;
next	1.11;

1.11
date	2002.06.17.13.19.50;	author root;	state Exp;
branches;
next	1.10;

1.10
date	2002.06.16.22.15.48;	author root;	state Exp;
branches;
next	1.9;

1.9
date	2002.06.16.20.56.59;	author root;	state Exp;
branches;
next	1.8;

1.8
date	2002.06.16.18.49.52;	author mibl;	state Exp;
branches;
next	1.7;

1.7
date	2002.06.16.13.51.50;	author mibl;	state Exp;
branches;
next	1.6;

1.6
date	2002.06.14.13.51.10;	author mibl;	state Exp;
branches;
next	1.5;

1.5
date	2002.06.14.12.15.22;	author mibl;	state Exp;
branches;
next	1.4;

1.4
date	2002.06.14.12.11.16;	author mibl;	state Exp;
branches;
next	1.3;

1.3
date	2002.06.14.12.09.35;	author mibl;	state Exp;
branches;
next	1.2;

1.2
date	2002.06.14.12.00.09;	author mibl;	state Exp;
branches;
next	1.1;

1.1
date	2002.05.23.11.24.25;	author mibl;	state Exp;
branches;
next	;


desc
@First rev
@


1.93
log
@Modified handling of Apache Custom Combined.
@
text
@#!/usr/bin/perl
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.92 2007/12/03 15:38:40 mibl Exp $
$REVISION = '$Revision: 1.92 $';

# (C) Mike Blomgren 2001-02-21
# mibl@@a51.mine.nu
# 
# A Perl script to parse Webserver logfiles, and search for
# any security anomalies, and report them accordingly, thus SecSrch.
# The script is intended to be used offline, i.e. to sift through
# 'yesterdays' access.log in a cron job, or at will.
#
# Handles 'Common Log Format' (e.g. Weblogic), Standard IIS (IN??????.LOG),
# IIS Extended logfiles etc.
# It should be fairly simple to add other logformats (if you know Perl...)
# 
# This script comes with the standard disclaimers. I.e.
# there are no warranties or guaranties whatsoever.
# Use at your own risk, and if it causes problems - your loss.
# You are free to use the script for personal use. 
# 
# 
# 2000-12-15 Start: First attempt att writing a logfile parser...
# 2001-01-29 Added: Support for mulitiple .gz files with wildcards ex: secsrch.pl apwww1*.gz
# 2001-01-30 Added: Counter for # of unique IP's
# 2001-01-30 Added: Counter for # of status codes
# 2001-02-08 Cleaned: Cleaned out comments, and unnecessary 'testing' code.
# 2001-02-19 Released: 2.13 Initial public release.

# 2001-02-25 Added: Count of HTTP versions. Stripped " from URL.
# 2001-02-28 Added: Optional FQDN name resolution.
# 2001-03-02 Changed: Reports now contain headers, thus shorter lines
# 2001-04-16 2.20 Added: Hits/Hour - for a general 'feel' of the visitors hours.
# 2001-04-16 2.21 Added: Top HIT'ers.
# 2001-04-26 2.22 Added: Percent of total, to TOP HIT'ers
# 2001-05-10 2.23 Added: -N switch to not perform name resolution
# 2001-06-14 2.24 Bug: Handling of 'Succesful Downloads' had logic error.
# 2001-08-20 2.25 Added: $CRLF variable to accomodate for unix & DOS output format
# 2001-09-03 2.26 Added: Rank on 'Top HIT'ers' list
# 2002-05-22 2.27 Started rework for 'logger' function
# 2002-06-10 2.28 Added syslog logging of progress
#                 Added Cookie hijacking detection
# 2002-06-16 2.29 Added detection of URI Query manipulation attempts
# 2002-08-03 2.30 Various improvements
# 2003-03-18 2.31 Started working on long-time statistics gathering
# 2003-03-22 2.32 Also added XML output, but this is not finished in any way.
# 2003-04-03 2.33 Gave up on XML. This is really crossing the river for water.
# 2003-06-02 2.35 Added XML again... Maybe I can find it usefull after all...
# 2003-06-29 2.37 Added detection of  XSS scripting attmpts
# 2003-10-19 2.39 Added possibility to only dissplay entries in report where we
#                 actually found something - to make it shorter and 
#                 more relevant.
# 2004-12-04 2.40 Started adding support for GD::Graphing output
#                 Adding support for fortigate wlog.files for web usage stats.
# 2007-08-27 2.41 Started Adding support for FortiGate Log Files

# 
# To Do...:
# Add 'Bursty surfing detection' 
# Add 'Crawler detection'
# Improve parsing performance. 2000-4000 lines/second is not impressive...
#   and the parsing is what sucks all performance.
# Add XML modularized output for easy ASCII/HTML/whatever output
# Add Analysis based on time - WHEN do 5xx errors occur, etc? Related to a single time, or spread out during the day
# Add maximum hits per a single second (to locate possile resource starvation attempts)
# Look for any delays in traffic (log times without any hits) - To locate succesful DoS, or just 'down-times'
# Do Whois-lookup on IP-addresses in printed in report. (Whith GeekProxy maybe?)
# Add Automatic detection and split of logfiles which contain data from several webservers
# When listing logged in users, check at which times they are logged in.

$VERSION = '2.39';
   
$res = 'true';  # Set to true if we should attempt to resolve IP's to FQDN
#$res = 'false';

# Select Output-format (DOS or Unix - CRLF or CR)
#$CRLF = "\r\n";  # 0x0D 0x0A  (DOS-format)
$CRLF = "\n";  # 0x0A (Unix -format)
$iisext = 0;   #Boolean value for handling IIS Extended Logs.

# Required to handle compressed files. Remove if not needed...
use Compress::Zlib;
use Getopt::Std;
use Socket;   ## For dns resolver
use Archive::Zip qw ( :CONSTANTS );
#use Archive::Zip::Member;
use Benchmark;
use Time::HiRes;
$timing = 0;  # Used for debug purposes to find time-consuming operations

use URI::Escape;

use Sys::Syslog;                          # all except setlogsock, or:
use Sys::Syslog qw(:DEFAULT setlogsock);  # default set, plus setlogsock

# For graphing functions. Comment out if not needed
#use GD::Graph::bars;
#use GD::Graph::hbars;
#use GD::Graph::Data;

use XML::Writer;
use IO;

slog('Starting Exec');

getopts('i:o:PmWhvNpsXOC:M:I:L');  
# i <infile> - input files
# o <outputfile> - output file
# P - Generate detailed Debug Log (not implemented very well)
# m - Minimal output - only print headers where we have something to report
# W - being run as a CGI (Use <br>\n as $CRLF)
# h - only print help
# v - print version and exit
# N - don't do name lookups
# p - Print a descriptive text for each report section
# s - Only print stats (Not completely implemented)
# X - Use XML output for report
# O - Overwrite output file if it exists
# C <config> - CustomLog Configuration
# M # - Number of lines to read before exiting (used mostly for testing the app)
# I <uploadid> - Print progress for interactive download, to temp file
# L - Learn mode - print first line to see if we can parse it correctly


slog("CustomLog Opts: $opt_C");

if ($opt_W ne '') {
    $CRLF = "\<br\>\n";
}

# Print descriptions?
if ($opt_p ne '') { $pdesc = 1; } else { $pdesc = 0 }

if (defined $opt_I) {
    $uploadid = $opt_I;
    $statfile = "/var/tmp/$uploadid.log";
}

# Check which environment we're running in
if ($ENV{'OS'} =~ m/windows/i) {
    $os = 'win'; 		#Windows
    $osenv = 'OS';
}
elsif ($ENV{'OSTYPE'} =~ m/solaris/i) {
    $os = 'sol';		#Solaris
    $osenv = 'OSTYPE';
}
else {  
    $os = 'unknown';
}

#print "Assumed $os. Running under $ENV{"$osenv"}\n" ;


# Hash with Months - This is to map names to numbers.
# Needs to be altered if non-english... 
# (A 'use locale' procedure might work, but I haven't tried....)
%MONS = ( 'Jan' => '01', 'Feb' => '02', 'Mar' => '03', 
	  'Apr' => '04', 'May' => '05', 'Jun' => '06',
	  'Jul' => '07', 'Aug' => '08', 'Sep' => '09', 
	  'Oct' => '10', 'Nov' => '11', 'Dec' => '12');

# Hash with HTTP status Codes. Mostly for reference. Only the first word in 
# capital letters is actually printed in the results...
%STATCODE = ( '100' => 'CONTINUE', 
	      '101' => 'SWITCH_PROTOCOLS', 
	      '200' => 'OK', 
	      '201' => 'CREATED', 
	      '202' => 'ACCEPTED', 
	      '203' => 'PARTIAL', 
	      '204' => 'NO_CONTENT', 
	      '205' => 'RESET_CONTENT', 
	      '206' => 'PARTIAL_CONTENT', 
	      '300' => 'AMBIGUOUS', 
	      '301' => 'MOVED', 
	      '302' => 'REDIRECT', 
	      '303' => 'REDIRECT_METHOD', 
	      '304' => 'NOT_MODIFIED', 
	      '305' => 'USE_PROXY',
	      '307' => 'REDIRECT_KEEP_VERB', 
	      '400' => 'BAD_REQUEST', 
	      '401' => 'DENIED', 
	      '402' => 'PAYMENT_REQ', 
	      '403' => 'FORBIDDEN', 
	      '404' => 'NOT_FOUND', 
	      '405' => 'BAD_METHOD', 
	      '406' => 'NONE_ACCEPTABLE', 
	      '407' => 'PROXY_AUTH_REQ', 
	      '408' => 'REQUEST_TIMEOUT',
	      '409' => 'CONFLICT', 
	      '410' => 'GONE', 
	      '411' => 'LENGTH_REQUIRED', 
	      '412' => 'PRECOND_FAILED',
	      '413' => 'REQUEST_TOO_LARGE', 
	      '414' => 'URI_TOO_LONG', 
	      '415' => 'UNSUPPORTED_MEDIA', 
	      '416' => 'NOT SATISFIABLE',
	      '417' => 'EXPECTATION FAILED',
	      '449' => 'RETRY_WITH', 
	      '500' => 'SERVER_ERROR', 
	      '501' => 'NOT_SUPPORTED', 
	      '502' => 'BAD_GATEWAY',
	      '503' => 'SERVICE_UNAVAILABLE', 
	      '504' => 'GATEWAY_TIMEOUT', 
	      '505' => 'VERSION_NOT_SUPPORTED');

$URL_MAX = 400;       # Max length of URLs to warn of if exceeding this length
$SITE = 'http://a51.mine.nu/';
$SITE_DIR = '';

$mindate = '';
$maxdate = '';

$starttime = time;
$starttimetext = localtime;

if (defined $opt_i) {
    $infile = $opt_i;
} else {
    $infile = $ARGV[0];
}
#print STDERR "got $infile\n";
if (sanitize($infile) ne 0) { die "Invalid characters found in filename. The error is logged.\n";}
#print STDERR "got infile\n";
if (defined $opt_o) {
    $outfile = $opt_o;
} else {   
    $outfile = $ARGV[1];
}
if (sanitize($outfile) ne 0) { die "Invalid charcaters found in filename. The errror is logged.\n"; }

$statsfile = '/tmp/stats.log';
$statsfile = '&STDOUT';
#print STDERR "got statsfile\n";
$topmax = 20;		# How many 'TOP HIT'ers' to display

# Check if we want help....
if ($opt_h eq 1) {
    print <<END_HELP;
SecSrch version $VERSION$CRLF
Analyses Web log files from a security perspective.$CRLF
Useage: [cat\|type] \<infile\> \| [perl] secsrch.pl \- [outfile]
or      [perl] secsrch.pl [options] -i <infile> [-o outfile]
or      [perl] secsrch.pl [options] -i \'<infile\*.gz>\' [-o outfile]
or      [perl] secsrch.pl [options] -i \'<infile\*.gz>\' [-o outdir]
Options:
 -i <input file(s)>. Must be quoted when using wildcards! I.e. 'ex*.log'
 -N Name resolution will not be performed.
 -  for <infile>, STDIN will be used for input.
 -  for <outfile>, STDOUT will be used for output.
 -s Only print summarized Statistics
 -X Print XML-output
 -o Overwrite any existsing outfile (default is not to overwrite).
 -C <Config String>  Use the supplied CustomLog directive to parse the logfile
 -W Run as cgi and terminate each line with <br\> instead if \\n.
 -p Print descriptive text for each report heading.
 -m Minimal output. Only print things we found to make report shorter.
 -h Print this help...
 -v Print version and exit.


END_HELP


    exit;
}

#Check for version info
if ($opt_v eq 1) {	
    print "$CRLFSecSrch by Mike Blomgren, v$VERSION$CRLF";	
    exit; 
}


# Which files do we open?....
#print STDERR "opening infiles\n";
if ($infile eq '-') {
    @@list = '-';
    if (($outfile eq '') || ($outfile eq '-'))
    {	
	$outfile = '&STDOUT';	
    }
    # Else outfile = outfile...
} else {
    @@list = glob $infile;   # Did we specify wildcard
    
    if (join( '', @@list) eq "") {
	slog("No Files found matching $infile.$CRLF");
	die "No Files found matching $infile.$CRLF";
    }
    $list[0] =~ m/[\/\\]*?([\d\.\w\-\_]+)$/;
    # If '-' specified as outfile, then open STDOUT
    if ($outfile eq '-') {
	$outfile = '&STDOUT';
    }
    elsif ($list[1] ne '')
    {	# If more than one file is being analyzed - use a different output filename,
	# to indicate that multiple files have been analyzed into one result file.		
	if ( -d $outfile) {
	    $outfile = $outfile . '/SLAC.Multi.' . $1 . '.txt';
	} else {
	    if ($outfile eq '') {	
		$outfile = 'SLAC.Multi.' . $1 . '.txt';
	    }
	}	
    }
    else
    {	# If only one infile, use 'standard' output filename.
	if ($outfile eq '')
	{
	    $outfile = 'SLAC.' . $1 . '.txt';
	}
	if ( -d $outfile ) 
	{
	    $outfile = $outfile . '/SLAC.' . $1 . '.txt';
	}
	# Else $outfile = $outfile...
    }
    
}

slog("Infile: $infile");
slog("Outfile: $outfile");

if ((-f $outfile) && !($opt_O))
{
    print STDERR "File \'$outfile\' already exists. Exiting.$CRLF$CRLF";
    slog("File \'$outfile\' already exists. Exiting.");
    exit ;
}

open (OUT , ">$outfile") || die "Can't open $outfile for output\.";
#open (STATS, ">$statsfile") || die "Can't open $statsfile for output\.";
#print "Infile(s): " . join (" $CRLF",@@list) . " $CRLFOutfile: $outfile $CRLF";
	
foreach $file (@@list)
{ 
    slog("Starting with: $file");
    if ($file =~ m/\.gz$/)
    {
	slog('Compressed .gz file detected');
	$gz = gzopen($file, "rb") or die "Cannot open $file: $gzerrno$CRLF" ;
	while ($gz->gzreadline($buffer) > 0)
	{
	    $_ = $buffer;
	    #print STDERR "$_";
	    # Can we parse the current line? 
	    if (splitline() != -1) {
		if (defined $opt_L) {
		    printheaders();
		    exit;
		}
		# Yepp, then make statistics...
		makestats();
		last unless ($maxreached ne 1);
	    }
	}
	die "Error reading from $file: $gzerrno$CRLF" if (($gzerrno != Z_STREAM_END) && ($maxreached ne 1));
	$gz->gzclose() ;
    } 
    #elsif ($file =~ m/\.zip$/) {
    #slog("Zip File");
    #$zip = Archive::Zip->new();
    #die 'read error' unless $zip->read($file) == AZ_OK;
    #my @@member = $zip->memberNames();
    #print $zip->numberOfMembers();
    ##print $zip->memberNames;
    #foreach $x (@@member) {
    #    print "$x\n";
    #    $zip->extractMember($x, '/tmp/' . $x);
    
    # Open and start reading extracted file
    #    open (IN, "</tmp/$x") || die "Can't open $file for input.$CRLF";
    #    while (<IN>)
    #    {
    #	# Can we parse the current line?
    #	if (splitline() != -1) {
    #	    if (($date le $mindate) || ($mindate eq '')) {$mindate = $date};
    #	    if (($date gt $maxdate) || ($maxdate eq '')) {$maxdate = $date};
    #	    # Yepp, then make statistics...
    #	    makestats();
    #	}
    #    }
    #    close IN;
    #} 
    #}
    else {
	if ($file eq '-') {$infile = '&STDIN'};
	open (IN, "<$file") || die "Can't open $file for input.$CRLF"; 
	#Start reading file
	while (<IN>) 
	{		
	    # Can we parse the current line? 
	    if (splitline() != -1) {
		if (defined $opt_L) {
		    printheaders();
		    exit;
		}
		#if (m/getting/) {print "problems: $_"; exit;}
		if (($date le $mindate) || ($mindate eq '')) {$mindate = $date};
		if (($date gt $maxdate) || ($maxdate eq '')) {$maxdate = $date};
		# Yepp, then make statistics...
		makestats();
		last unless ($maxreached ne 1);
		#print "returned\n";
	    }
	}	
	close IN;
    }	
}

if ($opt_s) {
    printstats();
} else {
    if ($opt_X) {
	printxml();
    } else {
	printall();
    }
}

if (defined $opt_I) {
    pstatus($filename,0,"Analysis completed.");
}

slog('Exiting...');
exit 0;


sub splitline {
    $numlines++;
    if (($numlines % 10000) eq 0){
        slog("Completed: Pass $pass, $numlines lines.");
        if (defined $opt_P) {
            plog(localtime() . " Completed: Pass $pass, $numlines lines.\n");
	    print STDERR localtime() . " Completed: Pass $pass, $numlines lines.\n";
        }
	if (defined $opt_I) {
	    pstatus($filename, 0, "Analysis progress - Lines read: $numlines"); 
	    
	}
    }

    if ((defined $opt_M) && ($opt_M < $numlines)) {
        if (! defined $maxreached) {
            plog("Max lines ($opt_M) reached. Starting printout.\n");
            $maxreached = 1;
            return;
        }
        return;
    }


    #print "$timing\n";
    undef $serverip, $ip, $status, $date, $referer, $cookie, $uri, $url, $user, $httpver, $servername;
    if ($timing == 1) {
	my $t0 = new Benchmark;
	print "$t0\n";
    }
	
    # Split Logfile line into values.
    

    # Is the LogFormat specified as an input parameter?
    if (defined $opt_C ) {
	@@header = split /\s+/,$opt_C;
	foreach $c (@@header) { 
	    $p++; 
	    @@HASH{$c}=$p;
	    #print "Hash: $HASH{$c}: $c\n";
	}
	foreach $x (keys %HASH) {
	    #print "$x $HASH{$x}\n";
	}
	$opt_C = lc($opt_C);
	
	#print "Match: $_\n";
	$format = $opt_C;
	$format =~ s/%h/([\\d\\.]+)\\s?\n/g;  # $ip
	$format =~ s/%l/([\\w\\d\\-\\.]+)\\s?\n/g; # Remote logname (unused)
	$format =~ s/%u/([\\w\\d\\-\\.]+)\\s?\n/g;  # Logged in user
	$format =~ s/%t/(\\[\.+\\])\\s?\n/g;
	$format =~ s/\\"%r\\"/(\\"\.+?\\")\\s?\n/g;
	$format =~ s/%\>s/(\\d+)\\s?\n/g;
	$format =~ s/%b/(\.+)\\s?\n/g;
	$format =~ s/\\"%{user-agent}i\\"/\\"(\.+?)\\"\\s\n/gi;
	#print "\$format: $format\n";
	
	$match = $_ =~ m/$format/x;
	#print "Matches: $match\n";
	if ($match lt 1) {
	    slog("Error. Custom Log Optoins doesnt match Log File");
	    print "$_\n";
	    print "Format: $format\n";
	    die "Custom Log Options dont match log file";

	}

	#print "\$1: $1\n\$2: $2\n\$3: $3\n\$4: $4\n\$5: $5\n\$6: $6\n\$7: $7\n\$8: $8\n";
	$F{'1'} = $1;	$F{'2'} = $2;	$F{'3'} = $3; 	$F{'4'} = $4;
	$F{'5'} = $5;	$F{'6'} = $6;	$F{'7'} = $7;	$F{'8'} = $8;
	$F{'9'} = $9;	$F{'10'} = $10;	$F{'11'} = $11;	$F{'12'} = $12;
	$F{'13'} = $13;
	$user = $F{$HASH{'%u'}};
	$ip = $F{$HASH{'%h'}};
	$serverip = $F{$HASH{'%A'}};
	$date = $F{$HASH{'%t'}};
	if ($date =~ m/\[(\d+)\/(\w+)\/(\d+)\:([\d\:]+)/g) {
	    $date = "$3-$MONS{$2}-$1 $4";
	}
		       #[05/Sep/2004:00:00:01 +0200] 
	$status = $F{$HASH{'%>s'}};
	$len = $F{$HASH{'%b'}};
	$browser = $F{$HASH{'\"%{user-agent}i\"'}};
	
	$url = $F{$HASH{'\"%r\"'}};
	$url =~ m/\"([\w]+)\s(.+)\s(.+)\"/g;
	$method = $1;
	$url = $2;
	$httpver = $3;
	if (defined $opt_L) {
	    printheaders();
	    exit;
	}
	#print $user, $ip;
	
    }
	
    
    # Check for lines with comments
    if (m/^\s*?\#/) {
	#$badlines++;
	#$logformat{'Ignored'}++;
	if (m/^\s*\#Fields\:\s(.*)/) {
	    $logformat{'Field definitions'}++;
            @@header = split(/\s/, $1);
            #print join("\n",@@header);
            $iisext = 1;   # If we see a #Field line, we assume the whole file
	                   # is IIS Extended format. And set that assumption here.
        }
	else
	{
	    $logformat{'Ignored Comments'}++;
	}
	if (m/^\#Date\: (\d\d\d\d\-\d\d\-\d\d)\s(\d\d\:\d\d:\d\d)/) {
	    $exdate = $1;
	    #print "Assuming IIS EX file: $1 - $2$CRLF";
	}
	return -1;
    }

    if ($iisext eq 1) {
	#if (m/getting/) {print; print "problems"; exit;}
	$logformat{'MS-IIS Extended'}++;
	# Check for the pesky NULL lines in IIS log files
	if ((tr/\x00//)) { return -1};
	undef %HASH;
	@@fields = split /\s/;
	#print join("\n",@@fields);
	#if (m/getting/) {
	#    print; 
	#    print "problems"; 
	#    print join("\n",@@fields);
	#    exit;
	#}
	$c = 0;
	foreach $x (@@header) {
	    #print "$x $fields[$c]\n";
	    @@HASH{$x} = $fields[$c];
	    $c++;
	}
	$ip = $HASH{'c-ip'};
	# Sanity Check
	if (not $ip =~ m/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/) {
	    #print "no match\n";
	    return -1;
	}
	$url = $HASH{'cs-method'} . ' ' . $HASH{'cs-uri-stem'};
	$method = $HASH{'cs-method'};
	#if ($method eq '-') {print "Illegal: $_\n"}
	$query = $HASH{'cs-uri-query'};
	#print "IIS Q: $query\n";
	$user = $HASH{'cs-username'} unless not defined $HASH{'cs-username'};
	$sitename = $HASH{'s-sitename'};
	$serverip = $HASH{'s-ip'};
	if ( (not $serverip =~ m/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)) {
            #print "no match\n";
            return -1;
        }
 
	$cname = $HASH{'s-computername'};
	$date = $HASH{'date'} . ' ' . $HASH{'time'};
	#if ($date =~ m/get/) {
	#    print;
	#}
	$httpver = $HASH{'cs-version'} unless not defined $HASH{'cs-version'}; 
	#print STDERR $httpver;
	$status = $HASH{'sc-status'};
	$referer = $HASH{'cs(Referer)'} unless not defined $HASH{'cs(Referer)'};
	$cookie = $HASH{'cs(Cookie)'} unless not defined $HASH{'cs(Cookie)'};
	$browser = $HASH{'cs(User-Agent)'};
	$len = $HASH{'sc-bytes'} + $HASH{'cs-bytes'};

	# Modi by MB 030416:
	#$date =~ m/(\d\d\d\d)\-(\d\d)\-(\d\d)\s(\d\d)\:(\d\d)\:(\d\d)/;
	#$day = $3; $mon = $2; $yr = $1; $hr = $4; $mi = $5; $se = $6;
	if ($date =~ m/(\d\d\d\d)\-(\d\d)\-(\d\d)\s(\d\d)\:(\d\d)\:(\d\d)/) {
	    $day = $3; $mon = $2; $yr = $1; $hr = $4; $mi = $5; $se = $6;
	}

	#print "$HASH{'time'}\n";
	$uri = $url . '?' . $query;
	#if ($timing == 1) {
	#    my $t1 = new Benchmark;
	#    print "Splitline: ".timestr(timediff($t1,$t0));
	#}
	return;
    } 
    else {
	
    # Common Log Format (Weblogic, Apache etc)
	if ( m/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # IP Address
	     \s([\w\d\-]+?)                        # User
	     \s([\-]+?)                        # unused
	     \s(\[.+\])                     # Date
	     \s\"(.+?)\"                    # Url
	     # Match regardless of HTTP Version.
	     \s(\d+?)                       # Statuscodes
	     \s([\-\d]+?)                   # Size
	     \s(?:\"(.*?)\")?                    # Optional Referer
	     (?:\s\"(.*?)\")?                    # Optional Browser type
	     (?:\s\"(.*?)\")?               # Optional Cookie
	     /iox )                    
	{
	    
	    $logformat{'Common Log Format'}++;
	    $ip = $1; $na1 = $2; $user=$3; $date = $4;
	    $url = $5; 
	    $status = $6; $len = $7;
	    #print "DBG: $url\n";
	    #$query = $6;
	    #$httpver = $7;
	    $referer = $8; $browser = $9; $cookie = $10;
	    $uri = $url . '?' . $query;
	    #print "$httpver\n";
	    if ($url =~ m/([\w\d]+)\s(.*)\s(.*)/iox) {
		$method = $1;
		$url = $2;
		$httpver = $3;
		#print "M: $method\nU:$url\n";
	    }
	    if ($url =~ m/(.*)\?(.*)/) {
		$query = $2;
		#print "Q: $query";
	    }

	    if ( $date =~ m/^\[(\d{1,2})
		 \/(.{3})
		 \/(\d\d\d\d)
		 \:(\d+?)
		 \:(\d+?)
		 \:(\d+?)
		 \x20(.+?)\]/ox)
	    {
		$day = $1; $mon = $2; $yr = $3; $hr = $4; $mi = $5; $se = $6;
		$date = "$yr\-$MONS{$mon}\-$day $hr:$mi:$se";
		$epochtime = "";
	    }
	    return 1;
	}

	elsif ( m/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # Client IP 
	    \s(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})     #Srv IP
	    \s([\-]+?)                        # Unused
            \s(.+?)                        # User
            \s(\[.+\])                     # Date
            \s\"(.*)\"               # Url
	    # (?:(\?.*\s))?
            # (?:(.*?)\")?                 # Match regardless of HTTP Version.
            \s([\d\-]+?)                       # Statuscodes
            \s([\-\d]+?)                   # Size
	    \s(.*?)                         # Unused...
            \s\"(.*?)\"                    # Optional Referer
            \s\"(.*?)\"                    # Optinal Browser type
            \s\"(.*?)\"               # Optional Cookie
            /iox )
        {
	    $logformat{'Apache Custom Combined'}++;
	    $ip = $1;
	    $serverip = $2;
	    $user = $4;
	    $date = $5; 
            $url = $6; $status = $7; $len = $8; $referer = $10;
	    $browser = $11; $cookie = $12;
	    #print "$cookie\n";
            #print "$6";
            if ($url =~ m/([\w\d]+)\s(.*)\s(.*)/iox) {
                $method = $1;
                $url = $2;
                $httpver = $3;
                #print "M: $method\nU:$url\n";
            }
            if ($url =~ m/(.*)\?(.*)/) {
                $query = $2;
                #print "Q: $query";
            }

            if ( $date =~ m/^\[(\d{1,2})
                 \/(.{3})
                 \/(\d\d\d\d)
                 \:(\d+?)
                 \:(\d+?)
                 \:(\d+?)
                 \x20(.+?)\]/ox)
            {
                $day = $1; $mon = $2; $yr = $3; $hr = $4; $mi = $5; $se = $6;
                $date = "$yr\-$MONS{$mon}\-$day $hr:$mi:$se";
                $epochtime = "";
            }
	    return 1;
	}

	elsif ( m/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # Client IP 
	    \s(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})     #Srv IP
	    \s([\w\d\.]+)    # Sitename
	    \s([\-]+?)                        # Unused
            \s(.+?)                        # User
            \s(\[.+\])                     # Date
            \s\"(.*)\"               # Url
	    # (?:(\?.*\s))?
            # (?:(.*?)\")?                 # Match regardless of HTTP Version.
            \s([\d\-]+?)                       # Statuscodes
            \s([\-\d]+?)                   # Size
	    \s(.*?)                         # Unused...
            \s\"(.*?)\"                    # Optional Referer
            \s\"(.*?)\"                    # Optinal Browser type
            \s\"(.*?)\"               # Optional Cookie
            /iox )
        {
	    $logformat{'Apache Custom Mikes Combined'}++;
	    $ip = $1;
	    $serverip = $2;
	    $sitename = $3;
	    $user = $5;
	    $date = $6; 
            $url = $7; $status = $8; $len = $9; $referer = $11;
	    $browser = $12; $cookie = $13;
	    #print "$cookie\n";
            #print "$6";
            if ($url =~ m/([\w\d]+)\s(.*)\s(.*)/iox) {
                $method = $1;
                $url = $2;
                $httpver = $3;
                #print "M: $method\nU:$url\n";
            }
            if ($url =~ m/(.*)\?(.*)/) {
                $query = $2;
                #print "Q: $query";
            }

            if ( $date =~ m/^\[(\d{1,2})
                 \/(.{3})
                 \/(\d\d\d\d)
                 \:(\d+?)
                 \:(\d+?)
                 \:(\d+?)
                 \x20(.+?)\]/ox)
            {
                $day = $1; $mon = $2; $yr = $3; $hr = $4; $mi = $5; $se = $6;
                $date = "$yr\-$MONS{$mon}\-$day $hr:$mi:$se";
                $epochtime = "";
            }
	    return 1;
	}
	
	#IIS Logs Standard Logs (INxxxxxx.log)
	elsif (m/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})
	       \,\s*(.+?)
	       \,\s(\d{2,4}).(\d{1,2}).(\d{1,2})
	       \,\s(\d+):(\d\d:\d\d)
	       \,\s([\w\d]+?)
	       \,\s(\w+?)
	       \,\s(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})
	       \,\s(\d+?)
	       \,\s(\d+?)
	       \,\s(\d+?)
	       \,\s(\d+?)
	       \,\s(\d+?)
	       #\,\s(\w+?)
	       \,\s(.+?) 
	       \,\s(.+?)
	       \,.*/ox)
	{
	    $logformat{'IIS Standard'}++;
	    $hr = sprintf("%02d", $6);
	    $ip = $1; $user=$2; $date = "$3-$4-$5 $hr:$7" ;
	    #print "D $date\n";
	    $url = $16 . ' ' . $17; $status = $14; $len = $10;
	    $method = $16;
	    undef $httpver;
	    return 1;

	} 

	elsif ( m/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # Client IP
		\s(.+?)         # Virtual Server
            \s(.+?)                        # Unused
            \s(\[.+\])                     # Date
            \s\"(.*)\"               # Url
            \s([\d\-]+?)                       # Statuscodes
            \s([\-\d]+?)                   # Size
            \s\"(.*?)\"                    # Optional Referer
            \s\"(.*?)\"                    # Optinal Browser type
            /iox )
        {
            $logformat{'Domino Extended'}++;
            $ip = $1;
            $serverip = $2;
            $user = $3;
            $date = $4;
            $url = $5; $status = $6; $len = $7; $referer = $8;
            $browser = $9; #$cookie = $12;
            #print "$cookie\n";
            #print "$6";
            if ($url =~ m/([\w\d]+)\s(.*?)\s(.*)/iox) {
                $method = $1;
                $url = $2;
                $httpver = $3;
                #print "M: $method\nU:$url\n";
            }
            if ($url =~ m/(.*)\?(.*)/) {
                $query = $2;
                #print "Q: $query";
            }

	    if ( $date =~ m/^\[(\d{1,2})
                 \/(.{3})
                 \/(\d\d\d\d)
                 \:(\d+?)
                 \:(\d+?)
                 \:(\d+?)
                 \x20(.+?)\]/ox)
            {
                $day = $1; $mon = $2; $yr = $3; $hr = $4; $mi = $5; $se = $6;
                $date = "$yr\-$MONS{$mon}\-$day $hr:$mi:$se";
                $epochtime = "";
            }


	} 
	elsif ( m/([\d\n\w\-\.]+)   # Client hostname
            \s([\-]+?)                        # Unused
            \s([\-]+?)                        # Unused
            #\s(.+?)                        # User
            \s(\[.+\])                     # Date
            \s\"(.*)\"               # Url
            # (?:(\?.*\s))?
            (?:(.*?)\")?                 # Match regardless of HTTP Version.
            \s([\d\-]+?)                       # Statuscodes
            \s([\-\d]+?)                   # Size
            #\s(.*?)                         # Unused...
            \s\"(.*?)\"                    # Optional Referer
            \s\"(.*?)\"                    # Optional Browser type
            #\s\"(.*?)\"               # Optional Cookie
            /iox )
        {
            $logformat{'Apache Custom Combined 2'}++;
	    $ip = $1;
	    #$serverip = $2;
	    #$sitename = $3;
	    #$user = $5;
	    $date = $4; 
            $url = $5; $status = $7; $len = $9; $referer = $9;
	    $browser = $10; $cookie = $13;
	    #print "$cookie\n";
            #print "$6";
            if ($url =~ m/([\w\d]+)\s(.*)\s(.*)/iox) {
                $method = $1;
                $url = $2;
                $httpver = $3;
                #print "M: $method\nU:$url\n";
            }
            if ($url =~ m/(.*)\?(.*)/) {
                $query = $2;
                #print "Q: $query";
            }

            if ( $date =~ m/^\[(\d{1,2})
                 \/(.{3})
                 \/(\d\d\d\d)
                 \:(\d+?)
                 \:(\d+?)
                 \:(\d+?)
                 \x20(.+?)\]/ox)
            {
                $day = $1; $mon = $2; $yr = $3; $hr = $4; $mi = $5; $se = $6;
                $date = "$yr\-$MONS{$mon}\-$day $hr:$mi:$se";
                $epochtime = "";
            }
	    return 1;
	    
	}
	
	# No Match...

	else 
	{
	    print "Unable to parse logline: $_\n";
	    $logformat{'Unknown'}++;
	    $badlines++;
	}
    }
    #if ($timing == 1) {
#	my $t1 = new Benchmark;
#	print "Splitline: ".timestr(timediff($t1,$t0));
#	
#    }
	    
}

sub makestats {
    # Start collecting stats on the parsed logfile entries

    # Check for Exceedingly Long URL's before doing more statistics
    if ((length $url) > $URL_MAX ) {
	$lenu = length($url);
        $url = substr($url, 0, 15) . ' [ Truncated ] ' . substr($url, length($url)-15,15);
        $s18{"$url¤$ip¤$lenu¤$status"}++;
    }
    
    
    # Look for 'File not found' or 'Forbidden' messages, but filter 
    # out the obvious 404 generators...
    if (($status =~ m/404|403|406|400/))
	#&& (not $url =~ m/favicon|GET.\/images|\/img\/meny/ix))
    {
	$s0{"$ip¤$url"}++;
	$s01{"$status¤$url"}++;
	$s02{"$ip"}++;
	# Why do we resolve the ip-address here??? /Mike
	if ($sip{$ip} eq undef) {	
	    $sip{$ip} = resolve($ip);
	}
    }
    
    # Logged In Users
    if (defined $user) {
	#print "$user\n";
	if (($user ne '-') and ($user ne 'N/A'))
	{
	    $s1{"$user¤$ip"}++;
	    # Why do we resolve the ip-address here??? /Mike
	    if ($sip{$ip} eq undef) {	$sip{$ip} = resolve($ip) };
	}
	$s10{"$user"}++;
	#print "$user: $s10{$user}\n";
    } else {
	$userundef++;
    }
    
    # Unauthorized messages
    if ($status eq '401')
    {
	$s2{"$status¤$ip¤$url¤$user"}++;
    }
    
    # Look for 'dangerous' files successfully downloaded to the client
    # This needs to be modified depending on what system you'r running (unix/VMS/Windows/whatever)
    if ($status eq '200') {
	if ($url =~ m/passwd|\/etc\/shadow|nc.exe|cmd1\.exe|ncx\.exe|inetd|\/services|access\.log|cmd\.exe|\.\%..\%..|\.url|\.bat/ix) {
	    $s3{"$ip¤$url"}++;
	}
    }
    
    # Show URL's which have generated a 5xx error
    if ($status =~ m/^5/)
    {
	$s4{"$status¤$url"}++;
	$s41{"$status¤$url¤$ip"}++;
	$s42{"$status¤$ip"}++;
	if ($sip{$ip} eq undef) { $sip{$ip} = resolve($ip) };
	$s43{"$date¤$ip"}++;
	#print "$date $ip\n";
    }

    # Look for URL's containing non printable characters
    if ($url =~ m/[\x00-\x1f]|[\x7f-\xff]/) 
    {
	#print "$url\n";
	$s45{"$ip\#\#$url"}++;
    }
    
    #Count number of unique IP's, and HITS per IP
    if ($iptab{$ip} eq undef)
    { 
	$numip++;
    }

    # Count hits per IP
    $iptab{$ip}++;
    
    # Count number of statuscodes
    $s5{"$status"}++; 
    
    # Count number of HTTP Versions
    if (defined $httpver) {
	$s6{$httpver}++;
	#print STDERR "H:$httpver  Q:$query\n";
    } else {
	$httpverundef++;
    }
    
    # List requests with illegal or missing http version fields. 
    #if ((not $httpver =~ m/^HTTP\/\d\.\d$|N\/A/i) && (defined $httpver))
    if ((not $httpver =~ m/^HTTP\/1.0$|^HTTP\/1.1$|N\/A/i) && (defined $httpver))
    {
	$s61{"$httpver¤$ip"}++;
    }
    
    # Get Hits per hour
    $s7{$hr}++;
    if ($s7{$hr} > $hrmax) {$hrmax = $s7{$hr}}

    # Look at Referers
    if (defined $referer) {
	unless ($referer =~ m/^\s*$/) { $s11{$referer}++;};
	if ($referer eq '-') {
	    $s131{"$ip¤$url"}++;
	}
    } else {
	$refererundef++;
    }

    # Count Browser versions
    unless ($browser =~ m/^\s*$/) {$s12{$browser}++;}

    # Check for Cookie Manipulation  - i.e. same cookie from different IP's
    if (defined $cookie) {
	if (($cookie ne '-') && ($cookie ne '')) {
	    #print "Cookie: $cookie   - IP: $ip\n";
	    if (defined $s13{$cookie}) {
		if (($s13{$cookie} ne $ip) && (! defined $s14{"$cookie¤$ip"})){
		    #print "Cookie: $cookie \n Old IP: $s13{$cookie} New IP: $ip\n";
		    #Then we have problems...
		    
		    #$s14{"$cookie"}++;
		    $s14{"$cookie¤$ip"}++;
		    $s14{"$cookie¤$s13{$cookie}"}++;
		} 
		
	    } else {
		#    #print "CIP: $ip\n";
		$s13{$cookie} = $ip;
		#$s14{"$cookie¤$ip"}++;
		#$s14{"$cookie¤$ip"}++;
		#print "CIP: $cookie = $ip\n";    
		#}
	    }
	}
    } else {
	$cookieundef++;
    }
    
    # Check for unsuccessfull attempts to List directories
    #print "$url\n";
    if (($url =~ m/\/$/) && ($status ne '200') && ($status ne '304') && ($status ne '302')) {
	#print "URL $url $status\n";
	$s15{"$ip¤$url¤$status"}++;
	$s151{"$ip"}++;
    }
    
    # Check for attempts to manipulate form data. 
    # For example 'SELECT' in the Query, or other 'abnormal' characters
    if ($query =~ m/select|\'|\"|\;|javascript|\>|\</gi) {
	$s16{"$ip¤$query"}++;
    }

    # Check for Anonymous Proxy Scanning, i.e. URL starts with 'HTTP...' or  
    # uses CONNECT method
    #if ($_ =~ m/connect/i ) {print $url};
    if (($url =~ m/^[\w]+?\s+HTTP[s]*\:/i) || ($method =~ m/^connect/i)) {
	#print $url;
	$s17{"$ip¤$status¤$method $url"}++;
    }

    # List HTTP Methods found
    if ($method ne '') {
	$s19{$method}++;
    }

    # Check if Several Servers listed
    if (! defined $serverip) { $serverip = '<No Name>' };
    $s20{"$serverip $sitename"}++;

    # Chech if url contains <SCRIPT > tag for XSS attempts
    if ($url =~ m/\<script/ig) {
	$s21{"$ip¤$url"}++;
    }

    #print "stats done\n";
}


sub printall {

    # Check if results are OK, before mailing report
    if ($numlines eq $logformat{'Unknown'}) {
	exit 99;
    }
    slog('Printing text output');
    if ($opt_W) {print OUT "<table border=\"1\"><tr><td colspan=\"2\">\n";}
    print OUT "Security Log File Analysis$CRLF";
    if ($opt_W) {print OUT "</td></tr><tr><td colspan=\"2\">\n";}
    print OUT "SLAC v $VERSION $REVISION  $SITE$SITE_DIR $CRLF$CRLF";
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    print OUT "Inputfile(s): ";
    if ($opt_W) {print OUT "</td><td>\n";}
    print OUT  join (" ",@@list). "$CRLF";
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    #print OUT "Outputfile: $outfile $CRLF";
    print OUT "Log Start: ";
    if ($opt_W) {print OUT "</td><td>\n";}
    print OUT "$mindate$CRLF";
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    print OUT "Log Stopp: ";
    if ($opt_W) {print OUT "</td><td>\n";}
    print OUT "$maxdate$CRLF";
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    #print OUT "Execution started: " . $starttimetext . "$CRLF";
    #print OUT "Execution stopped: " . localtime() . "$CRLF";
    printf OUT "nr of analyzed rows: ";
    if ($opt_W) {print OUT "</td><td>\n";}
    printf OUT "%7d $CRLF", $numlines;
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    #printf OUT "nr of non-analyzed rows:    %7d $CRLF", $logformat{'UNKNOWN'};

    printf OUT "nr of unique IP-addresses: ";
    if ($opt_W) {print OUT "</td><td>\n";}
    printf OUT "%7d $CRLF", $numip;
    if ($opt_W) {print OUT "</td></tr><tr><td colspan=\"2\">\n";}
    print OUT "Rows identified as:$CRLF";
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    foreach $x (keys %logformat) {
	if ($opt_W) {print OUT "<div>\n";}
	printf OUT " %-24s %9d$CRLF", $x, $logformat{$x};
	if ($opt_W) {print OUT "</div>\n";}
    }
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    slog("Nr of Analyzed rows: $numlines");
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    slog("Rows/sec: " . $numlines / (time - $starttime + 1));
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    #printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);
    #printf OUT "nr of $logformat{'CLF'}\n";
    if ($opt_W) {print OUT "</td></tr><tr><td>\n";}
    if ($opt_N ne '') 
    {  print OUT "Name Resolution has NOT been performed.$CRLF$CRLF"; }
    #else
    #{  print OUT "Name Resolution has been performed.$CRLF$CRLF"; }

    sumhash (\%s20);
    if ($sum gt 0) {
	print OUT "Servers analyzed ($uniq):                Rows$CRLF";
	foreach $x (sort keys %s20 ) {
	    printf OUT "  %-30s %9d$CRLF", $x, $s20{$x};
	}
    }
    if ($opt_W) {print OUT "</td></tr><tr></tr>\n";}
    if ($opt_W) {print OUT "</table>\n";}

    
    # Show number of hits/hour
    print OUT "$CRLF********** Hits / hour ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "This shows the number of Hits per hour. Any sudden drops or increases in traffic can be due to web pounders stealing bandwidth, or an effective Denial of Service.";
	print OUT "$desctxt$CRLF";
    }

    sumhash (\%s7);
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
    #foreach $k (sort keys %s7)
    for ($k=0;$k<24;$k++)
    {
	@@_ = split "¤", $k;
	$hits = $s7{sprintf("%02d", $k)};
	if ($hits eq '') { $hits = '0'};
	printf (OUT "%7d  %9s  %-50s$CRLF",  $_[0], $hits, "*" x ($hits / ($hrmax+1) * 40));
    }
    

    # Dangerous files...
    sumhash(\%s3);
    if (($uniq eq 0) && (!defined $opt_m)) {
	print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This could indicate successful attempts to retrieve sensitive files, or possibly execute system commands in the server.";
	    print OUT "$desctxt$CRLF";
	}

    #sumhash (\%s3);
	if ($uniq gt 0) {
	    print OUT "This could inidicate a serious security breach.$CRLF";
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
	    foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
	    {
		@@_ = split "¤", $k;
		printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k},$_[0], $_[1]);
	    }
	} else {
	    printf OUT "None. $CRLF";
	}
    }
    
    # Unauthorized
    sumhash(\%s2);
    if (($uniq eq 0) && (!defined $opt_m)) {
	print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This shows all users who have accessed password protected pages. Users whi repeatedly access the same page could indicate password brute force attempts.";  
	    printf OUT "$desctxt\n";
	}
	#sumhash (\%s2);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT  "%7s  %5s  %-15s  %-9s %s$CRLF", 'Count', 'Status', 'Src IP', 'User', 'URL';
	    foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
	    {
		@@_ = split "¤", $k;
		printf(OUT  "%7d  %5s   %-15s  %-9s %s$CRLF",  $s2{$k},$_[0], $_[1], $_[3], $_[2]);
	    }
	} else {
	    printf OUT "None. $CRLF";
	}
    }


    sumhash (\%s10);
    if (($uniq gt 0)) {    
	print OUT "$CRLF********** Logged in Users **********$CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "Lists all users who have successfully logged in. Verify that the users are valid.";
	    printf OUT "$desctxt\n";
	}
	
	#sumhash (\%s10);
	if ($uniq gt 0) {   
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
	    foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
	    {
		@@_ = split "¤", $k;
		printf(OUT "%9d  %-15s$CRLF",  $s10{$k},$_[0]);
	    }
	} else {
	    if ($userundef gt 0) {
		printf OUT "Not Available - not logged in log file.$CRLF";
	    } else {
		printf OUT "None. $CRLF";
	    }
	}
    } 
    else {
	print OUT "uniq = $uniq. Nou Users";
	print OUT $opt_m;
    }


    sumhash(\%s1);
    if (($uniq gt 0) && (! defined $opt_m)) {
	print OUT "$CRLF********** Logged in users per IP-address (excl Anonymous) **********$CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "Shows the source IP-addresses of successful logins. Make sure all addresses are valid or can be derived.";
	    print OUT "$desctxt\n";
	}

	#sumhash (\%s1);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%9s  %-15s  %-15s  %s$CRLF",  'Count', 'User', 'Src-IP', 'FQDN';
	    foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
	    {
		@@_ = split "¤", $k;
		printf OUT "%9d  %-15s  %-15s  %s$CRLF",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
	    }
	} else {
	    if ($userundef gt 0) {
		printf OUT "Not Available - not logged in log file.$CRLF";
	    } else {
		printf OUT "None. $CRLF";
	    }
	}
    }

    # Count of all Statuscodes...
    print OUT "$CRLF********** Count of HTTP statuscodes ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "Shows all Statuscodes. If 404's are missing, this probably indicates a fualty error-page. Excessive 4xx and 5xx codes can indicate problems that need further investigation.";
	print OUT "$desctxt\n";
    }
    sumhash (\%s5);
    
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Status $CRLF";
    foreach $k (sort keys %s5 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d (%6.2f%%) HTTP Status: %-4d  %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
	printf(OUT "%9d (%6.2f%%)    %4s %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
    }

    # Count of all HTTP Methods...
    print OUT "$CRLF********** Count of HTTP Methods ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "Shows all attempted Methods. GET and POST are most common and normal. Others can indicate reconnossaince attempts, or manipulation attempts, however there are many Methods which are legitimate, depending on server and configuration.";
	print OUT "$desctxt\n";
    }
    sumhash (\%s19);
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Method $CRLF";
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
	@@_ = split "¤", $k;
	printf(OUT "%9d (%6.2f%%)     %s$CRLF",  $s19{$k}, ($s19{$k}*100/$sum),    $k,);
    }
        
    # Count of all HTTP Versions...
    print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "There are basically two (or maybe three) HTTP versions: HTTP/1.0, HTTP/1.1, HTTP/0.9. Anything else is either a faulty browser or reconnossaince / manipulation attempts. Keep an eye on addresses generating invalid HTTP versions.";
	print OUT "$desctxt\n";
    }
    
    sumhash (\%s6);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "    Count     ( % )    HTTP-Version $CRLF";
	foreach $k (sort {$s6{$b} <=> $s6{$a}} keys %s6 )
	{
	    @@_ = split "¤", $k;
	    #printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	    printf(OUT "%9d (%6.2f%%)    %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	}
    
	# List illegal HTTP Versions...
	sumhash(\%s61);
	if ((($uniq eq 0) && (! defined $opt_m)) || ($uniq gt 0)) {
	    print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
	    if ($pdesc eq 1) {
		$desctxt = "This list all requests done without a valid HTTP versoin. This could indicate attempts to connect via telnet or other tcp based mechanism, usually indicating reconnosaince. Keep an eye on addresses in this list.";
		print OUT "$desctxt\n";
	    }
	
	    sumhash (\%s61);
	    if ($uniq gt 0) {
		print OUT "Totally $sum and $uniq unique.$CRLF";
		printf(OUT "%9s %-25s %-15s %s %-s$CRLF", 'Count' , 'HTTP String',  'IP', 'FQDN');
		foreach $k (sort {$s61{$b} <=> $s61{$a}} keys %s61 )
		{
		    @@_ = split "¤", $k;
		    printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[1], resolve($_[1]));
		}
	    } else {
		printf OUT "None. $CRLF";
	    }
	}
    } else {
	if ($httpverundef gt 0) {
	    printf OUT "Not Available - not logged in log file.$CRLF";
	}
    }

    # List the Top HIT'ers
    $xx = 1;
    sumhash(\%iptab);
    print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This list shows the addresses requesting the most pages (hits). Each hit uses resources - cpu and bandwidth. Top IP's in this list can indicate anything from a valid interested user, to a spider crawling your site looking for security holes. Or someone asking repetitive querys to your database. Keep an eye on the top IP's.";
        print OUT "$desctxt\n";
    }

    #sumhash (\%iptab);
    #print OUT ($uniq >= $topmax) ? $topmax : $uniq;
    print OUT "Totally $sum and $uniq unique.$CRLF";
    printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
    foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
    {
	@@_ = split "¤", $k;
	printf(OUT "%4d (%6.2f%%)  %7d  %-15s  %-30s$CRLF", $xx, ($iptab{$k}*100/$sum), $iptab{$k},$_[0], resolve($_[0]));
	if ($xx++ == $topmax) { last; }
    }
    
    
    # List attempts to access non-existing pages
    print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
    if ($pdesc eq 1) {
	$desctxt = "This list indicates the top requests for nonexistent oages. The tops on this list either indicate faulty links in the sites HTML code, or you are being hit by malicious worms.  ";
        print OUT "$desctxt\n";
    }

    sumhash (\%s01);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
	foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %7d  %-15s$CRLF",  $s01{$k},$_[0], $_[1]);
	}
	
	print OUT "$CRLF$CRLF********** Top $topmax IP\'s generating 403/404 **********$CRLF";
	if ($pdesc eq 1) {
	    
	    $desctxt = "This list shows the addresses requesting the most nonexistent pages (hits). Each request for a nonexistent page can mean one or more of several things: 1) Someone is actively looking for known security holes on your site. 2) There are faulty links in your HTML code. 3) You are being hit by malicious selfpropagating worms. 4) Someone is preforming reconnossaince of your site. And failing. Bottom line? Top hitters on this list could actively be looking for security holes - monitor their IP's";
	    print OUT "$desctxt\n";
	}
	$xx = 1;
	sumhash (\%s02);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%4s %7s   %-15s  %s$CRLF",  'Rank', "Count", "IP-Address", "FQDN");
	foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
	{
	    @@_ = split "¤", $k;
	    #printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	    printf(OUT "%4d %7d   %-15s  %s$CRLF",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "$CRLF$CRLF********** Top $topmax Files per IP genererating 403/404 **********$CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "Is any single IP hammering your site for a non-existent page? Possible Denial-of-Service attempt, or faulty site configuration.";
	    print OUT "$desctxt\n";
	}
	$xx = 1;
	sumhash (\%s0);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could inidicate either faultly links on your site, or$CRLF";
	print OUT "a perpetrator looking for vulnerabilities.$CRLF";
	printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
	foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%4d %7d  %-15s  %s$CRLF",  $xx, $s0{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        printf OUT "None. $CRLF";
    }
    
	
    
    # 5xx Status
    sumhash(\%s42);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "Errors generated here are on the server. This could either be manipulation attempts, or excessive database access. Or just a misconfiguration of the web server.";
	    print OUT "$desctxt\n";
	}
	
	sumhash (\%s42);
	if ($uniq > 0) {
	    $xx = 1;
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
	    foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-7d  %-15s %s$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
		if ($xx++ == $topmax) { last; }
	    }
	    
	    
	    # 5xx Status
	    print OUT "$CRLF********** Top $topmax URL\'s causing Server Errors (5xx) ********** $CRLF";
	    if ($pdesc eq 1) {
		$desctxt = "Errors generated here are on the server. This could either be manipulation attempts, or excessive database access. Or just a misconfiguration of the web server. If the same URL is causing the errors, this might indicate the source of the problem. Or possibly a security breach.";
		print OUT "$desctxt\n";
	    }
	    
	    $xx = 1;
	    sumhash (\%s4);
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
	    foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-7d  %-20s$CRLF",  $s4{$k},$_[0], $_[1]);
		if ($xx++ == $topmax) { last; }
	    }
	    
	    print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
	    if ($pdesc eq 1) {
		$desctxt = "Is any single IP using a specific URL to wreak havoc on your web server?";
		print OUT "$desctxt\n";
	    }
	    
	    $xx = 1;
	    sumhash (\%s41);
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
	    foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-7d  %-15s  %s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
		if ($xx++ == $topmax) { last; }
	    }
	} else {
	    printf OUT "None. $CRLF";
	}
    }


    # Binary / un-printable data in URL's
    sumhash (\%s45);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	print OUT "$CRLF********** URL's containing binary data ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This is a no-no. Anything listed here should not happen under normal circumstances, since binary data is not allowed in a URL. It should always be encoded in some way. Entries gere could indicate attempts to cause buffer overflows and security breaches. There is a possible false positive with some obscure browsers sending odd binary data, but it is not common. Check these IPs!";
	    print OUT "$desctxt\n";
	}
	
	sumhash (\%s45);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
	    foreach $k (sort {$s45{$b} <=> $s45{$a}} keys %s45 )
	    {
		@@_ = split "\#\#", $k;
		printf (OUT "%7d  %-15s  %-50s$CRLF",  $s45{$k},$_[0], $_[1]);
	    }
	} else {
	    printf OUT "None Found. $CRLF";
	}
    }

    # Top Referers
    $xx = 1;
    print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This is mostly for reference, but if your server is vulnerable, someone might have put a link to it on their site. And you will then see where they are coming from (i.e. refered to).";
        print OUT "$desctxt\n";
    }

    sumhash (\%s11);
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Referer' ;
	foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s11{$k},$_[0]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        if ($refererundef gt 0) {
            printf OUT "Not Available - not logged in log file.$CRLF";
        } else {
            printf OUT "None. $CRLF";
        }
    }
    

    # Top Blank referers
    $xx = 1;
    print OUT "$CRLF********** Top $topmax Blank Referers ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This could indicate information-harvesters fetching pages through an automated tool. It would also show users coming through bookmarked pages.";
        print OUT "$desctxt\n";
    }

    sumhash (\%s131);
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s %-12s $CRLF", 'Count', ,'IP', 'Referer' ;
	foreach $k (sort {$s131{$b} <=> $s131{$a}} keys %s131 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-15s %-12s $CRLF",  $s131{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        if ($refererundef gt 0) {
            printf OUT "Not Available - not logged in log file.$CRLF";
        } else {
            printf OUT "None. $CRLF";
        }
    }
    
    # Top Browsers
    $xx = 1;
    print OUT "$CRLF********** Browsers ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This is mostly for reference. The most common browsers are listed in their various formats. However, there are tools which use non-common  brosers. Use of such can be indicative of reconnossaince of the site. Be observant of the top and bottom entries in this list."; 
        print OUT "$desctxt\n";
    }

    sumhash (\%s12);
    if ($uniq gt 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
	foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s12{$k},$_[0]);             
	    #if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
    }

    # Check for Cookie Manipulation
    sumhash(\%s14);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	$xx = 1;
	print OUT "$CRLF********** Same Cookie from different IP-addresses ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This could inidicate attempted session hijacking (unlikely, but serious), or users coming via a non-ip session aware proxy (likely, and not so serious).";
	    print OUT "$desctxt\n";
	}
	
	#sumhash (\%s14);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
	    printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
	    #foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
	    $old = '';
	    foreach $k (sort keys %s14)
	    {
		#print "\$k: $k\n";
		@@_ = split "¤", $k;
		#print "\$_\[0\]:$_[0]$CRLF";
		if ($old ne $_[0]) {
		    print OUT "$CRLF";
		    #$co = $cookie;
		    $co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
		    
		    printf OUT "Cookie: %s$CRLF", $co;
		}
		printf OUT "%9d %-15s %s$CRLF", $s14{$k}, $_[1], resolve($_[1]);
		
		$old = $_[0];
		#if ($xx++ == $topmax) { last; }
	    }
	} else {
	    if ($cookieundef gt 0) {
		printf OUT "Not Available - not logged in log file.$CRLF";
	    } else {
		printf OUT "None. $CRLF";
	    }
	}
    }

    sumhash(\%s21);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	print OUT "$CRLF********** Cross Site Scripting Attempts per IP *********$CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "Anything listed here could indicate Cross Site Scripting attempts. If successfull, they could allow stealing of your users credentials, and thus alleviating unauthorized access. Successfull attempts listed here must be examined further.";
	    print OUT "$desctxt\n";
	}
	#sumhash (\%s21);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s %-15s %-40s %-15s$CRLF", 'Count', 'IP', 'URL', 'FQDN';
	    foreach $k (sort {$s21{$b} <=> $s21{$a}} keys %s21)
	    {
		($ip, $url) = split "¤", $k;
		printf OUT "%7d %-15s %-40s %-15s$CRLF",  $s21{$k}, $ip, $url, resolve($ip);
	    }
	} else {
	    print OUT "None found.$CRLF";
	}
    }

    # Check for Directory scanning / Listing
    sumhash(\%s15);
    if ((($uniq gt 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	$xx = 1;
	print OUT "$CRLF********** Unsuccessful Subdirectory Listing Attempts ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This indicates reconnosaince buy attempting to list subdirectories of the site. The perpetrator is presumably looking for misconfigured default pages or trying to view source code.";
	}
	#sumhash (\%s15);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    #print OUT "This could inidicate attempted session hijacking.$CRLF";
	    printf OUT "%7s %7s %-30s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
	    foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d %7s %-30s %-15s %s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
		if ($xx++ == $topmax) { last; }
	    }
	} else {
	    print OUT "None found.$CRLF";
	}
    }
    
    sumhash(\%s151);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	print OUT "$CRLF********** Unsuccessful Subdir attempts per IP ********$CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "If the Top IP's generate errors on many subdirectories, it is a probable attempted (and possibly succeeded) reconnossaince sweep.";
	    print OUT "$desctxt\n";
	}
	
	#sumhash (\%s151);
	if (uniq gt 0) {
	    foreach $k (sort {$s151{$b} <=> $s151{$a}} keys %s151) 
	    {
		printf(OUT "Count: %-10s IP: %-15s %s$CRLF", $s151{$k}, $k, resolve($k));
		foreach $l (sort {$s15{$b} <=> $s15{$a}} keys %s15) {
		    ($ip2, $url2, $status2) = split "¤", $l;
		    if ($ip2 eq "$k") {
			printf OUT "  Subdir: %7s  %4d  %s $CRLF", $s15{$l}, $status2, $url2;
		    }
		}
		print OUT "$CRLF";
	    } 
	} else {
	    print OUT "None found.$CRLF";
	}
    }


    # List attempted form manipulation
    sumhash(\%s16);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)) {
	$xx = 1;
	print OUT "$CRLF********** Suspected Form Data Manipulation ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This is basically only valid of the site has a database which can be accessed via SQL. It could indicate attempts to manipluate queries to your database, but could also be a false positive. Needs verification to rule out unauthorized access.";
	    printf OUT "$desctxt\n";
	}
	
	#sumhash (\%s16);		     
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    print OUT "This could inidicate attempted unauthorized database access.$CRLF";
	    printf OUT "%7s %-30s %-15s %-15s %-20s$CRLF", 'Count', 'Query', 'IP', 'FQDN' ;
	    foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d %-30s %-15s %-15s$CRLF",  $s16{$k}, $_[1], $_[0], resolve($_[0]));
		if ($xx++ == $topmax) { last; }
	    }
	} else {
	    print OUT "None found.$CRLF";
	}
    }

    sumhash(\%s17);
    if ((($uniq eq 0) && (!defined $opt_m))  || ($uniq gt 0)) {
	# List attempted Anonymous Proxy Scans
	$xx = 1;
	print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This indicates attempts to locate and possibly use the site to stage further attacks. If the proxy attempts are successful, the site could be used to relay spam or participate in illegitimate activities.";
	    printf OUT "$desctxt\n";
	}
	
	#sumhash (\%s17);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'Request', 'IP', 'FQDN';
	    foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d %6d %-40s %-15s %s$CRLF",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
		if ($xx++ == $topmax) { last; }
	    }
	} else {
	    print OUT "None found.$CRLF";
	}
    }


    # List exceedingly Long URL's
    sumhash(\%s18);
    if ((($uniq eq 0) && (!defined $opt_m)) || ($uniq gt 0)){
	$xx = 1;
	print OUT "$CRLF********** Exceedingly Long URL's ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This indicates attempts to locate and possibly execute a buffer overflow. If sucessful a perpetrator could have full system access. This in not common, but rather there are long URL's on the site which falsely trigger this.";
	    printf OUT "$desctxt\n";
	}
	
	sumhash (\%s18);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
	    foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
	    {
		@@_ = split "¤", $k;
		printf(OUT "%7d %6s %10s  %-30s\n%26s %-15s %s $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] ,'', $_[1], resolve($_[1]));
		if ($xx++ == $topmax) { last; }
	    }
	} else {
	    print OUT "None found.$CRLF";
	}
    }
    
    close OUT;
    slog("Done printing text output");

}



sub printxml {
    
    #my $output = new IO::File(">output.xml");
    my $output = new IO::File(">$outfile");
    #print STDERR "XML Outfile: $outfile\n";
    
    $w = new XML::Writer(OUTPUT => $output, NEWLINES => 0, DATA_INDENT => 2, DATA_MODE => 1);
    #print $output ' ';  # Fixup because otherwise the first character is lost!
    #$w->characters();
    #print $output; 
    $w->xmlDecl('UTF-8',"yes");
    $w->comment('Secsrch ' . localtime());
    #$w->doctype("secsrch");
    
    # Check if results are OK, before mailing report
    if ($numlines eq $logformat{'Unknown'}) {
	exit 99;
    }
    slog('Printing XML output');
    $w->startTag('report', 'version' => '1.0');
    $w->startTag('reportinfo');
    $w->dataElement('version', $VERSION);
    $w->dataElement('logdatestart', $mindate);
    $w->dataElement('logdateend', $maxdate);
    $w->dataElement('title', "Security Log File Analysis");
    $w->dataElement('analysisstart', " " . localtime());
    $w->startTag('inputfiles');
    foreach $f (@@list) {
	$w->dataElement('file',$f);
    }
    $w->endTag('inputfiles');

    $w->dataElement('outputfile', $outfile);
    $w->dataElement('execstart', $starttimetext);
    $w->dataElement('execstop', localtime(). "");
    $w->dataElement('rowsanalysed',$numlines);
    $w->dataElement("rowsanalysedpersec", $numlines / (time - $starttime + 1));
    $w->dataElement('nripaddr',$numip);
    $w->dataElement('perf',  $numlines / (time - $starttime + 1));
    $w->dataElement('nameresoff', $opt_N);
    $w->endTag('reportinfo');
    $w->startTag('logformats');
    #$w->characters(prntx('title','Logformats'));
    

    foreach $x (keys %logformat) {
	$w->startTag("rec");
	$w->dataElement('format', $x);
	$w->dataElement('nrfound', $logformat{$x});
	$w->endTag("rec");
    }

    $w->endTag('logformats');


    slog("Nr of Analyzed rows: $numlines");
    slog("Rows/sec: " . $numlines / (time - $starttime + 1));
    #printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);

    
    # Show number of hits/hour
    $w->startTag("hitsperhour");
    $w->dataElement('title','Hits per hour');
    $w->dataElement('desc', 'This shows the number of Hits per hour. Any sudden drops or increases in traffic can be due to web pounders stealing bandwidth, or an effective Denial of Service.');
    sumhash (\%s7);
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
    #foreach $k (sort keys %s7)
    for ($k=0;$k<24;$k++)
    {
	@@_ = split "¤", $k;
	$hits = $s7{sprintf("%02d", $k)};
	if ($hits eq '') { $hits = '0'};
	#printf (OUT "  <hits hour=\"%d\">%s</hits>\n",  $_[0], $hits);
	$w->startTag("rec");
	$w->dataElement('hour', $_[0]);
	$w->dataElement('hits', $hits);
	$w->endTag("rec");
    }
        
    $w->endTag("hitsperhour");


    # Dangerous files...
    sumhash (\%s3);
    $w->startTag('dangerousfiles', 
		 'total' => $sum,
		 'uniq' => $uniq);
    $w->dataElement('title', 'Successful attempts to retrieve Dangerous files');
    $w->dataElement('desc', 'This could indicate successful attempts to retrieve sensitive files, or possibly execute system commands in the server.');

    foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement ('count',$s3{$k});
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('url',$_[1]);
	$w->endTag('rec');
    }
    $w->endTag(dangerousfiles);

    
    # Unauthorized - Users who have accessed protected pages 
    sumhash (\%s2);
    $w->startTag("unauthorized", 
		 'total' => $sum, 
		 'uniq' => $uniq);
    $w->dataElement('title', 'Users who have accessed protected page');
    $w->dataElement('desc','This shows all users who have accessed password protected pages. Users whi repeatedly access the same page could indicate password brute force attempts.');
    foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s2{$k});
	$w->dataElement('status',$_[0]);
	$w->dataElement('srcip',$_[1]);
	$w->dataElement('user',$_[3]);
	$w->dataElement('url',$_[2]);
	$w->endTag('rec');
    }
    $w->endTag('unauthorized');    


    # Logged in Users
    sumhash (\%s10);
    
    $w->startTag('logged_in_users', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title','Logged in users');
    $w->dataElement('desc','Lists all users who have successfully logged in. Verify that the users are valid.');
    foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('user',$_[0]);
	$w->dataElement('count', $s10{$k});
	$w->endTag('rec');

    }
    $w->endTag('logged_in_users');

    
    # Logged in users per IP-address (excl Anonymous) 
    sumhash (\%s1);
    $w->startTag('logged_in_users_per_ip', 'total' => $sum, 'uniq' => $uniq);
    
    $w->dataElement('title', 'Logged in user per IP-address');
    $w->dataElement('desc', 'Shows the source IP-addresses of successful logins. Make sure all addresses are valid or can be derived.');
    foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s1{$k});
	$w->dataElement('user',$_[0]);
	$w->dataElement('srcip',$_[1]);
	$w->dataElement('fqdn',$sip{$_[1]});
	$w->endTag('rec');	
    }
    $w->endTag('logged_in_users_per_ip');
        

    # Count of all Statuscodes...
    sumhash (\%s5);
    $w->startTag('statuscodes', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title','Statuscodes');
    $w->dataElement('desc', 'Shows all Statuscodes. If 404\'s are missing, this probably indicates a fualty error-page. Excessive 4xx and 5xx codes can indicate problems that need further investigation.');
    foreach $k (sort keys %s5 )
    {
        @@_ = split "¤", $k;
        $w->startTag('rec');
	$w->dataElement('count',$s5{$k});
        $w->dataElement('status',$_[0]);
        $w->dataElement('statusname',$STATCODE{$_[0]});
        $w->endTag('rec');
    }
    $w->endTag('statuscodes');

    # Count of all HTTP Methods...
    sumhash (\%s19);
    $w->startTag('httpmethods', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'List of HTTP methods found');
    $w->dataElement('desc', 'Shows all attempted Methods. GET and POST are most common and normal. Others can indicate reconnossaince attempts, or manipulation attempts, however there are many Methods which are legitimate, depending on server and configuration.');
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s19{$k});
	$w->dataElement('method',$k);
	$w->endTag('rec');
    }
    $w->endTag('httpmethods');
    

    
    # Count of all HTTP Versions...
    sumhash (\%s6);

    $w->startTag('httpversions', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Count of HTTP-verssions');
    $w->dataElement('desc', 'There are basically two (or maybe three) HTTP versions: HTTP/1.0, HTTP/1.1, HTTP/0.9. Anything else is either a faulty browser or reconnossaince / manipulation attempts. Keep an eye on addresses generating invalid HTTP versions.');
    foreach $k (sort keys %s6 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s6{$k});
	$w->dataElement('version',$_[0]);
        $w->endTag('rec');
    }
    $w->endTag('httpversions');
        
    
    # List illegal HTTP Versions...
    sumhash (\%s61);
    
    $w->startTag('illegalhttp', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Invalid HTTP-versions');
    $w->dataElement('desc', 'This list all requests done without a valid HTTP version. This could indicate attempts to connect via telnet or other tcp based mechanism, usually indicating reconnosaince. Keep an eye on addresses in this list.');
    foreach $k (sort keys %s61 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s61{$k});
	$w->dataElement('httpstr',$_[0]);
	$w->dataElement('srcip',$_[2]);
	$w->dataElement('fqdn',resolve($_[2]));
	$w->endTag('rec');
    }
    $w->endTag('illegalhttp');

    
    # List the Top HIT'ers
    $xx = 1;
    sumhash(\%iptab);
    $w->startTag('tophitters', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'List of Top Hitters');
    $w->dataElement('desc', 'This list shows the addresses requesting the most pages (hits). Each hit uses resources - cpu and bandwidth. Top IP\'s in this list can indicate anything from a valid interested user, to a spider crawling your site looking for security holes. Or someone asking repetitive querys to your database. Keep an eye on the top IP\'s.');
    foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('rank',$xx);
	$w->dataElement('count',$iptab{$k});
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('fqdn',resolve($_[0]));
	
	$w->endTag('rec');
	if ($xx++ == $topmax) { last; }
    }
    $w->endTag('tophitters');
    


    # List attempts to access non-existing pages

    sumhash (\%s01);
    $w->startTag('errors4xx', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Access attempts generating 4xx errors');
    $w->dataElement('desc', 'This list indicates the top requests for nonexistent pages. The tops on this list either indicate faulty links in the sites HTML code, or you are being hit by malicious worms.');
    foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s01{$k});
	$w->dataElement('httpstatus',$_[0]);
	#prntx('url',uri_escape($_[1]));
	$w->dataElement('url',$_[1]);
	$w->endTag('rec');
    }
    
    $w->endTag('errors4xx');
    
    
    #Top IP\'s generating 403/404 **********
    $xx = 1;
    sumhash (\%s02);
    $w->startTag('top4xxerrorsperip', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top 4xx errors per IP');
    $w->dataElement('desc','This list shows the addresses requesting the most nonexistent pages (hits). Each request for a nonexistent page can mean one or more ofseveral things\: 1) Someone is actively looking for known security holes on yoursite. 2) There are faulty links in your HTML code. 3) You are being hit by malicious selfpropagating worms. 4) Someone is performing reconnossaince of your site. And failing. Bottom line\? Top hitters on this list could actively be looking for security holes - monitor their IP\'s');    foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('rank',$xx);
	$w->dataElement('count',$s02{$k});
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('fqdn',$sip{$_[0]});
	$w->endTag('rec');
	if ($xx++ == $topmax) { last; }
    }
    $w->endTag('top4xxerrorsperip');
    
    
    #********** Top $topmax Files per IP genererating 403/404 *********
    $xx = 1;
    sumhash (\%s0);
    $w->startTag('top4xxerrorsperipurl', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top 4xx errors per IP and URL');
    $w->dataElement('desc', 'Is any single IP hammering your site for a non-existent page? Possible Denial-of-Service attempt, or faulty site configuration.');
    foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('rank',$xx);
	$w->dataElement('count',$s0{$k});
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('url',$_[1]);

	$w->endTag('rec');
	if ($xx++ == $topmax) { last; }
    }
    $w->endTag('top4xxerrorsperipurl');
    

    # 5xx Status
    sumhash (\%s42);
    $w->startTag('top_5xx_errors_per_ip', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top 5xx errors per IP');
    $w->dataElement('desc', 'Errors generated here are on the server. This could either be manipulation attempts, or excessive database access. Or just a misconfiguration of the web server.');
    $xx = 1;
    foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s42{$k});
	$w->dataElement('status',$_[0]);
	$w->dataElement('srcip',$_[1]);
	$w->dataElement('fqdn',$sip{$_[1]});
	$w->endTag('rec');
	#if ($xx++ == $topmax) { last; }
    }
    
    $w->endTag('top_5xx_errors_per_ip');

    
    
    # 5xx Status
    #******* Top $topmax URL\'s causing Server Errors (5xx) 
    $xx = 1;
    sumhash (\%s4);
    $w->startTag('top_5xx_errors_per_url', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top 5xx errors per URL');
    $w->dataElement('desc','Errors generated here are on the server. This couldeither be manipulation attempts, or excessive database access. Or just a misconfiguration of the web server. If the same URL is causing the errors, this might indicate the source of the problem. Or possibly a security breach.');
    foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s4{$k});
	$w->dataElement('status',$_[0]);
	$w->dataElement('url',$_[1]);
	$w->endTag('rec');
	if ($xx++ == $topmax) { last; }
    }
    $w->endTag('top_5xx_errors_per_url');

    
    # Top URL\'s & IP\'s causing Server Errors (5xx) 
    $xx = 1;
    sumhash (\%s41);
    
    $w->startTag('top_5xx_errors_per_ip_url', 'total' => $sum, 'uniq' => $uniq);  
    $w->dataElement('title', 'Top 5xx errors per IP and URL');
    $w->dataElement('desc', 'Is any single IP using a specific URL to wreak havoc on your web server?');
    foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s41{$k});
	$w->dataElement('status',$_[0]);
	$w->dataElement('srcip',$_[2]);
	$w->dataElement('url',$_[1]);
	$w->endTag('rec');
    }

    $w->endTag('top_5xx_errors_per_ip_url');


#### Addes URLS with binary data.

    # Binary / un-printable data in URL's
    sumhash (\%s45);
    $w->startTag('url_with_binary_data', 'total' => $sum, 'uniq' => $uniq);
    
    $w->dataElement('title', 'URL\'s containing binary data');
    $w->dataElement('desc', 'This is a no-no. Anything listed here should not happenunder normal circumstances, since binary data is not allowed in a URL. It should always be encoded in some way. Entries gere could indicate attempts to cause buffer overflows and security breaches. There is a possible false positive with some obscure browsers sending odd binary data, but it is not common. Check these IPs!');
    	
    if ($uniq gt 0) {
	foreach $k (sort {$s45{$b} <=> $s45{$a}} keys %s45 )
	{
	    @@_ = split "\#\#", $k;
	    $w->startTag('rec');
	    $w->dataElement('count', $s45{$k});
	    $w->dataElement('srcip', $_[0]);
	    $w->dataElement('url', $_[1]);
	    $w->endTag('rec');

	}
    }

    $w->endTag('url_with_binary_data');

     
    # Top Referers
    $xx = 1;
    sumhash (\%s11);

    #if ($uniq > 0 ) {
    $w->startTag('topreferers', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top Referers');
    $w->dataElement('desc', 'This is mostly for reference, but if your server is vulnerable, someone might have put a link to it on their site. And you will then see where they are coming from (i.e. refered to).');
    foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	
	if ($_[0] =~ m/(.*?)\?(.*)/) {
	    $urlstr = $1; $uristr = uri_escape($2);
	} else {
	    #print "$_[0]\n";
	    $urlstr = $_[0]; $uristr = '';
	}

	$w->dataElement('count',$s11{$k});
	$w->dataElement('refurl',$urlstr);
	$w->dataElement('refuri',$uristr);
	$w->endTag('rec');
	#if ($xx++ == $topmax) { last; }
    }
    $w->endTag('topreferers');


    # Top Blank referers
    $xx = 1;
    sumhash (\%s131);
    $w->startTag('top_blank_ref', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top Blank Referers');
    $w->dataElement('desc', 'This could indicate information-harvesters fetching pages through an automated tool. It would also show users coming through bookmarked pages.');
    
    foreach $k (sort {$s131{$b} <=> $s131{$a}} keys %s131 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "%7d  %-15s %-12s $CRLF",  $s131{$k},$_[0], $_[1]);
	$w->startTag('rec');
	$w->dataElement('count', $s131{$k});
	$w->dataElement('srcip', $_[0]);
	$w->dataElement('url', $_[1]);
	$w->endTag('rec');
	
	if ($xx++ == $topmax) { last; }
    }

    #if ($refererundef gt 0) {
    #printf OUT "Not Available - not logged in log file.$CRLF";
    #} else {
    #printf OUT "None. $CRLF";
    #}

    $w->endTag('top_blank_ref');



    # Top Browsers
    $xx = 1;
    sumhash (\%s12);
    $w->startTag('topbrowsers', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Top Browsers used');
    $w->dataElement('desc', 'This is mostly for reference. The most common browsers are listed in their various formats. However, there are tools which use non-common  brosers. Use of such can be indicative of reconnossaince of the site. Be observant of the top and bottom entries in this list.');
    foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s12{$k});
	$w->dataElement('browser',uri_escape($_[0]));
	$w->endTag('rec');
	#if ($xx++ == $topmax) { last; }
    }
    
    $w->endTag('topbrowsers');


    # Check for Cookie Manipulation
    $xx = 1;
    sumhash (\%s14);

    $w->startTag('cookiemanip', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Suspected Cookie Manipulation');
    $w->dataElement('desc', 'This could inidicate attempted session hijacking (unlikely, but serious), or users coming via a non-ip session aware proxy (likely, and not so serious).');
    
    $old = '';
    foreach $k (sort keys %s14)
    {
	@@_ = split "¤", $k;
	if ($old ne $_[0]) {
	    $co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
	    $w->dataElement('cookie', $co);
	}
	$w->startTag('cookieinfo');
	$w->dataElement('count', $s14{$k});
	$w->dataElement('srcip', $_[1]);
	$w->dataElement('fqdn', resolve($_[1]));
	$w->endTag('cookieinfo');
	
	$old = $_[0];
	#if ($xx++ == $topmax) { last; }
    }
    $w->endTag('cookiemanip');



    #### Cross Site Scripting Attempts
    sumhash(\%s21);
    $w->startTag('xss_per_ip', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Cross Site Scripting Attempts per IP');
    $w->dataElement('desc', 'Anything listed here could indicate Cross Site Scripting attempts. If successfull, they could allow stealing of your users credentials, and thus alleviating unauthorized access. Successfull attempts listed here mustbe examined further.');
    
    foreach $k (sort {$s21{$b} <=> $s21{$a}} keys %s21)
    {
	($ip, $url) = split "¤", $k;
	$w->startTag('rec');
        $w->dataElement('count', $s21{$k});
        $w->dataElement('srcip', $ip);
	$w->dataElement('url', $url);
	$w->dataElement('fqdn', resolve($ip));
        $w->endTag('rec');
    }

    $w->endTag('xss_per_ip');


    # Check for Directory scanning / Listing
    $xx = 1;
    sumhash (\%s15);
    $w->startTag('subdirlist', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Subdirectory Listing Attempts');
    $w->dataElement('desc','This indicates reconnosaince buy attempting to list subdirectories of the site. The perpetrator is presumably looking for misconfigureddefault pages or trying to view source code.');
    foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s15{$k});
	$w->dataElement('status',$_[2]);
	$w->dataElement('url',$_[1]);
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('fqdn',resolve($_[0]));
	$w->endTag('rec');
	#if ($xx++ == $topmax) { last; }
    }
    $w->endTag('subdirlist');


    sumhash(\%s151);
    $w->startTag('unsuc_subdir_ip', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Unsuccessful Subdir attempts per IP');
    $w->dataElement('desc', 'If the Top IP\'s generate errors on many subdirectories, it is a probable attempted (and possibly succeeded) reconnossaince sweep.');
    foreach $k (sort {$s151{$b} <=> $s151{$a}} keys %s151)
    {
	foreach $l (sort {$s15{$b} <=> $s15{$a}} keys %s15) {
	    ($ip2, $url2, $status2) = split "¤", $l;
	    if ($ip2 eq "$k") {
		$w->startTag('rec');
		$w->dataElement('count',$s151{$k});
		$w->dataElement('srcip',$k);
		$w->dataElement('fqdn',resolve($k));
		$w->dataElement('subdir', $s15{$l});
		$w->dataElement('status', $status2);
		$w->dataElement('url',$url2);
		$w->dataElement('fqdn',resolve($_[0]));
		$w->endTag('rec');
	    }
	}
    }
    $w->endTag('unsuc_subdir_ip');
        

    # List attempted form manipulation
    $xx = 1;
    sumhash (\%s16);
    $w->startTag('formmanip', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'List suspected FORM manipulation');
    $w->dataElement('desc', '');
    foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s16{$k});
	$w->dataElement('query',$_[1]);
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('fqdn',resolve($_[0]));
	$w->endTag('rec');
    }
    $w->endTag('formmanip');
    

    # List attempted Anonymous Proxy Scans
    $xx = 1;
    sumhash (\%s17);
    $w->startTag('locateproxy', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Attempts to locate Proxy');
    $w->dataElement('desc','This indicates attempts to locate and possibly use the site to stage further attacks. If the proxy attempts are successful, the site could be used to relay spam or participate in illegitimate activities.');

    foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count', $s17{$k});
	$w->dataElement('status', $_[1]);
	$w->dataElement('url', $_[2]);
	$w->dataElement('srcip',$_[0]);
	$w->dataElement('fqdn',resolve($_[0]));
	$w->endTag('rec');
	if ($xx++ == $topmax) { last; }
    }
    $w->endTag('locateproxy');


    # List exceedingly Long URL's
    $xx = 1;
    sumhash (\%s18);
    $w->startTag('longurlattempt', 'total' => $sum, 'uniq' => $uniq);
    $w->dataElement('title', 'Exceedingly Long URLs');
    $w->dataElement('desc', "These could indicate attempts to locate and use Buffer Overflows to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.");
    
    foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
    {
	@@_ = split "¤", $k;
	$w->startTag('rec');
	$w->dataElement('count',$s18{$k});
	$w->dataElement('status',$_[3]);
	$w->dataElement('length',$_[2]);
	$w->dataElement('url',$_[0]);
	$w->dataElement('srcip',$_[1]);
	$w->dataElement('fqdn',resolve($_[1]));
	$w->endTag('rec');
	if ($xx++ == $topmax) { last; }
    }
    
    $w->endTag('longurlattempt');
    $w->endTag('report');
    $w->end();
    
    #close OUT;
    slog('Done printing XML Output');
}  # End sub printxml



# Routine to print Statistics for later analysis
sub printstats {
    print STATS '<?xml version="1.0"?>' . "\n";
    print STATS '<SecSrchRun run="secsrch.pl" version="' . $VERSION . '" xmloutputversion="1.0">' . "\n";
    print STATS "<PeriodStart>$mindate</PeriodStart>\n";
    print STATS "<PeriodEnd>$maxdate</PeriodEnd>\n";
    print STATS "<host>\n";
    print STATS "<hostname>" . $cname . "</hostname>\n";
    print STATS "<numlines>" . $numlines . "</numlines>\n";
    print STATS "<errorlines>" . $logformat{'Unknown'} . "</errorlines>\n";

    print STATS "<httpstats>\n";
    print STATS "<code200>"  ;

    print STATS "</host>\n";
    print STATS "</SecSrchRun>\n";

} # End sub printstats


######################
# Below are various routines to ease things up

sub prntx () {
    my ($xmlname, $xmlvalue) = @@_ ;
    $w->startTag($xmlname);
    $w->characters($xmlvalue);
    $w->endTag($xmlname);
} # End sub prntx

sub sumhash  ()
{
    # Get Total, unique, Max and Min from hash
    $sum = 0; $uniq = 0; 
    undef $max;
    foreach $href (@@_)
    {
	while ( ($key, $value) = each %$href ) 
	{
	    $sum = $sum + $value; 
	    $uniq++ ; 
	    if (defined $max) { if ($max < $value ) { $max = $value; }
	    } else { $max = $value; }
	    if (defined $min) { if ($min > $value ) { $min = $value; }         
	    } else { $min = $value; }

	}
    }
} # End sub sumhash

# Routine 'borrowed' from snort_stat...

sub resolve {
    
    local ($mname, $miaddr, $mhost = shift);
    if (($opt_N eq 1) || ($res eq 'false')) {return ''}
    #if ($opt_N eq 1) {return ''}
    # if (not $res eq 'true') { return $mhost }
    $miaddr = inet_aton($mhost);
    $HOSTS{$mhost} = gethostbyaddr($miaddr, AF_INET);
    if (!$HOSTS{$mhost}) {
	$mname ="";
	#die if $@@ && $@@ ne "alarm\n";  # propagate errors
	if ($mname =~ /^$/) {
	    $mname = $mhost;
	}
	$HOSTS{$mhost} = $mname;
    }
    return $HOSTS{$mhost};
}

sub slog {
    setlogsock('unix');
    openlog('SecSrch.pl', 'cons,pid', 'local2');
    syslog('info', '%s', @@_);
    closelog;
}

sub plog {
    # Generate Debug Log
    my $txt = shift;
    #open DBG, ">>/tmp/secsrch.dbg";
    #print STDERR $txt;
    #close DBG;
}

sub trunc {
    # Function to truncate values?
    local ($f, $l = shift);
    $fl = length($f);
    if ($fl > $l) {
	$d = $fl - $l; 
	$x = substr($f, 0, (($fl/2) - ($d / 2)));
    }

    return $x;

}

sub urlencode () {
    $x = shift;
    $x =~ s/\&/\&amp;/g;
    return $x;
}

sub save_chart {
    my $chart = shift or die "Need a chart!";
    my $name = shift or die "Need a name!";
    local(*OUT);

    my $ext = $chart->export_format;

      open(OUT, ">$name.$ext") or 
	  die "Cannot open $name.$ext for write: $!";
    binmode OUT;
    print OUT $chart->gd->$ext();
    close OUT;
}

sub sanitize {  # Sub to sanitize filenames and check for illegal characters
    my $x = shift;
    #print STDERR "$x\n";
    my $count = 0;
    if (($x =~ s/[`&'*?^()#$|\>\<\[\]\n\r]//g) gt 0) {
	#print STDERR "Error: $x\n";
	return 99;

    } else 
    {
	return 0;
    }
} 

# Function to print status to temp file, when run form CGI (upload.cgi)
 
sub pstatus {
    # Print progress to status file, for reading from 'progressbar.cgi'
    $filename = @@_[0];
    $total_recv = @@_[1];
    $status = @@_[2];

    open STATUS, ">$statfile";
    flock(STATUS,LOCK_EX);
    print STATUS "$filename\n";
    print STATUS "$total_recv\n";
    print STATUS "$status\n";
    flock(STATUS,LOCK_UN);
    close STATUS;
}

sub printheaders {
    print "Analyzed log line:\n";
    print "$_\n";
    
    foreach $f (keys %logformat) {
	print "Identified Format: $f\n";
    }
    print "Client \$ip = $ip\n"; 
    print "\$serverip = $serverip\n";
    print "\$sitename = $sitename\n";
    print "\$status = $status\n";
    print "\$user = $user\n";
    print "\$date = $date\n";
    print "\$method = $method\n";
    print "\$url = $url\n";
    print "\$len = $len\n";
    print "\$referer = $referer\n";
    print "\$cookie = $cookie\n";
    print "\$uri = $uri\n";
    print "\$browser = $browser\n";
    print "\$httpver = $httpver\n";
    print "\$servername = $servername\n";
}

# And that's about all there is....
@


1.92
log
@Added another Apache custom logformat.
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.91 2007/08/27 13:17:41 mibl Exp mibl $
$REVISION = '$Revision: 1.91 $';
d672 1
a672 1
	elsif ( m/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # Client IP 
d867 1
a867 1
            $logformat{'Apache Custom Combined'}++;
@


1.91
log
@CI for safety sake...
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.90 2004/12/04 07:00:03 mibl Exp mibl $
$REVISION = '$Revision: 1.90 $';
d55 2
d850 52
d908 1
a908 1
	    print;
d910 1
a910 1
	    #$badlines++;
@


1.90
log
@Started adding GD::Grah support
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.89 2004/09/06 10:43:48 mibl Exp mibl $
$REVISION = '$Revision: 1.89 $';
d53 2
@


1.89
log
@Added use of Custom Log I[DOptoins for Apache Logs
Still not finailized, but works.
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.88 2004/09/06 07:11:51 mibl Exp mibl $
$REVISION = '$Revision: 1.88 $';
a129 5

#print $opt_C;
#if ( defined $opt_C ) { print "opt_c definded\n"} else { print "undefined\n"}
#exit;

a229 2
slog('Infile: ' . $infile);
slog('Outfile: ' . $outfile);
d318 3
d323 2
a324 1
    #print STDERR "File \'$outfile\' already exists. Exiting.$CRLF$CRLF";
d342 1
d354 1
a354 1
	die "Error reading from $file: $gzerrno$CRLF" if $gzerrno != Z_STREAM_END ;
a471 1
	#print "\$opt_C: $opt_C\n";
d473 1
a473 1
	print "Match: $_\n";
d475 7
a481 7
	$format =~ s/%h/([\\d\\.]+)\\s\n/g;  # $ip
	$format =~ s/%l/([\\w\\d\\-\\.]+)\\s\n/g; # Remote logname (unused)
	$format =~ s/%u/([\\w\\d\\-\\.]+)\\s\n/g;  # Logged in user
	$format =~ s/%t/(\\[\.+\\])\\s\n/g;
	$format =~ s/\\"%r\\"/(\\"\.+?\\")\\s\n/g;
	$format =~ s/%\>s/(\\d+)\\s\n/g;
	$format =~ s/%b/(\\d+)\\s\n/g;
d483 1
a483 1
	print "\$format: $format\n";
d489 2
d492 1
d495 1
a495 1
	print "\$1: $1\n\$2: $2\n\$3: $3\n\$4: $4\n\$5: $5\n\$6: $6\n\$7: $7\n\$8: $8\n";
d517 4
a520 1
	printheaders();
d522 1
a522 1
	exit;
@


1.88
log
@Completed adding opt_L
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.87 2004/09/06 06:52:48 mibl Exp mibl $
$REVISION = '$Revision: 1.87 $';
d121 1
a121 1
slog("CustomLog Opts: $opt_C $opt_p");
d346 5
a350 2
	    if (splitline() != -1)
	    {
d394 1
a394 15
		    print "Client \$ip = $ip\n"; 
		    print "\$serverip = $serverip\n";
		    print "\$sitename = $sitename\n";
		    print "\$status = $status\n";
		    print "\$user = $user\n";
		    print "\$date = $date\n";
		    print "\$method = $method\n";
		    print "\$url = $url\n";
		    print "\$len = $len\n";
		    print "\$referer = $referer\n";
		    print "\$cookie = $cookie\n";
		    print "\$uri = $uri\n";
		    print "\$browser = $browser\n";
		    print "\$httpver = $httpver\n";
		    print "\$servername = $servername\n";
d460 1
d464 13
a476 1
	print "$opt_C\n";
d478 41
a518 3
	$format =~ s/%h\s/(\\d{1,3\}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}) /g;
	$format =~ s/%A\s/(\\d{1,3\}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})/g;
	print "$format\n";
d624 1
a624 1
	     (?:\s\"(.*?)\")?                    # Optinal Browser type
d2546 23
a2568 1

@


1.87
log
@Added function to print what we think the format is
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.86 2004/08/25 11:26:35 mibl Exp mibl $
$REVISION = '$Revision: 1.86 $';
d390 2
a391 2
		if (defined opt_L) {
		    print "\$ip = $ip\n";
d397 1
a403 1

a405 2

		     
d1474 1
a1474 1
    sumhash (\%s13);
d1478 1
a1478 1
	foreach $k (sort {$s13{$b} <=> $s13{$a}} keys %s13 )
d1481 1
a1481 1
	    printf(OUT "%7d  %-15s %-12s $CRLF",  $s13{$k},$_[0], $_[1]);
@


1.86
log
@Added -o as requirement for output
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.85 2004/05/14 09:26:33 mibl Exp $
$REVISION = '$Revision: 1.85 $';
d102 1
a102 1
getopts('i:o:PmWhvNpsXOC:M:');  
d105 3
d111 2
a112 1
# s - Only print stats
d116 4
a119 4
# W - being run as a CGI (Use <br>\n as $CRLF)
# p - Print a descriptive text for each report section
# m - Minimal output
# M # - Number of lines to read (used mostly for testing the app)
d135 5
d390 20
d433 4
d449 4
d911 1
a911 1
	print STDERR "H:$httpver  Q:$query\n";
a920 1
	
d2491 18
@


1.85
log
@Added check to see if HTTP Version is logged or not in MS IIS Extended logs
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.84 2004/05/11 08:45:59 mibl Exp mibl $
$REVISION = '$Revision: 1.84 $';
d237 3
a239 3
or      [perl] secsrch.pl [options] <infile> [outfile]
or      [perl] secsrch.pl [options] \'<infile\*.gz>\' [outfile]
or      [perl] secsrch.pl [options] \'<infile\*.gz>\' [outdir]
@


1.84
log
@Fixed XML-output
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.83 2004/05/08 17:07:56 mibl Exp mibl $
$REVISION = '$Revision: 1.83 $';
d102 3
a104 1
getopts('PmWhvNpsXoC:');  
d110 2
a111 2
# o - Overwrite output file if it exists
# C - CustomLog Configuration
d115 1
d209 5
a213 1
$infile = $ARGV[0];
d217 5
a221 1
$outfile = $ARGV[1];
d241 1
d316 1
a316 1
if ((-f $outfile) && !($opt_o))
d341 1
d386 1
d414 9
d424 1
d427 1
d514 2
a515 1
	$httpver = $HASH{'cs-version'};
d874 3
a876 1
	#print "H:$httpver  Q:$query\n";
d1201 1
a1201 1

d1203 9
a1211 8
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )    HTTP-Version $CRLF";
    foreach $k (sort {$s6{$b} <=> $s6{$a}} keys %s6 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	printf(OUT "%9d (%6.2f%%)    %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
    }
d1213 8
a1220 8
    # List illegal HTTP Versions...
    sumhash(\%s61);
    if ((($uniq eq 0) && (! defined $opt_m)) || ($uniq gt 0)) {
	print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
	if ($pdesc eq 1) {
	    $desctxt = "This list all requests done without a valid HTTP versoin. This could indicate attempts to connect via telnet or other tcp based mechanism, usually indicating reconnosaince. Keep an eye on addresses in this list.";
	    print OUT "$desctxt\n";
	}
d1222 11
a1232 8
	sumhash (\%s61);
	if ($uniq gt 0) {
	    print OUT "Totally $sum and $uniq unique.$CRLF";
	    printf(OUT "%9s %-25s %-15s %s %-s$CRLF", 'Count' , 'HTTP String',  'IP', 'FQDN');
	    foreach $k (sort {$s61{$b} <=> $s61{$a}} keys %s61 )
	    {
		@@_ = split "¤", $k;
		printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[1], resolve($_[1]));
d1234 4
a1237 2
	} else {
	    printf OUT "None. $CRLF";
d1714 1
a1735 1
    $w->dataElement("rowsanalysedpersec", $numlines / (time - $starttime + 1));
d2316 1
a2316 1
    close OUT;
@


1.83
log
@Continued with XML output
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.82 2004/05/06 09:42:44 mibl Exp mibl $
$REVISION = '$Revision: 1.82 $';
a122 1
#getopts('v');
d207 1
a207 1

d209 1
a209 1

d216 2
a217 1

d258 1
d306 1
a306 1
    print "File \'$outfile\' already exists. Exiting.$CRLF$CRLF";
d311 1
a311 1
open (STATS, ">$statsfile") || die "Can't open $statsfile for output\.";
d1648 2
a1649 1

d1651 5
a1655 1
    $w->xmlDecl();
a1727 1
    #print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
a1734 1
    #printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
d1747 1
a1747 2
    # Unauthorized
    #print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
d1768 1
a1768 1
    #print OUT "$CRLF********** Logged in Users **********$CRLF";
a1773 2
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
a1838 1
    #print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
a1901 2
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
a1984 2
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
d1998 1
a1998 1
    #print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
d2019 1
a2019 1
#### Addes URLS with bainry data.
d2027 1
a2027 4
    print OUT "$desctxt\n";
    
	
    sumhash (\%s45);
a2028 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
a2031 1
	    printf (OUT "%7d  %-15s  %-50s$CRLF",  $s45{$k},$_[0], $_[1]);
a2045 1
    #print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
a2159 1
	#printf OUT "%7d %-15s %-40s %-15s$CRLF",  $s21{$k}, $ip, $url, resolve($ip);
a2197 1
	#printf(OUT "Count: %-10s IP: %-15s %s$CRLF", $s151{$k}, $k, resolve($k));
a2200 1
		#printf OUT "  Subdir: %7s  %4d  %s $CRLF", $s15{$l}, $status2, $url2;
d2261 2
a2262 3
    prntx('title', 'Exceedingly Long URLs');
    #print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
    #print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
d2268 6
a2273 6
	prntx('count',$s18{$k});
	prntx('status',$_[3]);
	prntx('length',$_[2]);
	prntx('url',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',resolve($_[1]));
a2279 1
    #$w->endTag('html');
d2370 1
a2370 1
    print STDERR $txt;
d2409 1
a2409 1
    print "$x\n";
d2412 1
a2412 1
	print "$x\n";
@


1.82
log
@Started to complete the XML-output routine.
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.81 2004/05/04 10:02:32 mibl Exp mibl $
$REVISION = '$Revision: 1.81 $';
d866 1
a866 1
	    $s13{"$ip¤$url"}++;
a1958 1
    #print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
a1959 1

d2086 1
a2086 1
    sumhash (\%s13);
d2091 1
a2091 3

    #printf OUT "%7s  %-15s %-12s $CRLF", 'Count', ,'IP', 'Referer' ;
    foreach $k (sort {$s13{$b} <=> $s13{$a}} keys %s13 )
d2093 2
a2094 2
	@@_ = split "&", $k;
	#printf(OUT "%7d  %-15s %-12s $CRLF",  $s13{$k},$_[0], $_[1]);
d2096 1
a2096 1
	$w->dataElement('count', $s13{$k});
d2098 1
a2098 1
	#$w->dataElement('referer', $_[1]);
d2138 2
a2139 4
    prntx('title', 'Suspected Cookie Manipulation');
    #print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
    #print OUT "This could inidicate attempted session hijacking,$CRLF";
    #print OUT "or users coming via a non-ip session aware proxy.$CRLF";
a2145 1
	
d2147 1
a2147 2
	    prntx('cookie', $co);
	    
d2150 3
a2152 3
	prntx('count', $s14{$k});
	prntx('srcip', $_[1]);
	prntx('fqdn', resolve($_[1]));
a2154 1
	
d2159 23
a2181 1
    
d2187 2
a2188 1
    prntx('title', 'Subdirectory Listing Attempts');
d2193 5
a2197 5
	prntx('count',$s15{$k});
	prntx('status',$_[2]);
	prntx('url',$_[1]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
d2202 26
d2234 2
a2235 1
    prntx('title', 'List suspected FORM manipulation');
d2240 4
a2243 4
	prntx('count',$s16{$k});
	prntx('query',$_[1]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
d2253 3
a2255 3
    prntx('title', 'Attempts to locate Proxy');
    #print OUT "Successfull attempts could indicate that your web server can$CRLF";
    #print OUT "be used for staging Internet Attacks and fraud.$CRLF";
d2260 5
a2264 5
	prntx('count', $s17{$k});
	prntx('status', $_[1]);
	prntx('url', $_[2]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
@


1.81
log
@Added progress inidicator option
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.80 2004/05/04 09:13:41 mibl Exp mibl $
$REVISION = '$Revision: 1.80 $';
d224 1
d1647 4
a1650 2
    $w = new XML::Writer(OUTPUT => $output, NEWLINES => 1);
    $w->doctype("report");
d1658 6
a1663 5
    prntx('version', $VERSION);
    prntx('logdatestart', $mindate);
    prntx('logdateend', $maxdate);
    prntx('title', "Security Log File Analysis");
    prntx('analysisstart', " " . localtime());
d1666 1
a1666 1
	prntx('file',$f);
d1670 8
a1677 8
    prntx('outputfile', $outfile);
    prntx ('execstart', $starttimetext);
    prntx ('execstop', localtime(). "");
    prntx ('rowsanalysed',$numlines);
    prntx ('nripaddr',$numip);
    prntx ('perf',  $numlines / (time - $starttime + 1));
    prntx ('nameresoff', $opt_N);
       
d1679 2
a1680 1
    $w->characters(prntx('title','Logformats'));
d1684 2
a1685 2
	prntx ("format", $x);
	prntx ("nrfound", $logformat{$x});
d1695 1
a1695 1
    prntx("rowsanalysedpersec", $numlines / (time - $starttime + 1));
d1699 3
a1701 2
   $w->startTag("hitsperhour");
    prntx('title','Hits per hour');
a1705 1
    #print "<rec>\n";
d1713 2
a1714 2
	prntx('hour',$_[0]);
	prntx('hits',$hits);
d1727 2
a1728 2
    prntx('title', 'Successful attempts to retrieve Dangerous files');
    prntx('desc', 'This could inidicate a serious security breach.');
d1735 3
a1737 3
	prntx('count',$s3{$k});
	prntx('srcip',$_[0]);
	prntx('url',$_[1]);
a1741 1

d1746 5
a1750 2
    $w->startTag("unauthorized", 'total' => $sum, 'uniq' => $uniq);
    prntx('title', 'Users who have accessed protected page');
d1755 5
a1759 5
	prntx('count',$s2{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[1]);
	prntx('user',$_[3]);
	prntx('url',$_[2]);
d1769 2
a1770 1
    prntx('title','Logged in users');
d1777 2
a1778 2
	prntx('user',$_[0]);
	prntx('count', $s10{$k});
d1788 3
a1790 2

    prntx('title', 'Logged in user per IP-address');
d1795 4
a1798 4
	prntx('count',$s1{$k});
	prntx('user',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',$sip{$_[1]});
d1807 2
a1808 1
    prntx('title','Statuscodes');
d1813 3
a1815 3
	prntx('count',$s5{$k});
        prntx('status',$_[0]);
        prntx('statusname',$STATCODE{$_[0]});
a1818 2
    

d1823 2
a1824 1
    prntx('title', 'List of HTTP methods found');
d1829 2
a1830 2
	prntx('count',$s19{$k});
	prntx('method',$k);
d1842 2
a1843 1
    prntx('title', 'Count of HTTP-verssions');
d1848 2
a1849 2
	prntx('count',$s6{$k});
	prntx('version',$_[0]);
d1859 2
a1860 1
    prntx('title', 'Invalid HTTP-versions');
d1865 4
a1868 4
	prntx('count',$s61{$k});
	prntx('httpstr',$_[0]);
	prntx('srcip',$_[2]);
	prntx('fqdn',resolve($_[2]));
d1878 2
a1879 1
    prntx('title', 'List of Top Hitters');
d1884 4
a1887 4
	prntx('rank',$xx);
	prntx('count',$iptab{$k});
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
d1900 2
a1901 1
    prntx('title', 'Access attempts generating 4xx errors');
d1908 2
a1909 2
	prntx('count',$s01{$k});
	prntx('httpstatus',$_[0]);
d1911 1
a1911 1
	prntx('url',$_[1]);
d1922 2
a1923 2
    prntx('title', 'Top 4xx errors per IP');
    foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
d1927 4
a1930 4
	prntx('rank',$xx);
	prntx('count',$s02{$k});
	prntx('srcip',$_[0]);
	prntx('fqdn',$sip{$_[0]});
d1941 2
a1942 3
    prntx('title', 'Top 4xx errors per IP and URL');
    #print OUT "This could inidicate either faultly links on your site, or$CRLF";
    #print OUT "a perpetrator looking for vulnerabilities.$CRLF";
d1947 4
a1950 4
	prntx('rank',$xx);
	prntx('count',$s0{$k});
	prntx('srcip',$_[0]);
	prntx('url',$_[1]);
d1963 2
a1964 1
    prntx('title', 'Top 5xx errors per IP');
a1965 4
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "This could indicate various attempts to cause your web server$CRLF";
    #print OUT "to produce erronous results.$CRLF";  
    
d1970 4
a1973 4
	prntx('count',$s42{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',$sip{$_[1]});
d1987 2
a1988 1
    prntx('title', 'Top 5xx errors per URL');
d1995 3
a1997 3
	prntx('count',$s4{$k});
	prntx('status',$_[0]);
	prntx('url',$_[1]);
d2009 2
a2010 3
    prntx('title', 'Top 5xx errors per IP and URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
d2015 4
a2018 4
	prntx('count',$s41{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[2]);
	prntx('url',$_[1]);
d2025 30
d2063 2
a2064 1
    prntx('title', 'Top Referers');
a2069 1
	#$xy = $_[0];
d2077 3
a2079 5
	#$xy =~ s/\?.*//i;
	#printf(OUT "  <refstr count=\"%d\"  refurl=\"%s\" refuri=\"%s\" />\n",  $s11{$k}, $urlstr, $uristr );
	prntx('count',$s11{$k});
	prntx('refurl',$urlstr);
	prntx('refuri',$uristr);
d2084 8
a2091 1
        
d2093 25
d2122 2
a2123 1
    prntx('title', 'Top Browsers used');
d2128 2
a2129 2
	prntx('count',$s12{$k});
	prntx('browser',uri_escape($_[0]));
d2259 1
a2259 1
}
d2280 1
a2280 1
}
d2291 1
a2291 1
}
d2311 1
a2311 1
}
@


1.80
log
@Added list with Blank Referers
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.79 2004/05/04 07:26:51 mibl Exp mibl $
$REVISION = '$Revision: 1.79 $';
d102 1
a102 1
getopts('mWhvNpsXoC:');  
d394 7
d2273 4
a2276 3
    open DBG, ">>/tmp/secsrch.dbg";
    print DBG @@_;
    close DBG;
@


1.79
log
@Some fixes...
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.78 2003/11/24 22:07:48 mibl Exp mibl $
$REVISION = '$Revision: 1.78 $';
d772 3
a774 1
	if ($sip{$ip} eq undef) {	$sip{$ip} = resolve($ip) };
d857 3
d1388 27
d1512 1
a1512 1
	    printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
d1516 1
a1516 1
		printf(OUT "%7d %7s %-40s %-15s %s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
d1537 1
a1537 1
		foreach $l (keys %s15) {
@


1.78
log
@Fixed logic errors when printing output
@
text
@d2 3
a4 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.77 2003/11/23 19:48:30 mibl Exp mibl $
$REVISION = '$Revision: 1.77 $';
d29 1
d68 1
a68 1

d1597 2
@


1.77
log
@fix
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.76 2003/11/23 19:40:13 mibl Exp mibl $
$REVISION = '$Revision: 1.76 $';
d1150 1
a1150 3
    

    
d1170 1
a1170 1
    if (($uniq eq 0) && (! defined $opt_m)) {
d1272 1
a1272 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1334 1
a1334 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1390 1
a1390 1
    if ($uniq > 0 ) {
d1404 2
a1405 2
    sumhash(\%s41);
    if (($uniq eq 0) && (!defined $opt_m)) {
d1446 1
a1446 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1468 1
a1468 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1491 1
a1491 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1519 1
a1519 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1544 1
a1544 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1571 1
a1571 1
    if (($uniq eq 0) && (!defined $opt_m)) {
@


1.76
log
@Changed logic-fault which inhibited logged in users from being printed
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/slac/RCS/secsrch.pl,v 1.75 2003/10/21 09:59:21 mibl Exp mibl $
$REVISION = '$Revision: 1.75 $';
d783 1
a783 1
	print "$user: $s10{$user}\n";
@


1.75
log
@Addes support for Mikes Apache log with sitename after IP in logfile.
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/secsrch/RCS/secsrch.pl,v 1.74 2003/10/19 06:50:49 mibl Exp mibl $
$REVISION = '$Revision: 1.74 $';
d775 1
d783 1
d1062 2
a1063 2
    sumhash(\%s10);
    if (($uniq eq 0) && (!defined $opt_m)) {    
d1086 4
d1094 1
a1094 1
    if (($uniq eq 0) && (!defined $opt_m)) {
d1172 1
a1172 1
    if (($uniq eq 0) && (!defined $opt_m)) {
@


1.74
log
@-m now removes report entries with no information (i.e. 'None' before)
@
text
@d2 2
a3 2
# $Header: /home/mibl/Dev/secsrch/RCS/secsrch.pl,v 1.73 2003/10/19 06:05:45 mibl Exp mibl $
$REVISION = '$Revision: 1.73 $';
d603 53
d997 1
a997 1
	print OUT "$desctxt\n";
d1019 1
a1019 1
	    print OUT $desctxt;
d1033 1
a1033 1
	    printf OUT "$CRLF None. $CRLF";
@


1.73
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.72 2003/08/08 11:54:27 mibl Exp mibl $
$REVISION = '$Revision: 1.72 $';
d48 3
d65 1
a65 1
$VERSION = '2.38';
d100 1
a100 1
getopts('WhvNpsXoC:');  
d110 1
d220 24
a243 8
    print "SecSrch version $VERSION$CRLF";
    print "Useage: [cat\|type] \<infile\> \| [perl] secsrch.pl \- [outfile]\n";
    print "or      [perl] secsrch.pl [\-Nvhs] <infile> [outfile]$CRLF";
    print "or      [perl] secsrch.pl [\-Nvhs] \'<infile\*.gz>\' [outfile]$CRLF$CRLF";
    print "or      [perl] secsrch.pl [\-Nvhs] \'<infile\*.gz>\' [outdir]$CRLF$CRLF";
    print "If \-N is used, Name resolution will not be performed. $CRLF";
    print "If \'\-\' is used for <infile>, STDIN will be used for input.$CRLF";
    print "If \'\-\' is used for <outfile>, STDOUT will be used for output.$CRLF$CRLF";
d961 7
a967 5
    print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This could indicate successful attempts to retrieve sensitive files, or possibly execute system commands in the server.";
        print OUT $desctxt;
    }
d969 12
a980 9
    sumhash (\%s3);
    if ($uniq gt 0) {
	print OUT "This could inidicate a serious security breach.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
	foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
	{
	    @@_ = split "¤", $k;
	    printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k},$_[0], $_[1]);
a981 2
    } else {
	printf OUT "None. $CRLF";
a982 1

d985 18
a1002 13
    print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "This shows all users who have accessed password protected pages. Users whi repeatedly access the same page could indicate password brute force attempts.";  
	printf OUT "$desctxt\n";
    }
    sumhash (\%s2);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT  "%7s  %5s  %-15s  %-9s %s$CRLF", 'Count', 'Status', 'Src IP', 'User', 'URL';
	foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT  "%7d  %5s   %-15s  %-9s %s$CRLF",  $s2{$k},$_[0], $_[1], $_[3], $_[2]);
a1003 2
    } else {
	printf OUT "None. $CRLF";
d1006 7
a1012 15
    
    print OUT "$CRLF********** Logged in Users **********$CRLF";
    if ($pdesc eq 1) {
        $desctxt = "Lists all users who have successfully logged in. Verify that the users are valid.";
        printf OUT "$desctxt\n";
    }
    
    sumhash (\%s10);
    if ($uniq gt 0) {   
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
	foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9d  %-15s$CRLF",  $s10{$k},$_[0]);
d1014 10
a1023 3
    } else {
	if ($userundef gt 0) {
	    printf OUT "Not Available - not logged in log file.$CRLF";
d1025 5
a1029 1
	    printf OUT "None. $CRLF";
a1032 5
    print OUT "$CRLF********** Logged in users per IP-address (excl Anonymous) **********$CRLF";
    if ($pdesc eq 1) {
	$desctxt = "Shows the source IP-addresses of successful logins. Make sure all addresses are valid or can be derived.";
	print OUT "$desctxt\n";
    }
d1034 23
a1056 8
    sumhash (\%s1);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%9s  %-15s  %-15s  %s$CRLF",  'Count', 'User', 'Src-IP', 'FQDN';
	foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
	{
	    @@_ = split "¤", $k;
	    printf OUT "%9d  %-15s  %-15s  %s$CRLF",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
a1057 6
    } else {
	if ($userundef gt 0) {
            printf OUT "Not Available - not logged in log file.$CRLF";
        } else {
            printf OUT "None. $CRLF";
        }
d1059 1
a1059 1
    
d1088 1
a1088 1
        @@_ = split "¤", $k;
d1090 2
a1091 2
}

d1112 19
a1130 14
    print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This list all requests done without a valid HTTP versoin. This could indicate attempts to connect via telnet or other tcp based mechanism, usually indicating reconnosaince. Keep an eye on addresses in this list.";
        print OUT "$desctxt\n";
    }

    sumhash (\%s61);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s %-25s %-15s %s %-s$CRLF", 'Count' , 'HTTP String',  'IP', 'FQDN');
	foreach $k (sort {$s61{$b} <=> $s61{$a}} keys %s61 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[1], resolve($_[1]));
a1131 2
    } else {
	printf OUT "None. $CRLF";
d1214 3
a1216 21
    print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "Errors generated here are on the server. This could either be manipulation attempts, or excessive database access. Or just a misconfiguration of the web server.";
	print OUT "$desctxt\n";
    }

    sumhash (\%s42);
    if ($uniq > 0) {
	$xx = 1;
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
	foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-15s %s$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	    if ($xx++ == $topmax) { last; }
	}
   
    
	# 5xx Status
	print OUT "$CRLF********** Top $topmax URL\'s causing Server Errors (5xx) ********** $CRLF";
d1218 1
a1218 1
	    $desctxt = "Errors generated here are on the server. This could either be manipulation attempts, or excessive database access. Or just a misconfiguration of the web server. If the same URL is causing the errors, this might indicate the source of the problem. Or possibly a security breach.";
d1222 49
a1270 26
	$xx = 1;
	sumhash (\%s4);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
	foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-20s$CRLF",  $s4{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
	if ($pdesc eq 1) {
            $desctxt = "Is any single IP using a specific URL to wreak havoc on your web server?";
            print OUT "$desctxt\n";
        }

	$xx = 1;
	sumhash (\%s41);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
	foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-15s  %s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
	    if ($xx++ == $topmax) { last; }
a1271 2
    } else {
        printf OUT "None. $CRLF";
a1275 6
    print OUT "$CRLF********** URL's containing binary data ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "This is a no-no. Anything listed here should not happen under normal circumstances, since binary data is not allowed in a URL. It should always be encoded in some way. Entries gere could indicate attempts to cause buffer overflows and security breaches. There is a possible false positive with some obscure browsers sending odd binary data, but it is not common. Check these IPs!";
	print OUT "$desctxt\n";
    }
    
d1277 19
a1295 10
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
        printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
        foreach $k (sort {$s45{$b} <=> $s45{$a}} keys %s45 )
        {
            @@_ = split "\#\#", $k;
            printf (OUT "%7d  %-15s  %-50s$CRLF",  $s45{$k},$_[0], $_[1]);
        }
    } else {
        printf OUT "None Found. $CRLF";
d1297 1
a1297 1
 
d1347 24
a1370 22
    $xx = 1;
    print OUT "$CRLF********** Same Cookie from different IP-addresses ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This could inidicate attempted session hijacking (unlikely, but serious), or users coming via a non-ip session aware proxy (likely, and not so serious).";
        print OUT "$desctxt\n";
    }

    sumhash (\%s14);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
	printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
	#foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
	$old = '';
	foreach $k (sort keys %s14)
	{
	    #print "\$k: $k\n";
	    @@_ = split "¤", $k;
	    #print "\$_\[0\]:$_[0]$CRLF";
	    if ($old ne $_[0]) {
		print OUT "$CRLF";
		#$co = $cookie;
		$co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
d1372 12
a1383 1
		printf OUT "Cookie: %s$CRLF", $co;
a1384 4
	    printf OUT "%9d %-15s %s$CRLF", $s14{$k}, $_[1], resolve($_[1]);
	    
	    $old = $_[0];
	    #if ($xx++ == $topmax) { last; }
a1385 7
    } else {
	if ($cookieundef gt 0) {
            printf OUT "Not Available - not logged in log file.$CRLF";
        } else {
            printf OUT "None. $CRLF";
        }
	
d1388 18
a1405 13
    print OUT "$CRLF********** Cross Site Scripting Attempts per IP *********$CRLF";
    if ($pdesc eq 1) {
	$desctxt = "Anything listed here could indicate Cross Site Scripting attempts. If successfull, they could allow stealing of your users credentials, and thus alleviating unauthorized access. Successfull attempts listed here must be examined further.";
	print OUT "$desctxt\n";
    }
    sumhash (\%s21);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s %-15s %-40s %-15s$CRLF", 'Count', 'IP', 'URL', 'FQDN';
	foreach $k (sort {$s21{$b} <=> $s21{$a}} keys %s21)
	{
	    ($ip, $url) = split "¤", $k;
	    printf OUT "%7d %-15s %-40s %-15s$CRLF",  $s21{$k}, $ip, $url, resolve($ip);
a1406 2
    } else {
        print OUT "None found.$CRLF";
a1408 1

d1410 21
a1430 18
    $xx = 1;
    print OUT "$CRLF********** Unsuccessful Subdirectory Listing Attempts ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "This indicates reconnosaince buy attempting to list subdirectories of the site. The perpetrator is presumably looking for misconfigured default pages or trying to view source code.";
    }
    sumhash (\%s15);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        #print OUT "This could inidicate attempted session hijacking.$CRLF";
        printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %7s %-40s %-15s %s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
	print OUT "None found.$CRLF";
d1433 18
a1450 17
    
    
    print OUT "$CRLF********** Unsuccessful Subdir attempts per IP ********$CRLF";
    if ($pdesc eq 1) {
        $desctxt = "If the Top IP's generate errors on many subdirectories, it is a probable attempted (and possibly succeeded) reconnossaince sweep.";
	print OUT "$desctxt\n";
    }

    sumhash (\%s151);
    if (uniq gt 0) {
	foreach $k (sort {$s151{$b} <=> $s151{$a}} keys %s151) 
	{
	    printf(OUT "Count: %-10s IP: %-15s %s$CRLF", $s151{$k}, $k, resolve($k));
	    foreach $l (keys %s15) {
		($ip2, $url2, $status2) = split "¤", $l;
		if ($ip2 eq "$k") {
		    printf OUT "  Subdir: %7s  %4d  %s $CRLF", $s15{$l}, $status2, $url2;
d1452 5
a1456 5
	    }
	    print OUT "$CRLF";
	} 
    } else {
	print OUT "None found.$CRLF";
d1461 23
a1483 5
    $xx = 1;
    print OUT "$CRLF********** Suspected Form Data Manipulation ********** $CRLF";
    if ($pdesc eq 1) {
	$desctxt = "This is basically only valid of the site has a database which can be accessed via SQL. It could indicate attempts to manipluate queries to your database, but could also be a false positive. Needs verification to rule out unauthorized access.";
	printf OUT "$desctxt\n";
d1486 23
a1508 35
    sumhash (\%s16);		     
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "This could inidicate attempted unauthorized database access.$CRLF";
        printf OUT "%7s %-30s %-15s %-15s %-20s$CRLF", 'Count', 'Query', 'IP', 'FQDN' ;
        foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %-30s %-15s %-15s$CRLF",  $s16{$k}, $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }
    
    # List attempted Anonymous Proxy Scans
    $xx = 1;
    print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This indicates attempts to locate and possibly use the site to stage further attacks. If the proxy attempts are successful, the site could be used to relay spam or participate in illegitimate activities.";
        printf OUT "$desctxt\n";
    }
    
    sumhash (\%s17);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'Request', 'IP', 'FQDN';
        foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6d %-40s %-15s %s$CRLF",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
d1510 1
d1513 21
a1533 16
    $xx = 1;
    print OUT "$CRLF********** Exceedingly Long URL's ********** $CRLF";
    if ($pdesc eq 1) {
        $desctxt = "This indicates attempts to locate and possibly execute a buffer overflow. If sucessful a perpetrator could have full system access. This in not common, but rather there are long URL's on the site which falsely trigger this.";
        printf OUT "$desctxt\n";
    }

    sumhash (\%s18);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
        foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6s %10s  %-30s\n%26s %-15s %s $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] ,'', $_[1], resolve($_[1]));
	    if ($xx++ == $topmax) { last; }
a1534 2
    } else {
	print OUT "None found.$CRLF";
@


1.72
log
@Added Revision into variable.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.71 2003/08/08 11:52:30 mibl Exp mibl $
$REVISION = '$Revision: 1.71 $';
d120 1
a233 1

d380 11
@


1.71
log
@Changed automatic prefix of filename to SLAC..
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.70 2003/08/05 05:45:18 mibl Exp mibl $
# $Revision: 1.70 $
d851 1
a851 1
    print OUT "SLAC v $VERSION   $SITE$SITE_DIR $CRLF$CRLF";
@


1.70
log
@Fixed Misspelled variable name.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.69 2003/07/11 19:35:32 mibl Exp mibl $
# $Revision: 1.69 $
d258 1
a258 1
	    $outfile = $outfile . '/SecSrch.Multi.' . $1 . '.log';
d261 1
a261 1
		$outfile = 'SecSrch.Multi.' . $1 . '.log';
d269 1
a269 1
	    $outfile = 'SecSrch.' . $1 . '.log';
d273 1
a273 1
	    $outfile = $outfile . '/SecSrch.' . $1 . '.log';	
@


1.69
log
@Small fix
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.68 2003/07/03 11:48:10 mibl Exp mibl $
# $Revision: 1.68 $
d1382 1
a1382 1
    sumhash (\%151);
@


1.68
log
@Added -p support
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.67 2003/06/29 20:50:28 mibl Exp mibl $
# $Revision: 1.67 $
d7 1
a7 1
# Perl script to parse Webserver logfiles, and search for
d19 2
d38 1
a38 1
# 2002-05-22 2.27 Started rework for 'logger' funktion
d44 4
a47 3
# 2003-03-22 2.32 Also added XML output...
# 2003-06-02 2.35 Added XML again... !
# 2003-06-29 2.37 Added XSS scripting attmpts
d57 1
a57 1
# Look for any delays in traffic (log times without any hits) - To locate succesful DoS
a65 8
 

#$y = "kelle/hej.asp?du=jag&hen=nu&bu=na";
#print urlencode($y) . "\n";
#open OUT, ">&STDOUT";
#prntx ('kalle','kula','ruta');

#exit;
a91 1

d108 1
a108 1
slog("CustomLog Opts: $opt_C $opt_p);
d111 1
a111 1
    $CRLF = "<br>\n";
@


1.67
log
@Added descriptive text for eaxh report section.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.66 2003/06/29 08:27:35 mibl Exp mibl $
# $Revision: 1.66 $
d114 2
a115 1
slog("CustomLog Opts: " . $opt_C);
a672 1
    #print "making $url\n";
a673 1
    #$numlines++;
d685 1
a685 1
    if (($status =~ m/404|403|406/))
a698 1
	    #print "\:$user\:\n";
a701 1
	    #print "$_\n";
a702 1

d823 2
a824 1
    if (($url =~ m/^[\w]+?\s+HTTP[s]*\:/i) || ($url =~ m/^connect/i)) {
d826 1
a826 1
	$s17{"$ip¤$status¤$url"}++;
d1392 1
a1392 1
	    printf(OUT "Count: %-10s IP: %-15s$CRLF", $s151{$k}, $k);
d1440 1
a1440 1
        printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
@


1.66
log
@Updated to version 2.37...
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.65 2003/06/29 08:25:41 mibl Exp mibl $
# $Revision: 1.65 $
d57 1
d59 1
a59 1
$VERSION = '2.37';
d103 1
a103 1
getopts('WhvNsXoC:');  # If set, then don't do a name lookup
d112 1
d119 3
d920 1
a920 1
    if (pdesc eq 1) {
d922 1
a922 1
	print OUT $desctxt;
a937 2


d940 5
d962 4
d981 5
d1004 5
d1028 4
d1045 4
d1062 5
d1079 5
a1085 1
	print OUT "This could inidicate attempts to manipulate and compromise the webserver.$CRLF";
d1101 5
d1120 5
a1124 1
    
d1136 5
a1143 1
	print OUT "The top IP's on this list could be the source for vulnerability scans of your  site.$CRLF";
d1154 4
d1178 5
a1186 2
	print OUT "This could indicate various attempts to cause your web server$CRLF";
	print OUT "to produce erronous results.$CRLF";  
d1198 5
d1215 5
d1237 5
d1244 1
a1244 3
        print OUT "This could indicate attempts to cause a Denial of Service or$CRLF";
	print OUT "someone trying to breaking in.$CRLF";
        print OUT "Totally $sum and $uniq unique.$CRLF";
d1252 1
a1252 1
        printf OUT "None. $CRLF";
a1253 4




d1258 5
d1283 6
a1288 1
    print OUT "$CRLF********** Browsers ********** $CRLF";      
d1306 5
a1313 2
	print OUT "This could inidicate attempted session hijacking,$CRLF";
	print OUT "or users coming via a non-ip session aware proxy.$CRLF";
d1344 4
d1351 1
a1351 1
	printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
d1355 1
a1355 1
	    printf OUT "%7d %7s %-40s %-15s %s$CRLF",  $s21{$k}, $ip, $url, resolve($ip);
d1365 3
d1386 5
a1408 1

d1412 6
a1417 1
    sumhash (\%s16);
d1435 5
a1442 2
        print OUT "Successfull attempts could indicate that your web server can$CRLF";
	print OUT "be used for staging Internet Attacks and fraud.$CRLF";
d1457 5
a1464 2
        print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
        print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
@


1.65
log
@Addes check for <SCRPIT in url  - to locate attempted
Cross site scripting
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.64 2003/06/22 20:12:14 mibl Exp mibl $
# $Revision: 1.64 $
d44 1
a56 1
# Add detection of '<script' in URL to detect XSS attempts
d58 1
a58 1
$VERSION = '2.36';
@


1.64
log
@Updated version to 2.36
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.63 2003/06/22 20:11:20 mibl Exp mibl $
# $Revision: 1.63 $
d56 1
a56 1
#
d201 3
d205 2
d603 1
a603 1
		\s(.+)         # Virtual Server
d836 5
d1262 15
d1291 9
a1299 3


	print OUT "$CRLF********** Unsuccessful Subdir attempts per IP ********$CRLF";
d1307 1
a1307 2
		    
		} 
d1310 1
a1310 2
	}

d1312 1
a1312 1
        print OUT "None found.$CRLF";
d1334 1
a1334 1

d2047 14
@


1.63
log
@Fixed few things. Added SITE header.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.62 2003/06/10 14:10:23 mibl Exp mibl $
# $Revision: 1.62 $
d58 1
a58 1
$VERSION = '2.35';
@


1.62
log
@XML Output works. Now needs final adjustments and fixes.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.61 2003/06/02 18:54:21 mibl Exp mibl $
# $Revision: 1.61 $
d190 4
d368 1
d596 47
d645 1
d648 1
a648 1
	    #print;
d667 1
a667 1
    if ((length $url) > 250 ) {
d828 1
d845 1
a845 1
    print OUT "SLAC v $VERSION$CRLF$CRLF";
d894 3
a896 3
	print OUT "Servers analyzed:          Rows$CRLF";
	foreach $x (keys %s20 ) {
	    printf OUT "  %-20s %9d$CRLF", $x, $s20{$x};
d1354 1
a1354 3
    $w->doctype("html");
    $w->startTag("html", 'version' => '1.0');

a1355 1
    #print OUT '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' . "\n";
d1361 15
a1375 23
    #print OUT "<report version=\"$VERSION\" logdatestart=\"$mindate\" logdateend=\"$maxdate\">\n";
    
    $w->startTag("report", 
		 "version" => $VERSION, 
		 "logdatestart" => $mindate,
		 "logdateend" => $maxdate);

    $w->startTag("title");
    $w->characters("Security Log File Analysis");
    $w->endTag("title");

    $w->startTag("inputfile");
    $w->characters(join (" ",@@list));
    $w->endTag("inputfile");

    #print OUT "<outputfiles>$outfile</outputfiles>\n";
    
    $w->startTag("outputfile");
    $w->characters($outfile);
    $w->endTag("outputfile");

    prntx ("execstart", $starttimetext);
    prntx ("execstop", localtime(). "");
d1381 1
a1381 1
    $w->startTag("logformats");
a1422 1

a1425 1
    #print OUT "<dangerousfiles total=\"$sum\" uniq=\"$uniq\">\n";
d1429 3
a1431 3
    prntx('title','Successful attempts to retrieve Dangerous files');
    #print OUT "This could inidicate a serious security breach.$CRLF";
    #print OUT "Totally $sum and $uniq unique.$CRLF";
d1885 1
a1885 1
	$w-endTag('rec');
d1891 1
a1891 1
    $w->endTag('html');
d1895 1
@


1.61
log
@Added XML 'printxml' sub. Needs alot of modifications...
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.60 2003/06/02 18:25:53 mibl Exp mibl $
# $Revision: 1.60 $
d96 4
d1296 9
a1304 1
    print OUT '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' . "\n";
d1310 1
a1310 1
    print OUT "<report version=\"$VERSION\" logdatestart=\"$mindate\" logdateend=\"$maxdate\">\n";
d1312 18
a1329 1
    print OUT "<reporttitle>Security Log File Analysis</reporttitle>\n";
a1330 3
    print OUT "<inputfiles>" . join (" ",@@list) . "</inputfiles>\n";
    print OUT "<outputfiles>$outfile</outputfiles>\n";
    #print OUT "<stats execstart=\"$starttimetext\" execstop=\"" . localtime();
d1338 2
a1339 13
    #print OUT "\" rowsanalysed=\"$numlines\" nripaddr=\"$numip\" perf=\"";
    #print OUT $numlines / (time - $starttime + 1) . "\" ";
    #print OUT "nameresoff=\"$opt_N\">\n";
    #print OUT "Outputfile: $outfile $CRLF";
    #print OUT "<executionstart>" . $starttimetext . "</executionstart>\n";
    #print OUT "<executionstop>" . localtime() . "<executionstop>\n";
    #printf OUT "<analyzedrows>%d</analyzedrows>\n", $numlines;
    #printf OUT "nr of non-analyzed rows:    %7d $CRLF", $logformat{'UNKNOWN'};
    #printf OUT "<nrofipaddresses>%d</nrofipaddresses>\n", $numip;
    #printf OUT "<performance>" . $numlines / (time - $starttime + 1) . "</performance>\n";
    #print OUT "</stats>\n";
    print OUT "<logformats>\n";
    prntx('title','Logformats');
d1342 1
a1342 3
	print OUT "  <rec>\n";
	#printf OUT "  <logformat format=\"%s\" nrfound=\"%d\" />\n", $x, $logformat{$x};
	#print OUT "<logformat>\n";
d1345 1
a1345 2
	#print OUT "</logformat>\n";
	print OUT "  </rec>\n";
d1348 2
a1349 1
    print OUT "</logformats>\n\n";
d1354 2
a1355 6
    #printf OUT "nr of $logformat{'CLF'}\n";
    
    #if ($opt_N ne '') 
    #{  print OUT "<nameresolution>Off</nameresolution>\n"; }
    #else
    #{  print OUT "<nameresolution>On</nameresolution>\n"; }
d1358 1
a1358 1
    print OUT "<hitsperhour>\n";
d1371 1
a1371 1
	print OUT "  <rec>\n";
d1374 1
a1374 1
	print OUT "  </rec>\n";
d1377 1
a1377 1
    print OUT "</hitsperhour>\n\n";
d1384 4
a1387 2
    print OUT "<dangerousfiles total=\"$sum\" uniq=\"$uniq\">\n";

d1395 1
a1395 1
	print OUT "<rec>\n";
d1399 1
a1399 4
	print OUT "</rec>\n";
	#print OUT "<dangerousfile count=\"$s3{$k}\" srcip=\"$_[0]\" url=\"$_[1]\"/>\n";
	
	#printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k}, $_[0], $_[1]);
d1401 3
a1403 1
    print OUT "</dangerousfiles>\n\n";
d1408 1
a1408 1
    print OUT "<unauthorized total=\"$sum\" uniq=\"$uniq\">\n";
d1413 1
a1413 2
	#print OUT "<entry>\n";
	print OUT "  <rec>\n";
d1419 1
a1419 3
	print OUT "  </rec>\n";
	#printf OUT " <unauthorized_user count=\"%s\" status=\"%s\" srcip=\"%s\" user=\"%s\" url=\"%s\"/>\n", $s2{$k},$_[0], $_[1], $_[3], $_[2];
	#print OUT "</entry>\n";
d1421 1
a1421 2
    
    print OUT "</unauthorized>\n\n";
d1427 1
a1427 1
    print OUT "<logged_in_users total=\"$sum\" uniq=\"$uniq\">\n";
d1434 1
a1434 1
	print OUT "  <rec>\n";
d1437 2
a1438 2
	print OUT "  </rec>\n";
	#printf(OUT " <loggedinuser count=\"%d\" user=\"%s\"/>\n",  $s10{$k}, $_[0]);	
d1440 1
a1440 1
    print OUT "</logged_in_users>\n\n";
d1445 2
a1446 1
    print OUT "<logged_in_users_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
d1451 1
a1451 1
	print OUT "  <rec>\n";
d1456 1
a1456 2
	print OUT "  </rec>\n";	
	#printf OUT " <userperip count=\"%d\" user=\"%s\" srcip=\"%s\" fqdn=\"%s\"/>\n",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
d1458 1
a1458 1
    print OUT "</logged_in_users_per_ip>\n\n";
d1463 1
a1463 1
    print OUT "<statuscodes total=\"$sum\" uniq=\"$uniq\">\n";
d1468 2
a1469 2
        print OUT "  <rec>\n";
        prntx('count',$s5{$k});
d1472 1
a1472 5
        print OUT "  </rec>\n";
	
        #printf(OUT "<codes count=\"%d\" status=\"%s\" statusname=\"%s\"/>\n" ,$s5{$k}, $_[0], $STATCODE{$_[0]});
	
        #print OUT "</entry>\n";
d1474 2
a1475 1
    print OUT "</statuscodes>\n\n";
d1480 1
a1480 1
    print OUT "<httpmethods total=\"$sum\" uniq=\"$uniq\">\n";
d1485 1
a1485 1
	print OUT "  <rec>\n";
d1488 1
a1488 2
	print OUT "  </rec>\n";
	printf(OUT "  <method count=\"%d\" methodstr=\"%s\"/>\n",  $s19{$k}, $k,);
d1490 2
a1491 2
    print OUT "</httpmethods>\n\n";	

d1498 1
a1498 1
    print OUT "<httpversions total=\"$sum\" uniq=\"$uniq\">\n";
d1503 1
a1503 1
	print OUT "  <rec>\n";
d1506 1
a1506 3
        print OUT "  </rec>\n";
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	#printf(OUT "  <version count=\"%d\" versionstr=\"%s\"/>\n",  $s6{$k}, $_[0]);
d1508 2
a1509 2
    print OUT "</httpversions>\n\n";
    
d1514 1
a1514 1
    print OUT "<illegalhttp total=\"$sum\" uniq=\"$uniq\">\n";
d1519 1
a1519 1
	print OUT "  <rec>\n";
d1524 1
a1524 2
	print OUT "  </rec>\n";
	#printf(OUT "<badhttp count=\"%s\" httpstr=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
d1526 1
a1526 1
    print OUT "</illegalhttp>\n\n";
d1532 1
a1532 1
    print OUT "<tophitters total=\"$sum\" uniq=\"$uniq\">\n";
a1533 5
    #print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
    #sumhash (\%iptab);
    #print OUT ($uniq >= $topmax) ? $topmax : $uniq;
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
d1537 1
a1537 1
	print OUT " <rec>\n";
d1542 2
a1543 2
	#printf(OUT "  <hitter rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n", $xx, , $iptab{$k},$_[0], resolve($_[0]));
	print OUT "  </rec>\n";
d1546 3
a1548 1
    print OUT "</tophitters>\n\n";
d1551 1
a1551 1
    #print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
d1553 1
a1553 1
    print OUT "<errors4xx total=\"$sum\" uniq=\"$uniq\">\n";
d1560 1
a1560 1
	print OUT "  <rec>\n";
d1565 1
a1565 2
	#printf(OUT "  <error4xx count=\"%d\" httpstatus=\"%d\" url=\"%s\" />\n",  $s01{$k}, $_[0], uri_escape($_[1]));
	print OUT " </rec>\n";
d1568 1
a1568 1
    print OUT "</errors4xx>\n\n";
d1574 1
a1574 1
    print OUT "<top4xxerrorsperip total=\"$sum\" uniq=\"$uniq\">\n";
d1579 1
a1579 4

	#printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	#printf(OUT "  <top4xxerror rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	print OUT "  <rec>\n";
d1584 1
a1584 1
	print OUT " </rec>\n";	
d1587 1
a1587 2
    
    print OUT "</top4xxerrorsperip>\n\n";
d1593 1
a1593 1
    print OUT "<top4xxerrorsperipurl total=\"$sum\" uniq=\"$uniq\">\n";
a1594 1
    #print OUT "Totally $sum and $uniq unique.$CRLF";
a1596 1
    #printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
d1600 1
a1600 2
	print OUT "  <rec>\n";
	#printf(OUT "  <top4xxerroripurl rank=\"%d\" count=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $xx, $s0{$k},$_[0], $_[1]);
d1606 1
a1606 1
	print OUT "  </rec>\n";
d1609 3
a1611 3
    print OUT "</top4xxerrorsperipurl>\n\n";
	
        
d1616 1
a1616 1
    print OUT "<top_5xx_errors_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
d1622 1
a1622 1
    #printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
d1626 1
a1626 2
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerrors count=\"%d\" status=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
d1631 1
a1631 1
	print OUT "  </rec>\n";
d1635 2
a1636 1
    print OUT "</top_5xx_errors_per_ip>\n\n";
d1643 1
a1643 1
    print OUT "<top_5xx_errors_per_url total=\"$sum\" uniq=\"$uniq\">\n";
d1650 1
a1650 2
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerrorurl count=\"%d\" status=\"%d\" url=\"%s\" />\n",  $s4{$k},$_[0], $_[1]);
d1654 1
a1654 1
	print OUT "  </rec>\n";
d1657 1
a1657 2
    print OUT "</top_5xx_errors_per_url>\n\n"; 

d1659 1
d1664 1
a1664 1
    print OUT "<top_5xx_errors_per_ip_url total=\"$sum\" uniq=\"$uniq\">\n";  
d1671 1
a1671 2
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerroripurl count=\"%d\" status=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $s41{$k},$_[0], $_[2], $_[1]);
d1676 1
a1676 2
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
d1679 2
a1680 1
    print OUT "</top_5xx_errors_per_ip_url>\n\n"; 
d1689 1
a1689 1
    print OUT "<topreferers total=\"$sum\" uniq=\"$uniq\">\n";
a1690 1

d1694 2
a1695 1
	print OUT "  <rec>\n";
d1709 1
a1709 1
	print OUT "  </rec>\n";
d1712 2
a1713 2
    print OUT "</topreferers>\n\n"; 

d1718 1
a1718 1
    print OUT "<topbrowsers total=\"$sum\" uniq=\"$uniq\">\n";   
a1719 2
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
d1723 1
a1723 2
	print OUT "  <rec>\n"; 
	#printf(OUT "  <topbrows count=\"%d\" browser=\"%s\" />\n",  $s12{$k}, uri_escape($_[0]));
d1726 1
a1726 1
	print OUT "  </rec>\n";
d1730 2
a1731 1
    print OUT "</topbrowsers>\n\n";
d1737 1
a1737 1
    print OUT "<cookiemanip total=\"$sum\" uniq=\"$uniq\">\n";
d1742 1
a1742 2
    #printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
    #foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
d1748 1
a1748 2
	    #print OUT "$CRLF";
	    #$co = $cookie;
d1750 2
a1751 1
	    printf OUT "  <cookie str=\"%s\" />\n", $co;
d1753 5
a1757 1
	printf OUT "    <cookieinfo count=\"%d\" srcip=\"%s\" fqdn=\"%s\"/>\n", $s14{$k}, $_[1], resolve($_[1]);
d1763 1
a1763 1
    print OUT "</cookiemanip>\n\n";
d1769 1
a1769 1
    print OUT "<subdirlist total=\"$sum\" uniq=\"$uniq\">\n";
d1774 1
a1774 2
	print OUT "  <rec>\n";
	#printf(OUT "  <listing count=\"%d\" status=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s15{$k},$_[2], uri_escape($_[1]), $_[0], resolve($_[0]));
d1780 1
a1780 1
	print OUT "  </rec>\n";
d1783 2
a1784 2
    print OUT "</subdirlist>\n\n";
    
d1789 1
a1789 2

    print OUT "<formmanip total=\"$sum\" uniq=\"$uniq\">\n";
d1794 1
a1794 2
	print OUT "  <rec>\n";
	#printf(OUT "  <formstr count=\"%d\" query=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s16{$k}, uri_escape($_[1]), $_[0], resolve($_[0]));
d1799 1
a1799 2
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
d1801 2
a1802 1
    print OUT "</formmanip>\n\n";
a1805 1
    #print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
d1807 1
a1807 1
    print OUT "<locateproxy total=\"$sum\" uniq=\"$uniq\">\n";
a1808 1
    #print OUT "Totally $sum and $uniq unique.$CRLF";
a1810 1
    #printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
d1814 1
a1814 2
	print OUT "  <rec>\n";
	#printf(OUT "  <locprox count=\"%d\" status=\"%d\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
d1820 1
a1820 2

	print OUT "  </rec>\n";
d1823 1
a1823 1
    print OUT "</locateproxy>\n\n";
d1829 1
a1829 1
    print OUT "<longurlattempt total=\"$sum\" uniq=\"$uniq\">\n";
d1833 1
a1833 1
    #printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
d1837 1
a1837 2
	print OUT "  <rec>\n";
	#printf(OUT "<longurl count=\"%d\" status=\"%s\" length=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n  $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] , $_[1], resolve($_[1]));
d1844 1
a1844 2
	
	print OUT "  </rec>\n";
d1848 4
a1851 3
    print OUT "</longurlattempt>\n\n"; 
    
    print OUT "</report>\n";
a1853 2


a1857 2


d1883 3
a1885 3
    print OUT "<$xmlname>" . $xmlvalue . "<\/$xmlname>\n";
    
    
@


1.60
log
@Small fixes. Last Save when we re-enter XML in the next version
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.59 2003/05/26 19:42:00 mibl Exp mibl $
# $Revision: 1.59 $
d43 2
a44 1
#
d58 1
a58 1
$VERSION = '2.34';
d1291 591
@


1.59
log
@Web Fixes
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.58 2003/05/26 19:39:49 mibl Exp mibl $
# $Revision: 1.58 $
d109 1
a109 1
    $CRLF = '<br>\n';
d783 1
d785 1
d787 5
a791 1
    print OUT "Inputfile(s): " . join (" ",@@list). "$CRLF";
d793 8
a800 2
    print OUT "Log Start: $mindate$CRLF";
    print OUT "Log Stopp: $maxdate$CRLF";
d803 4
a806 1
    printf OUT "nr of analyzed rows:        %7d $CRLF", $numlines;
d808 5
a812 1
    printf OUT "nr of unique IP-addresses:  %7d $CRLF", $numip;
d814 1
d816 1
d818 1
d820 1
a820 1

d822 1
d824 1
d827 1
a827 1
    
d840 2
@


1.58
log
@Added switch for when running as CGI (-W)
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.57 2003/05/22 21:23:28 mibl Exp mibl $
# $Revision: 1.57 $
d97 1
a97 1
getopts('hvNsXoC:');  # If set, then don't do a name lookup
@


1.57
log
@Changed order of output. Addes Server name to server-ip.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.56 2003/05/08 07:29:33 mibl Exp mibl $
# $Revision: 1.56 $
d105 1
d108 3
@


1.56
log
@Fixed $user issue.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.55 2003/05/06 13:42:57 mibl Exp mibl $
# $Revision: 1.55 $
d53 1
a53 1
# Do Whois-lookup on IP-addresses in printed in report.
d694 2
a695 1
	$s61{"$httpver¤$url¤$ip"}++;
d766 1
a766 1
    $s20{$serverip}++;
d807 1
a807 1
	print OUT "Servers analyzed:$CRLF";
d809 1
a809 1
	    printf OUT "  %-15s %9d$CRLF", $x, $s20{$x};
a851 18
    # Binary / un-printable data in URL's
    print OUT "$CRLF********** URL's containing binary data ********** $CRLF";
    sumhash (\%s45);
    if ($uniq gt 0) {
        print OUT "This could indicate attempts to cause a Denial of Service or$CRLF";
	print OUT "someone trying to breaking in.$CRLF";
        print OUT "Totally $sum and $uniq unique.$CRLF";
        printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
        foreach $k (sort {$s45{$b} <=> $s45{$a}} keys %s45 )
        {
            @@_ = split "\#\#", $k;
            printf (OUT "%7d  %-15s  %-50s$CRLF",  $s45{$k},$_[0], $_[1]);
        }
    } else {
        printf OUT "None. $CRLF";
    }


d953 1
a953 1
	    printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
d1065 22
d1111 1
a1111 1
    print OUT "$CRLF********** Top $topmax Browsers ********** $CRLF";      
d1336 1
a1336 1
    syslog('info', @@_);
@


1.55
log
@Added Extended Log Format (Mikes...)
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.54 2003/04/27 22:05:58 mibl Exp mibl $
# $Revision: 1.54 $
d57 1
a57 1
$VERSION = '2.33';
d505 2
a506 2
	    \s([\-]+?)                        # User
            \s(.+?)                        # unused
d519 1
a519 1
	    $logformat{'Mikes Format'}++;
d522 1
a522 1
	    $user = $3;
d526 1
d528 11
a538 1
  
a550 2
 	    
	    
a551 1

a552 1

@


1.54
log
@Added binary URL scan
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.53 2003/04/27 21:18:29 mibl Exp $
# $Revision: 1.53 $
d97 1
a97 1
getopts('hvNsXo');  # If set, then don't do a name lookup
d104 3
d109 4
a112 1
 
d430 2
a431 2
	$referer = $HASH{'cs(Referer)'};
	$cookie = $HASH{'cs(Cookie)'};
d453 3
a455 4
	if ( m/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # IP Address
	     
	     \s(.+?)                        # User
	     \s(.+?)                        # unused
d457 2
a458 4
	     \s\"(.*)\s               # Url
	     
	     (?:(\?.*\s))?
	     (?:(.*?)\")? 		  # Match regardless of HTTP Version.
d470 1
a470 1
	    
d472 3
a474 3
	    $query = $6;
	    $httpver = $7; $status = $8; $len = $9;
	    $referer = $10; $browser = $11; $cookie = $12;
d477 1
a477 1
	    if ($url =~ m/([\w]+)\s.*/) {
d479 2
d483 5
d502 44
d618 13
a630 7
    if (($user ne '-') and ($user ne 'N/A') and (defined $user))
    {
	#print "\:$user\:\n";
	$s1{"$user¤$ip"}++;
	# Why do we resolve the ip-address here??? /Mike
	if ($sip{$ip} eq undef) {	$sip{$ip} = resolve($ip) };
	#print "$_\n";
a631 2

    $s10{"$user"}++;
d695 5
a699 2
    
    unless ($referer =~ m/^\s*$/) { $s11{$referer}++;}
d705 12
a716 6
    if (($cookie ne '-') && ($cookie ne '')) {
	#print "Cookie: $cookie   - IP: $ip\n";
	if (defined $s13{$cookie}) {
	    if (($s13{$cookie} ne $ip) && (! defined $s14{"$cookie¤$ip"})){
		#print "Cookie: $cookie \n Old IP: $s13{$cookie} New IP: $ip\n";
		#Then we have problems...
d718 8
a725 12
		#$s14{"$cookie"}++;
		$s14{"$cookie¤$ip"}++;
		$s14{"$cookie¤$s13{$cookie}"}++;
	    } 
	    	    
	} else {
	#    #print "CIP: $ip\n";
	    $s13{$cookie} = $ip;
	    #$s14{"$cookie¤$ip"}++;
	    #$s14{"$cookie¤$ip"}++;
	    #print "CIP: $cookie = $ip\n";    
	    #}
d727 2
d808 5
d890 5
a894 1
        printf OUT "None. $CRLF";
d908 5
a912 1
        printf OUT "None. $CRLF";
d1090 5
a1094 1
	printf OUT "Not Available$CRLF";
d1108 1
a1108 1
	    if ($xx++ == $topmax) { last; }
d1143 6
a1148 1
	print OUT "None found.$CRLF";
@


1.53
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.51 2003/04/27 21:16:03 mibl Exp mibl $
# $Revision: 1.51 $
d564 1
a564 1
    if  ($user =~ m/\-|/i) 
d566 1
a566 1
	print "\:$user\:\n";
a584 1
	
d597 8
a604 1
	print "$date $ip\n";
d773 19
@


1.52
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.50 2003/04/27 20:12:22 mibl Exp mibl $
# $Revision: 1.50 $
d409 1
a409 1
	$user = $HASH{'cs-username'};
d564 1
a564 1
    if (($user ne '-') and ($user ne 'N/A')) 
d566 1
a688 2
    

a691 591
sub printxml {
    print OUT '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' . "\n";
    # Check if results are OK, before mailing report
    if ($numlines eq $logformat{'Unknown'}) {
	exit 99;
    }
    slog('Printing XML output');
    print OUT "<report version=\"$VERSION\" logdatestart=\"$mindate\" logdateend=\"$maxdate\">\n";
    
    print OUT "<reporttitle>Security Log File Analysis</reporttitle>\n";

    print OUT "<inputfiles>" . join (" ",@@list) . "</inputfiles>\n";
    print OUT "<outputfiles>$outfile</outputfiles>\n";
    #print OUT "<stats execstart=\"$starttimetext\" execstop=\"" . localtime();
    prntx ("execstart", $starttimetext);
    prntx ("execstop", localtime(). "");
    prntx ('rowsanalysed',$numlines);
    prntx ('nripaddr',$numip);
    prntx ('perf',  $numlines / (time - $starttime + 1));
    prntx ('nameresoff', $opt_N);
       
    #print OUT "\" rowsanalysed=\"$numlines\" nripaddr=\"$numip\" perf=\"";
    #print OUT $numlines / (time - $starttime + 1) . "\" ";
    #print OUT "nameresoff=\"$opt_N\">\n";
    #print OUT "Outputfile: $outfile $CRLF";
    #print OUT "<executionstart>" . $starttimetext . "</executionstart>\n";
    #print OUT "<executionstop>" . localtime() . "<executionstop>\n";
    #printf OUT "<analyzedrows>%d</analyzedrows>\n", $numlines;
    #printf OUT "nr of non-analyzed rows:    %7d $CRLF", $logformat{'UNKNOWN'};
    #printf OUT "<nrofipaddresses>%d</nrofipaddresses>\n", $numip;
    #printf OUT "<performance>" . $numlines / (time - $starttime + 1) . "</performance>\n";
    #print OUT "</stats>\n";
    print OUT "<logformats>\n";
    prntx('title','Logformats');

    foreach $x (keys %logformat) {
	print OUT "  <rec>\n";
	#printf OUT "  <logformat format=\"%s\" nrfound=\"%d\" />\n", $x, $logformat{$x};
	#print OUT "<logformat>\n";
	prntx ("format", $x);
	prntx ("nrfound", $logformat{$x});
	#print OUT "</logformat>\n";
	print OUT "  </rec>\n";
    }

    print OUT "</logformats>\n\n";

    slog("Nr of Analyzed rows: $numlines");
    slog("Rows/sec: " . $numlines / (time - $starttime + 1));
    #printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);
    #printf OUT "nr of $logformat{'CLF'}\n";
    
    #if ($opt_N ne '') 
    #{  print OUT "<nameresolution>Off</nameresolution>\n"; }
    #else
    #{  print OUT "<nameresolution>On</nameresolution>\n"; }
    
    # Show number of hits/hour
    print OUT "<hitsperhour>\n";
    prntx('title','Hits per hour');
    sumhash (\%s7);
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
    #foreach $k (sort keys %s7)
    #print "<rec>\n";
    for ($k=0;$k<24;$k++)
    {
	@@_ = split "¤", $k;
	$hits = $s7{sprintf("%02d", $k)};
	if ($hits eq '') { $hits = '0'};
	#printf (OUT "  <hits hour=\"%d\">%s</hits>\n",  $_[0], $hits);
	print OUT "  <rec>\n";
	prntx('hour',$_[0]);
	prntx('hits',$hits);
	print OUT "  </rec>\n";
    }
        
    print OUT "</hitsperhour>\n\n";



    # Dangerous files...
    #print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
    sumhash (\%s3);
    print OUT "<dangerousfiles total=\"$sum\" uniq=\"$uniq\">\n";

    prntx('title','Successful attempts to retrieve Dangerous files');
    #print OUT "This could inidicate a serious security breach.$CRLF";
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
    foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
    {
	@@_ = split "¤", $k;
	print OUT "<rec>\n";
	prntx('count',$s3{$k});
	prntx('srcip',$_[0]);
	prntx('url',$_[1]);
	print OUT "</rec>\n";
	#print OUT "<dangerousfile count=\"$s3{$k}\" srcip=\"$_[0]\" url=\"$_[1]\"/>\n";
	
	#printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k}, $_[0], $_[1]);
    }
    print OUT "</dangerousfiles>\n\n";
    
    # Unauthorized
    #print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
    sumhash (\%s2);
    print OUT "<unauthorized total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Users who have accessed protected page');
    foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
    {
	@@_ = split "¤", $k;
	#print OUT "<entry>\n";
	print OUT "  <rec>\n";
	prntx('count',$s2{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[1]);
	prntx('user',$_[3]);
	prntx('url',$_[2]);
	print OUT "  </rec>\n";
	#printf OUT " <unauthorized_user count=\"%s\" status=\"%s\" srcip=\"%s\" user=\"%s\" url=\"%s\"/>\n", $s2{$k},$_[0], $_[1], $_[3], $_[2];
	#print OUT "</entry>\n";
    }
    
    print OUT "</unauthorized>\n\n";


    #print OUT "$CRLF********** Logged in Users **********$CRLF";
    sumhash (\%s10);
    
    print OUT "<logged_in_users total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title','Logged in users');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
    foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('user',$_[0]);
	prntx('count', $s10{$k});
	print OUT "  </rec>\n";
	#printf(OUT " <loggedinuser count=\"%d\" user=\"%s\"/>\n",  $s10{$k}, $_[0]);	
    }
    print OUT "</logged_in_users>\n\n";

    
    # Logged in users per IP-address (excl Anonymous) 
    sumhash (\%s1);
    print OUT "<logged_in_users_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Logged in user per IP-address');
    foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s1{$k});
	prntx('user',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',$sip{$_[1]});
	print OUT "  </rec>\n";	
	#printf OUT " <userperip count=\"%d\" user=\"%s\" srcip=\"%s\" fqdn=\"%s\"/>\n",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
    }
    print OUT "</logged_in_users_per_ip>\n\n";
        

    # Count of all Statuscodes...
    sumhash (\%s5);
    print OUT "<statuscodes total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title','Statuscodes');
    foreach $k (sort keys %s5 )
    {
        @@_ = split "¤", $k;
        print OUT "  <rec>\n";
        prntx('count',$s5{$k});
        prntx('status',$_[0]);
        prntx('statusname',$STATCODE{$_[0]});
        print OUT "  </rec>\n";
	
        #printf(OUT "<codes count=\"%d\" status=\"%s\" statusname=\"%s\"/>\n" ,$s5{$k}, $_[0], $STATCODE{$_[0]});
	
        #print OUT "</entry>\n";
    }
    print OUT "</statuscodes>\n\n";


    # Count of all HTTP Methods...
    sumhash (\%s19);
    print OUT "<httpmethods total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'List of HTTP methods found');
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s19{$k});
	prntx('method',$k);
	print OUT "  </rec>\n";
	printf(OUT "  <method count=\"%d\" methodstr=\"%s\"/>\n",  $s19{$k}, $k,);
    }
    print OUT "</httpmethods>\n\n";	


    
    # Count of all HTTP Versions...
    #print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
    sumhash (\%s6);

    print OUT "<httpversions total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Count of HTTP-verssions');
    foreach $k (sort keys %s6 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s6{$k});
	prntx('version',$_[0]);
        print OUT "  </rec>\n";
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	#printf(OUT "  <version count=\"%d\" versionstr=\"%s\"/>\n",  $s6{$k}, $_[0]);
    }
    print OUT "</httpversions>\n\n";
    
    
    # List illegal HTTP Versions...
    sumhash (\%s61);
    
    print OUT "<illegalhttp total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Invalid HTTP-versions');
    foreach $k (sort keys %s61 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s61{$k});
	prntx('httpstr',$_[0]);
	prntx('srcip',$_[2]);
	prntx('fqdn',resolve($_[2]));
	print OUT "  </rec>\n";
	#printf(OUT "<badhttp count=\"%s\" httpstr=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
    }
    print OUT "</illegalhttp>\n\n";

    
    # List the Top HIT'ers
    $xx = 1;
    sumhash(\%iptab);
    print OUT "<tophitters total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'List of Top Hitters');
    #print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
    #sumhash (\%iptab);
    #print OUT ($uniq >= $topmax) ? $topmax : $uniq;
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
    foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
    {
	@@_ = split "¤", $k;
	print OUT " <rec>\n";
	prntx('rank',$xx);
	prntx('count',$iptab{$k});
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
	#printf(OUT "  <hitter rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n", $xx, , $iptab{$k},$_[0], resolve($_[0]));
	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</tophitters>\n\n";

    # List attempts to access non-existing pages
    #print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
    sumhash (\%s01);
    print OUT "<errors4xx total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Access attempts generating 4xx errors');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
    foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s01{$k});
	prntx('httpstatus',$_[0]);
	#prntx('url',uri_escape($_[1]));
	prntx('url',$_[1]);
	#printf(OUT "  <error4xx count=\"%d\" httpstatus=\"%d\" url=\"%s\" />\n",  $s01{$k}, $_[0], uri_escape($_[1]));
	print OUT " </rec>\n";
    }
    
    print OUT "</errors4xx>\n\n";
    
    
    #Top IP\'s generating 403/404 **********
    $xx = 1;
    sumhash (\%s02);
    print OUT "<top4xxerrorsperip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 4xx errors per IP');
    foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
    {
	@@_ = split "¤", $k;

	#printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	#printf(OUT "  <top4xxerror rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	print OUT "  <rec>\n";
	prntx('rank',$xx);
	prntx('count',$s02{$k});
	prntx('srcip',$_[0]);
	prntx('fqdn',$sip{$_[0]});
	print OUT " </rec>\n";	
	if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</top4xxerrorsperip>\n\n";
    
    
    #********** Top $topmax Files per IP genererating 403/404 *********
    $xx = 1;
    sumhash (\%s0);
    print OUT "<top4xxerrorsperipurl total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 4xx errors per IP and URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "This could inidicate either faultly links on your site, or$CRLF";
    #print OUT "a perpetrator looking for vulnerabilities.$CRLF";
    #printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
    foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top4xxerroripurl rank=\"%d\" count=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $xx, $s0{$k},$_[0], $_[1]);
	prntx('rank',$xx);
	prntx('count',$s0{$k});
	prntx('srcip',$_[0]);
	prntx('url',$_[1]);

	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</top4xxerrorsperipurl>\n\n";
	
        
    # 5xx Status
    #print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
    sumhash (\%s42);

    print OUT "<top_5xx_errors_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 5xx errors per IP');
    $xx = 1;
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "This could indicate various attempts to cause your web server$CRLF";
    #print OUT "to produce erronous results.$CRLF";  
    #printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
    foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerrors count=\"%d\" status=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	prntx('count',$s42{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',$sip{$_[1]});
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</top_5xx_errors_per_ip>\n\n";
    
    
    # 5xx Status
    #******* Top $topmax URL\'s causing Server Errors (5xx) 
    $xx = 1;
    sumhash (\%s4);
    print OUT "<top_5xx_errors_per_url total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 5xx errors per URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
    foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerrorurl count=\"%d\" status=\"%d\" url=\"%s\" />\n",  $s4{$k},$_[0], $_[1]);
	prntx('count',$s4{$k});
	prntx('status',$_[0]);
	prntx('url',$_[1]);
	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</top_5xx_errors_per_url>\n\n"; 


    #print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
    $xx = 1;
    sumhash (\%s41);
    
    print OUT "<top_5xx_errors_per_ip_url total=\"$sum\" uniq=\"$uniq\">\n";  
    prntx('title', 'Top 5xx errors per IP and URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
    foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerroripurl count=\"%d\" status=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $s41{$k},$_[0], $_[2], $_[1]);
	prntx('count',$s41{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[2]);
	prntx('url',$_[1]);
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }

    print OUT "</top_5xx_errors_per_ip_url>\n\n"; 

     
    # Top Referers
    $xx = 1;
    #print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
    sumhash (\%s11);

    #if ($uniq > 0 ) {
    print OUT "<topreferers total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top Referers');

    foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#$xy = $_[0];
	if ($_[0] =~ m/(.*?)\?(.*)/) {
	    $urlstr = $1; $uristr = uri_escape($2);
	} else {
	    #print "$_[0]\n";
	    $urlstr = $_[0]; $uristr = '';
	}

	#$xy =~ s/\?.*//i;
	#printf(OUT "  <refstr count=\"%d\"  refurl=\"%s\" refuri=\"%s\" />\n",  $s11{$k}, $urlstr, $uristr );
	prntx('count',$s11{$k});
	prntx('refurl',$urlstr);
	prntx('refuri',$uristr);
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</topreferers>\n\n"; 

    
    # Top Browsers
    $xx = 1;
    sumhash (\%s12);
    print OUT "<topbrowsers total=\"$sum\" uniq=\"$uniq\">\n";   
    prntx('title', 'Top Browsers used');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
    foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n"; 
	#printf(OUT "  <topbrows count=\"%d\" browser=\"%s\" />\n",  $s12{$k}, uri_escape($_[0]));
	prntx('count',$s12{$k});
	prntx('browser',uri_escape($_[0]));
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</topbrowsers>\n\n";

    # Check for Cookie Manipulation
    $xx = 1;
    sumhash (\%s14);

    print OUT "<cookiemanip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Suspected Cookie Manipulation');
    #print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
    #print OUT "This could inidicate attempted session hijacking,$CRLF";
    #print OUT "or users coming via a non-ip session aware proxy.$CRLF";
    #printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
    #foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
    $old = '';
    foreach $k (sort keys %s14)
    {
	@@_ = split "¤", $k;
	if ($old ne $_[0]) {
	    #print OUT "$CRLF";
	    #$co = $cookie;
	    $co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
	    printf OUT "  <cookie str=\"%s\" />\n", $co;
	}
	printf OUT "    <cookieinfo count=\"%d\" srcip=\"%s\" fqdn=\"%s\"/>\n", $s14{$k}, $_[1], resolve($_[1]);
	
	
	$old = $_[0];
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</cookiemanip>\n\n";
    

    # Check for Directory scanning / Listing
    $xx = 1;
    sumhash (\%s15);
    print OUT "<subdirlist total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Subdirectory Listing Attempts');
    foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <listing count=\"%d\" status=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s15{$k},$_[2], uri_escape($_[1]), $_[0], resolve($_[0]));
	prntx('count',$s15{$k});
	prntx('status',$_[2]);
	prntx('url',$_[1]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</subdirlist>\n\n";
    

    # List attempted form manipulation
    $xx = 1;
    sumhash (\%s16);

    print OUT "<formmanip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'List suspected FORM manipulation');
    foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <formstr count=\"%d\" query=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s16{$k}, uri_escape($_[1]), $_[0], resolve($_[0]));
	prntx('count',$s16{$k});
	prntx('query',$_[1]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</formmanip>\n\n";

    # List attempted Anonymous Proxy Scans
    $xx = 1;
    #print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
    sumhash (\%s17);
    print OUT "<locateproxy total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Attempts to locate Proxy');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "Successfull attempts could indicate that your web server can$CRLF";
    #print OUT "be used for staging Internet Attacks and fraud.$CRLF";
    #printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
    foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <locprox count=\"%d\" status=\"%d\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
	prntx('count', $s17{$k});
	prntx('status', $_[1]);
	prntx('url', $_[2]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));

	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</locateproxy>\n\n";


    # List exceedingly Long URL's
    $xx = 1;
    sumhash (\%s18);
    print OUT "<longurlattempt total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Exceedingly Long URLs');
    #print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
    #print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
    #printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
    foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "<longurl count=\"%d\" status=\"%s\" length=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n  $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] , $_[1], resolve($_[1]));
	prntx('count',$s18{$k});
	prntx('status',$_[3]);
	prntx('length',$_[2]);
	prntx('url',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',resolve($_[1]));
	
	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</longurlattempt>\n\n"; 
    
    print OUT "</report>\n";
    
    close OUT;


}



a1134 445
sub printhtml {

    # Check if results are OK, before mailing report
    if ($numlines eq $logformat{'Unknown'}) {
	exit 99;
    }
    slog('Printing text output');
    print OUT "Security Log File Analysis$CRLF";
    print OUT "SLAC v $VERSION$CRLF$CRLF";
    print OUT "Inputfile(s): " . join (" ",@@list). "$CRLF";
    #print OUT "Outputfile: $outfile $CRLF";
    print OUT "Log Start: $mindate$CRLF";
    print OUT "Log Stopp: $maxdate$CRLF";
    #print OUT "Execution started: " . $starttimetext . "$CRLF";
    #print OUT "Execution stopped: " . localtime() . "$CRLF";
    printf OUT "nr of analyzed rows:        %7d $CRLF", $numlines;
    #printf OUT "nr of non-analyzed rows:    %7d $CRLF", $logformat{'UNKNOWN'};
    printf OUT "nr of unique IP-addresses:  %7d $CRLF", $numip;
    print OUT "Rows identified as:$CRLF";
    foreach $x (keys %logformat) {
	printf OUT " %-24s %9d$CRLF", $x, $logformat{$x};
    }

    slog("Nr of Analyzed rows: $numlines");
    slog("Rows/sec: " . $numlines / (time - $starttime + 1));
    #printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);
    #printf OUT "nr of $logformat{'CLF'}\n";
    
    if ($opt_N ne '') 
    {  print OUT "Name Resolution has NOT been performed.$CRLF$CRLF"; }
    #else
    #{  print OUT "Name Resolution has been performed.$CRLF$CRLF"; }
    
    # Show number of hits/hour
    print OUT "$CRLF********** Hits / hour ********** $CRLF";
    sumhash (\%s7);
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
    #foreach $k (sort keys %s7)
    for ($k=0;$k<24;$k++)
    {
	@@_ = split "¤", $k;
	$hits = $s7{sprintf("%02d", $k)};
	if ($hits eq '') { $hits = '0'};
	printf (OUT "%7d  %9s  %-50s$CRLF",  $_[0], $hits, "*" x ($hits / ($hrmax+1) * 40));
    }
    


    # Show number of hits/hour in PNG format

    #my $data = GD::Graph::Data->new();
    #my $name = '/usr/local/apache/htdocs/toptalk';
    #print OUT "$CRLF********** Hits / hour ********** $CRLF";
    #sumhash (\%s7);
    #for ($k=0;$k<24;$k++)
    #{
#	$hits = $s7{sprintf("%02d", $k)};
#        if ($hits eq '') { $hits = '0'};
#	$data->add_point($k, $hits);
#}
    #my $my_graph = GD::Graph::bars->new();
    #$my_graph->set(x_label  => 'Hour',
#		   y_label  => 'Hits',
#		   title           => "Hits per hour, $mindate",
#		   y_max_value     => $max,
#		   y_tick_number   => 8,
#		   y_label_skip    => 2,
#		   #x_labels_vertical => 1,
#		   # shadows
#		   bar_spacing     => 8,
#		   shadow_depth    => 2,
#		   shadowclr       => 'dred',
#      		   transparent     => 0,
#		   )
#	or warn $my_graph->error;

    #$my_graph->plot($data) or die $my_graph->error;
    #save_chart($my_graph, $name);


    # Dangerous files...
    print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
    sumhash (\%s3);
    if ($uniq gt 0) {
	print OUT "This could inidicate a serious security breach.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
	foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
	{
	    @@_ = split "¤", $k;
	    printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k},$_[0], $_[1]);
	}
    } else {
	printf OUT "None. $CRLF";
    }
    
    # Unauthorized
    print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
    sumhash (\%s2);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT  "%7s  %5s  %-15s  %-9s %s$CRLF", 'Count', 'Status', 'Src IP', 'User', 'URL';
	foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT  "%7d  %5s   %-15s  %-9s %s$CRLF",  $s2{$k},$_[0], $_[1], $_[3], $_[2]);
	}
    } else {
	printf OUT "None. $CRLF";
    }

    
    print OUT "$CRLF********** Logged in Users **********$CRLF";
    sumhash (\%s10);
    if ($uniq gt 0) {   
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
	foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9d  %-15s$CRLF",  $s10{$k},$_[0]);
	}
    } else {
        printf OUT "None. $CRLF";
    }

    print OUT "$CRLF********** Logged in users per IP-address (excl Anonymous) **********$CRLF";
    sumhash (\%s1);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%9s  %-15s  %-15s  %s$CRLF",  'Count', 'User', 'Src-IP', 'FQDN';
	foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
	{
	    @@_ = split "¤", $k;
	    printf OUT "%9d  %-15s  %-15s  %s$CRLF",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
	}
    } else {
        printf OUT "None. $CRLF";
    }
    
    # Count of all Statuscodes...
    print OUT "$CRLF********** Count of HTTP statuscodes ********** $CRLF";
    sumhash (\%s5);
    
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Status $CRLF";
    foreach $k (sort keys %s5 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d (%6.2f%%) HTTP Status: %-4d  %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
	printf(OUT "%9d (%6.2f%%)    %4s %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
    }

    # Count of all HTTP Methods...
    print OUT "$CRLF********** Count of HTTP Methods ********** $CRLF";
    sumhash (\%s19);
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Method $CRLF";
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
        @@_ = split "¤", $k;
	printf(OUT "%9d (%6.2f%%)     %s$CRLF",  $s19{$k}, ($s19{$k}*100/$sum),    $k,);
}


    
    # Count of all HTTP Versions...
    print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
    sumhash (\%s6);
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )    HTTP-Version $CRLF";
    foreach $k (sort {$s6{$b} <=> $s6{$a}} keys %s6 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	printf(OUT "%9d (%6.2f%%)    %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
    }
    
    # List illegal HTTP Versions...
    print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
    sumhash (\%s61);
    if ($uniq gt 0) {
	print OUT "This could inidicate attempts to manipulate and compromise the webserver.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s %-25s %-15s %s %-s$CRLF", 'Count' , 'HTTP String',  'IP', 'FQDN');
	foreach $k (sort {$s61{$b} <=> $s61{$a}} keys %s61 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
	}
    } else {
	printf OUT "None. $CRLF";
    }

    # List the Top HIT'ers
    $xx = 1;
    sumhash(\%iptab);
    print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
    #sumhash (\%iptab);
    #print OUT ($uniq >= $topmax) ? $topmax : $uniq;
    print OUT "Totally $sum and $uniq unique.$CRLF";
    printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
    foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
    {
	@@_ = split "¤", $k;
	printf(OUT "%4d (%6.2f%%)  %7d  %-15s  %-30s$CRLF", $xx, ($iptab{$k}*100/$sum), $iptab{$k},$_[0], resolve($_[0]));
	if ($xx++ == $topmax) { last; }
    }
    
    
    # List attempts to access non-existing pages
    print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
    
    sumhash (\%s01);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
	foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %7d  %-15s$CRLF",  $s01{$k},$_[0], $_[1]);
	}
	
	print OUT "$CRLF$CRLF********** Top $topmax IP\'s generating 403/404 **********$CRLF";
	$xx = 1;
	sumhash (\%s02);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "The top IP's on this list could be the source for vulnerability scans of your  site.$CRLF";
	printf(OUT "%4s %7s   %-15s  %s$CRLF",  'Rank', "Count", "IP-Address", "FQDN");
	foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
	{
	    @@_ = split "¤", $k;
	    #printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	    printf(OUT "%4d %7d   %-15s  %s$CRLF",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "$CRLF$CRLF********** Top $topmax Files per IP genererating 403/404 **********$CRLF";
	$xx = 1;
	sumhash (\%s0);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could inidicate either faultly links on your site, or$CRLF";
	print OUT "a perpetrator looking for vulnerabilities.$CRLF";
	printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
	foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%4d %7d  %-15s  %s$CRLF",  $xx, $s0{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        printf OUT "None. $CRLF";
    }
    
	
    
    # 5xx Status
    print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
    sumhash (\%s42);
    if ($uniq > 0) {
	$xx = 1;
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could indicate various attempts to cause your web server$CRLF";
	print OUT "to produce erronous results.$CRLF";  
	printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
	foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-15s %s$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	    if ($xx++ == $topmax) { last; }
	}
   
    
	# 5xx Status
	print OUT "$CRLF********** Top $topmax URL\'s causing Server Errors (5xx) ********** $CRLF";
	$xx = 1;
	sumhash (\%s4);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
	foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-20s$CRLF",  $s4{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
	$xx = 1;
	sumhash (\%s41);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
	foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-15s  %s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        printf OUT "None. $CRLF";
    }
 
    # Top Referers
    $xx = 1;
    print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
    sumhash (\%s11);
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Referer' ;
	foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s11{$k},$_[0]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
    }
    
    # Top Browsers
    $xx = 1;
    print OUT "$CRLF********** Top $topmax Browsers ********** $CRLF";      
    sumhash (\%s12);
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
	foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s12{$k},$_[0]);             
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
    }

    # Check for Cookie Manipulation
    $xx = 1;
    print OUT "$CRLF********** Same Cookie from different IP-addresses ********** $CRLF";
    sumhash (\%s14);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
	print OUT "This could inidicate attempted session hijacking,$CRLF";
	print OUT "or users coming via a non-ip session aware proxy.$CRLF";
	printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
	#foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
	$old = '';
	foreach $k (sort keys %s14)
	{
	    #print "\$k: $k\n";
	    @@_ = split "¤", $k;
	    #print "\$_\[0\]:$_[0]$CRLF";
	    if ($old ne $_[0]) {
		print OUT "$CRLF";
		#$co = $cookie;
		$co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
		    
		printf OUT "Cookie: %s$CRLF", $co;
	    }
	    printf OUT "%9d %-15s %s$CRLF", $s14{$k}, $_[1], resolve($_[1]);
	    
	    $old = $_[0];
	    #if ($xx++ == $topmax) { last; }
	}
    } else {
	print OUT "None found.$CRLF";
    }

    # Check for Directory scanning / Listing
    $xx = 1;
    print OUT "$CRLF********** Unsuccessful Subdirectory Listing Attempts ********** $CRLF";
    sumhash (\%s15);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        #print OUT "This could inidicate attempted session hijacking.$CRLF";
        printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %7s %-40s %-15s %s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }

    # List attempted form manipulation
    $xx = 1;
    print OUT "$CRLF********** Suspected Form Data Manipulation ********** $CRLF";
    sumhash (\%s16);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "This could inidicate attempted unauthorized database access.$CRLF";
        printf OUT "%7s %-30s %-15s %-15s %-20s$CRLF", 'Count', 'Query', 'IP', 'FQDN' ;
        foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %-30s %-15s %-15s$CRLF",  $s16{$k}, $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }

    # List attempted Anonymous Proxy Scans
    $xx = 1;
    print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
    sumhash (\%s17);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "Successfull attempts could indicate that your web server can$CRLF";
	print OUT "be used for staging Internet Attacks and fraud.$CRLF";
        printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6d %-40s %-15s %s$CRLF",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }

    # List exceedingly Long URL's
    $xx = 1;
    print OUT "$CRLF********** Exceedingly Long URL's ********** $CRLF";
    sumhash (\%s18);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
        print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
        printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
        foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6s %10s  %-30s\n%26s %-15s %s $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] ,'', $_[1], resolve($_[1]));
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	print OUT "None found.$CRLF";
    }
    
    close OUT;
}

@


1.51
log
@Fixed user handling
@
text
@d409 1
a409 1
	$user = $HASH{'cs-username'} unless not defined $HASH{'cs-username'};
d564 1
a564 1
    if  ($user =~ m/\-|/i) 
a565 1
	print "\:$user\:\n";
d688 2
d693 591
d1727 445
@


1.50
log
@Some last version with XML and PrintHTML subs. They are remved after this version. I gave up on XML...
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.49 2003/04/16 16:00:09 mibl Exp mibl $
# $Revision: 1.49 $
d409 1
a409 1
	$user = $HASH{'cs-username'};
d564 1
a564 1
    if (($user ne '-') and ($user ne 'N/A')) 
d566 1
a688 2
    

a691 591
sub printxml {
    print OUT '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' . "\n";
    # Check if results are OK, before mailing report
    if ($numlines eq $logformat{'Unknown'}) {
	exit 99;
    }
    slog('Printing XML output');
    print OUT "<report version=\"$VERSION\" logdatestart=\"$mindate\" logdateend=\"$maxdate\">\n";
    
    print OUT "<reporttitle>Security Log File Analysis</reporttitle>\n";

    print OUT "<inputfiles>" . join (" ",@@list) . "</inputfiles>\n";
    print OUT "<outputfiles>$outfile</outputfiles>\n";
    #print OUT "<stats execstart=\"$starttimetext\" execstop=\"" . localtime();
    prntx ("execstart", $starttimetext);
    prntx ("execstop", localtime(). "");
    prntx ('rowsanalysed',$numlines);
    prntx ('nripaddr',$numip);
    prntx ('perf',  $numlines / (time - $starttime + 1));
    prntx ('nameresoff', $opt_N);
       
    #print OUT "\" rowsanalysed=\"$numlines\" nripaddr=\"$numip\" perf=\"";
    #print OUT $numlines / (time - $starttime + 1) . "\" ";
    #print OUT "nameresoff=\"$opt_N\">\n";
    #print OUT "Outputfile: $outfile $CRLF";
    #print OUT "<executionstart>" . $starttimetext . "</executionstart>\n";
    #print OUT "<executionstop>" . localtime() . "<executionstop>\n";
    #printf OUT "<analyzedrows>%d</analyzedrows>\n", $numlines;
    #printf OUT "nr of non-analyzed rows:    %7d $CRLF", $logformat{'UNKNOWN'};
    #printf OUT "<nrofipaddresses>%d</nrofipaddresses>\n", $numip;
    #printf OUT "<performance>" . $numlines / (time - $starttime + 1) . "</performance>\n";
    #print OUT "</stats>\n";
    print OUT "<logformats>\n";
    prntx('title','Logformats');

    foreach $x (keys %logformat) {
	print OUT "  <rec>\n";
	#printf OUT "  <logformat format=\"%s\" nrfound=\"%d\" />\n", $x, $logformat{$x};
	#print OUT "<logformat>\n";
	prntx ("format", $x);
	prntx ("nrfound", $logformat{$x});
	#print OUT "</logformat>\n";
	print OUT "  </rec>\n";
    }

    print OUT "</logformats>\n\n";

    slog("Nr of Analyzed rows: $numlines");
    slog("Rows/sec: " . $numlines / (time - $starttime + 1));
    #printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);
    #printf OUT "nr of $logformat{'CLF'}\n";
    
    #if ($opt_N ne '') 
    #{  print OUT "<nameresolution>Off</nameresolution>\n"; }
    #else
    #{  print OUT "<nameresolution>On</nameresolution>\n"; }
    
    # Show number of hits/hour
    print OUT "<hitsperhour>\n";
    prntx('title','Hits per hour');
    sumhash (\%s7);
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
    #foreach $k (sort keys %s7)
    #print "<rec>\n";
    for ($k=0;$k<24;$k++)
    {
	@@_ = split "¤", $k;
	$hits = $s7{sprintf("%02d", $k)};
	if ($hits eq '') { $hits = '0'};
	#printf (OUT "  <hits hour=\"%d\">%s</hits>\n",  $_[0], $hits);
	print OUT "  <rec>\n";
	prntx('hour',$_[0]);
	prntx('hits',$hits);
	print OUT "  </rec>\n";
    }
        
    print OUT "</hitsperhour>\n\n";



    # Dangerous files...
    #print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
    sumhash (\%s3);
    print OUT "<dangerousfiles total=\"$sum\" uniq=\"$uniq\">\n";

    prntx('title','Successful attempts to retrieve Dangerous files');
    #print OUT "This could inidicate a serious security breach.$CRLF";
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
    foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
    {
	@@_ = split "¤", $k;
	print OUT "<rec>\n";
	prntx('count',$s3{$k});
	prntx('srcip',$_[0]);
	prntx('url',$_[1]);
	print OUT "</rec>\n";
	#print OUT "<dangerousfile count=\"$s3{$k}\" srcip=\"$_[0]\" url=\"$_[1]\"/>\n";
	
	#printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k}, $_[0], $_[1]);
    }
    print OUT "</dangerousfiles>\n\n";
    
    # Unauthorized
    #print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
    sumhash (\%s2);
    print OUT "<unauthorized total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Users who have accessed protected page');
    foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
    {
	@@_ = split "¤", $k;
	#print OUT "<entry>\n";
	print OUT "  <rec>\n";
	prntx('count',$s2{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[1]);
	prntx('user',$_[3]);
	prntx('url',$_[2]);
	print OUT "  </rec>\n";
	#printf OUT " <unauthorized_user count=\"%s\" status=\"%s\" srcip=\"%s\" user=\"%s\" url=\"%s\"/>\n", $s2{$k},$_[0], $_[1], $_[3], $_[2];
	#print OUT "</entry>\n";
    }
    
    print OUT "</unauthorized>\n\n";


    #print OUT "$CRLF********** Logged in Users **********$CRLF";
    sumhash (\%s10);
    
    print OUT "<logged_in_users total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title','Logged in users');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
    foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('user',$_[0]);
	prntx('count', $s10{$k});
	print OUT "  </rec>\n";
	#printf(OUT " <loggedinuser count=\"%d\" user=\"%s\"/>\n",  $s10{$k}, $_[0]);	
    }
    print OUT "</logged_in_users>\n\n";

    
    # Logged in users per IP-address (excl Anonymous) 
    sumhash (\%s1);
    print OUT "<logged_in_users_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Logged in user per IP-address');
    foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s1{$k});
	prntx('user',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',$sip{$_[1]});
	print OUT "  </rec>\n";	
	#printf OUT " <userperip count=\"%d\" user=\"%s\" srcip=\"%s\" fqdn=\"%s\"/>\n",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
    }
    print OUT "</logged_in_users_per_ip>\n\n";
        

    # Count of all Statuscodes...
    sumhash (\%s5);
    print OUT "<statuscodes total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title','Statuscodes');
    foreach $k (sort keys %s5 )
    {
        @@_ = split "¤", $k;
        print OUT "  <rec>\n";
        prntx('count',$s5{$k});
        prntx('status',$_[0]);
        prntx('statusname',$STATCODE{$_[0]});
        print OUT "  </rec>\n";
	
        #printf(OUT "<codes count=\"%d\" status=\"%s\" statusname=\"%s\"/>\n" ,$s5{$k}, $_[0], $STATCODE{$_[0]});
	
        #print OUT "</entry>\n";
    }
    print OUT "</statuscodes>\n\n";


    # Count of all HTTP Methods...
    sumhash (\%s19);
    print OUT "<httpmethods total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'List of HTTP methods found');
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s19{$k});
	prntx('method',$k);
	print OUT "  </rec>\n";
	printf(OUT "  <method count=\"%d\" methodstr=\"%s\"/>\n",  $s19{$k}, $k,);
    }
    print OUT "</httpmethods>\n\n";	


    
    # Count of all HTTP Versions...
    #print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
    sumhash (\%s6);

    print OUT "<httpversions total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Count of HTTP-verssions');
    foreach $k (sort keys %s6 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s6{$k});
	prntx('version',$_[0]);
        print OUT "  </rec>\n";
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	#printf(OUT "  <version count=\"%d\" versionstr=\"%s\"/>\n",  $s6{$k}, $_[0]);
    }
    print OUT "</httpversions>\n\n";
    
    
    # List illegal HTTP Versions...
    sumhash (\%s61);
    
    print OUT "<illegalhttp total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Invalid HTTP-versions');
    foreach $k (sort keys %s61 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s61{$k});
	prntx('httpstr',$_[0]);
	prntx('srcip',$_[2]);
	prntx('fqdn',resolve($_[2]));
	print OUT "  </rec>\n";
	#printf(OUT "<badhttp count=\"%s\" httpstr=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
    }
    print OUT "</illegalhttp>\n\n";

    
    # List the Top HIT'ers
    $xx = 1;
    sumhash(\%iptab);
    print OUT "<tophitters total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'List of Top Hitters');
    #print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
    #sumhash (\%iptab);
    #print OUT ($uniq >= $topmax) ? $topmax : $uniq;
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
    foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
    {
	@@_ = split "¤", $k;
	print OUT " <rec>\n";
	prntx('rank',$xx);
	prntx('count',$iptab{$k});
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
	#printf(OUT "  <hitter rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n", $xx, , $iptab{$k},$_[0], resolve($_[0]));
	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</tophitters>\n\n";

    # List attempts to access non-existing pages
    #print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
    sumhash (\%s01);
    print OUT "<errors4xx total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Access attempts generating 4xx errors');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
    foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s01{$k});
	prntx('httpstatus',$_[0]);
	#prntx('url',uri_escape($_[1]));
	prntx('url',$_[1]);
	#printf(OUT "  <error4xx count=\"%d\" httpstatus=\"%d\" url=\"%s\" />\n",  $s01{$k}, $_[0], uri_escape($_[1]));
	print OUT " </rec>\n";
    }
    
    print OUT "</errors4xx>\n\n";
    
    
    #Top IP\'s generating 403/404 **********
    $xx = 1;
    sumhash (\%s02);
    print OUT "<top4xxerrorsperip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 4xx errors per IP');
    foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
    {
	@@_ = split "¤", $k;

	#printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	#printf(OUT "  <top4xxerror rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	print OUT "  <rec>\n";
	prntx('rank',$xx);
	prntx('count',$s02{$k});
	prntx('srcip',$_[0]);
	prntx('fqdn',$sip{$_[0]});
	print OUT " </rec>\n";	
	if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</top4xxerrorsperip>\n\n";
    
    
    #********** Top $topmax Files per IP genererating 403/404 *********
    $xx = 1;
    sumhash (\%s0);
    print OUT "<top4xxerrorsperipurl total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 4xx errors per IP and URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "This could inidicate either faultly links on your site, or$CRLF";
    #print OUT "a perpetrator looking for vulnerabilities.$CRLF";
    #printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
    foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top4xxerroripurl rank=\"%d\" count=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $xx, $s0{$k},$_[0], $_[1]);
	prntx('rank',$xx);
	prntx('count',$s0{$k});
	prntx('srcip',$_[0]);
	prntx('url',$_[1]);

	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</top4xxerrorsperipurl>\n\n";
	
        
    # 5xx Status
    #print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
    sumhash (\%s42);

    print OUT "<top_5xx_errors_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 5xx errors per IP');
    $xx = 1;
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "This could indicate various attempts to cause your web server$CRLF";
    #print OUT "to produce erronous results.$CRLF";  
    #printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
    foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerrors count=\"%d\" status=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	prntx('count',$s42{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',$sip{$_[1]});
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</top_5xx_errors_per_ip>\n\n";
    
    
    # 5xx Status
    #******* Top $topmax URL\'s causing Server Errors (5xx) 
    $xx = 1;
    sumhash (\%s4);
    print OUT "<top_5xx_errors_per_url total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top 5xx errors per URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
    foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerrorurl count=\"%d\" status=\"%d\" url=\"%s\" />\n",  $s4{$k},$_[0], $_[1]);
	prntx('count',$s4{$k});
	prntx('status',$_[0]);
	prntx('url',$_[1]);
	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</top_5xx_errors_per_url>\n\n"; 


    #print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
    $xx = 1;
    sumhash (\%s41);
    
    print OUT "<top_5xx_errors_per_ip_url total=\"$sum\" uniq=\"$uniq\">\n";  
    prntx('title', 'Top 5xx errors per IP and URL');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
    foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <top5xxerroripurl count=\"%d\" status=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $s41{$k},$_[0], $_[2], $_[1]);
	prntx('count',$s41{$k});
	prntx('status',$_[0]);
	prntx('srcip',$_[2]);
	prntx('url',$_[1]);
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }

    print OUT "</top_5xx_errors_per_ip_url>\n\n"; 

     
    # Top Referers
    $xx = 1;
    #print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
    sumhash (\%s11);

    #if ($uniq > 0 ) {
    print OUT "<topreferers total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Top Referers');

    foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#$xy = $_[0];
	if ($_[0] =~ m/(.*?)\?(.*)/) {
	    $urlstr = $1; $uristr = uri_escape($2);
	} else {
	    #print "$_[0]\n";
	    $urlstr = $_[0]; $uristr = '';
	}

	#$xy =~ s/\?.*//i;
	#printf(OUT "  <refstr count=\"%d\"  refurl=\"%s\" refuri=\"%s\" />\n",  $s11{$k}, $urlstr, $uristr );
	prntx('count',$s11{$k});
	prntx('refurl',$urlstr);
	prntx('refuri',$uristr);
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</topreferers>\n\n"; 

    
    # Top Browsers
    $xx = 1;
    sumhash (\%s12);
    print OUT "<topbrowsers total=\"$sum\" uniq=\"$uniq\">\n";   
    prntx('title', 'Top Browsers used');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
    foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n"; 
	#printf(OUT "  <topbrows count=\"%d\" browser=\"%s\" />\n",  $s12{$k}, uri_escape($_[0]));
	prntx('count',$s12{$k});
	prntx('browser',uri_escape($_[0]));
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</topbrowsers>\n\n";

    # Check for Cookie Manipulation
    $xx = 1;
    sumhash (\%s14);

    print OUT "<cookiemanip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Suspected Cookie Manipulation');
    #print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
    #print OUT "This could inidicate attempted session hijacking,$CRLF";
    #print OUT "or users coming via a non-ip session aware proxy.$CRLF";
    #printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
    #foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
    $old = '';
    foreach $k (sort keys %s14)
    {
	@@_ = split "¤", $k;
	if ($old ne $_[0]) {
	    #print OUT "$CRLF";
	    #$co = $cookie;
	    $co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
	    printf OUT "  <cookie str=\"%s\" />\n", $co;
	}
	printf OUT "    <cookieinfo count=\"%d\" srcip=\"%s\" fqdn=\"%s\"/>\n", $s14{$k}, $_[1], resolve($_[1]);
	
	
	$old = $_[0];
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</cookiemanip>\n\n";
    

    # Check for Directory scanning / Listing
    $xx = 1;
    sumhash (\%s15);
    print OUT "<subdirlist total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Subdirectory Listing Attempts');
    foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <listing count=\"%d\" status=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s15{$k},$_[2], uri_escape($_[1]), $_[0], resolve($_[0]));
	prntx('count',$s15{$k});
	prntx('status',$_[2]);
	prntx('url',$_[1]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</subdirlist>\n\n";
    

    # List attempted form manipulation
    $xx = 1;
    sumhash (\%s16);

    print OUT "<formmanip total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'List suspected FORM manipulation');
    foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <formstr count=\"%d\" query=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s16{$k}, uri_escape($_[1]), $_[0], resolve($_[0]));
	prntx('count',$s16{$k});
	prntx('query',$_[1]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));
	print OUT "  </rec>\n";
	#if ($xx++ == $topmax) { last; }
    }
    print OUT "</formmanip>\n\n";

    # List attempted Anonymous Proxy Scans
    $xx = 1;
    #print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
    sumhash (\%s17);
    print OUT "<locateproxy total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Attempts to locate Proxy');
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    #print OUT "Successfull attempts could indicate that your web server can$CRLF";
    #print OUT "be used for staging Internet Attacks and fraud.$CRLF";
    #printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
    foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "  <locprox count=\"%d\" status=\"%d\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
	prntx('count', $s17{$k});
	prntx('status', $_[1]);
	prntx('url', $_[2]);
	prntx('srcip',$_[0]);
	prntx('fqdn',resolve($_[0]));

	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    print OUT "</locateproxy>\n\n";


    # List exceedingly Long URL's
    $xx = 1;
    sumhash (\%s18);
    print OUT "<longurlattempt total=\"$sum\" uniq=\"$uniq\">\n";
    prntx('title', 'Exceedingly Long URLs');
    #print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
    #print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
    #printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
    foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	#printf(OUT "<longurl count=\"%d\" status=\"%s\" length=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n  $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] , $_[1], resolve($_[1]));
	prntx('count',$s18{$k});
	prntx('status',$_[3]);
	prntx('length',$_[2]);
	prntx('url',$_[0]);
	prntx('srcip',$_[1]);
	prntx('fqdn',resolve($_[1]));
	
	print OUT "  </rec>\n";
	if ($xx++ == $topmax) { last; }
    }
    
    print OUT "</longurlattempt>\n\n"; 
    
    print OUT "</report>\n";
    
    close OUT;


}



a1134 445
sub printhtml {

    # Check if results are OK, before mailing report
    if ($numlines eq $logformat{'Unknown'}) {
	exit 99;
    }
    slog('Printing text output');
    print OUT "Security Log File Analysis$CRLF";
    print OUT "SLAC v $VERSION$CRLF$CRLF";
    print OUT "Inputfile(s): " . join (" ",@@list). "$CRLF";
    #print OUT "Outputfile: $outfile $CRLF";
    print OUT "Log Start: $mindate$CRLF";
    print OUT "Log Stopp: $maxdate$CRLF";
    #print OUT "Execution started: " . $starttimetext . "$CRLF";
    #print OUT "Execution stopped: " . localtime() . "$CRLF";
    printf OUT "nr of analyzed rows:        %7d $CRLF", $numlines;
    #printf OUT "nr of non-analyzed rows:    %7d $CRLF", $logformat{'UNKNOWN'};
    printf OUT "nr of unique IP-addresses:  %7d $CRLF", $numip;
    print OUT "Rows identified as:$CRLF";
    foreach $x (keys %logformat) {
	printf OUT " %-24s %9d$CRLF", $x, $logformat{$x};
    }

    slog("Nr of Analyzed rows: $numlines");
    slog("Rows/sec: " . $numlines / (time - $starttime + 1));
    #printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);
    #printf OUT "nr of $logformat{'CLF'}\n";
    
    if ($opt_N ne '') 
    {  print OUT "Name Resolution has NOT been performed.$CRLF$CRLF"; }
    #else
    #{  print OUT "Name Resolution has been performed.$CRLF$CRLF"; }
    
    # Show number of hits/hour
    print OUT "$CRLF********** Hits / hour ********** $CRLF";
    sumhash (\%s7);
    #print OUT "Totally $sum and $uniq unique.$CRLF";
    printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
    #foreach $k (sort keys %s7)
    for ($k=0;$k<24;$k++)
    {
	@@_ = split "¤", $k;
	$hits = $s7{sprintf("%02d", $k)};
	if ($hits eq '') { $hits = '0'};
	printf (OUT "%7d  %9s  %-50s$CRLF",  $_[0], $hits, "*" x ($hits / ($hrmax+1) * 40));
    }
    


    # Show number of hits/hour in PNG format

    #my $data = GD::Graph::Data->new();
    #my $name = '/usr/local/apache/htdocs/toptalk';
    #print OUT "$CRLF********** Hits / hour ********** $CRLF";
    #sumhash (\%s7);
    #for ($k=0;$k<24;$k++)
    #{
#	$hits = $s7{sprintf("%02d", $k)};
#        if ($hits eq '') { $hits = '0'};
#	$data->add_point($k, $hits);
#}
    #my $my_graph = GD::Graph::bars->new();
    #$my_graph->set(x_label  => 'Hour',
#		   y_label  => 'Hits',
#		   title           => "Hits per hour, $mindate",
#		   y_max_value     => $max,
#		   y_tick_number   => 8,
#		   y_label_skip    => 2,
#		   #x_labels_vertical => 1,
#		   # shadows
#		   bar_spacing     => 8,
#		   shadow_depth    => 2,
#		   shadowclr       => 'dred',
#      		   transparent     => 0,
#		   )
#	or warn $my_graph->error;

    #$my_graph->plot($data) or die $my_graph->error;
    #save_chart($my_graph, $name);


    # Dangerous files...
    print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
    sumhash (\%s3);
    if ($uniq gt 0) {
	print OUT "This could inidicate a serious security breach.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
	foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
	{
	    @@_ = split "¤", $k;
	    printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k},$_[0], $_[1]);
	}
    } else {
	printf OUT "None. $CRLF";
    }
    
    # Unauthorized
    print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
    sumhash (\%s2);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT  "%7s  %5s  %-15s  %-9s %s$CRLF", 'Count', 'Status', 'Src IP', 'User', 'URL';
	foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT  "%7d  %5s   %-15s  %-9s %s$CRLF",  $s2{$k},$_[0], $_[1], $_[3], $_[2]);
	}
    } else {
	printf OUT "None. $CRLF";
    }

    
    print OUT "$CRLF********** Logged in Users **********$CRLF";
    sumhash (\%s10);
    if ($uniq gt 0) {   
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
	foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9d  %-15s$CRLF",  $s10{$k},$_[0]);
	}
    } else {
        printf OUT "None. $CRLF";
    }

    print OUT "$CRLF********** Logged in users per IP-address (excl Anonymous) **********$CRLF";
    sumhash (\%s1);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%9s  %-15s  %-15s  %s$CRLF",  'Count', 'User', 'Src-IP', 'FQDN';
	foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
	{
	    @@_ = split "¤", $k;
	    printf OUT "%9d  %-15s  %-15s  %s$CRLF",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
	}
    } else {
        printf OUT "None. $CRLF";
    }
    
    # Count of all Statuscodes...
    print OUT "$CRLF********** Count of HTTP statuscodes ********** $CRLF";
    sumhash (\%s5);
    
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Status $CRLF";
    foreach $k (sort keys %s5 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d (%6.2f%%) HTTP Status: %-4d  %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
	printf(OUT "%9d (%6.2f%%)    %4s %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
    }

    # Count of all HTTP Methods...
    print OUT "$CRLF********** Count of HTTP Methods ********** $CRLF";
    sumhash (\%s19);
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Method $CRLF";
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
        @@_ = split "¤", $k;
	printf(OUT "%9d (%6.2f%%)     %s$CRLF",  $s19{$k}, ($s19{$k}*100/$sum),    $k,);
}


    
    # Count of all HTTP Versions...
    print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
    sumhash (\%s6);
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )    HTTP-Version $CRLF";
    foreach $k (sort {$s6{$b} <=> $s6{$a}} keys %s6 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	printf(OUT "%9d (%6.2f%%)    %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
    }
    
    # List illegal HTTP Versions...
    print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
    sumhash (\%s61);
    if ($uniq gt 0) {
	print OUT "This could inidicate attempts to manipulate and compromise the webserver.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s %-25s %-15s %s %-s$CRLF", 'Count' , 'HTTP String',  'IP', 'FQDN');
	foreach $k (sort {$s61{$b} <=> $s61{$a}} keys %s61 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
	}
    } else {
	printf OUT "None. $CRLF";
    }

    # List the Top HIT'ers
    $xx = 1;
    sumhash(\%iptab);
    print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
    #sumhash (\%iptab);
    #print OUT ($uniq >= $topmax) ? $topmax : $uniq;
    print OUT "Totally $sum and $uniq unique.$CRLF";
    printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
    foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
    {
	@@_ = split "¤", $k;
	printf(OUT "%4d (%6.2f%%)  %7d  %-15s  %-30s$CRLF", $xx, ($iptab{$k}*100/$sum), $iptab{$k},$_[0], resolve($_[0]));
	if ($xx++ == $topmax) { last; }
    }
    
    
    # List attempts to access non-existing pages
    print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
    
    sumhash (\%s01);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
	foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %7d  %-15s$CRLF",  $s01{$k},$_[0], $_[1]);
	}
	
	print OUT "$CRLF$CRLF********** Top $topmax IP\'s generating 403/404 **********$CRLF";
	$xx = 1;
	sumhash (\%s02);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "The top IP's on this list could be the source for vulnerability scans of your  site.$CRLF";
	printf(OUT "%4s %7s   %-15s  %s$CRLF",  'Rank', "Count", "IP-Address", "FQDN");
	foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
	{
	    @@_ = split "¤", $k;
	    #printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	    printf(OUT "%4d %7d   %-15s  %s$CRLF",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "$CRLF$CRLF********** Top $topmax Files per IP genererating 403/404 **********$CRLF";
	$xx = 1;
	sumhash (\%s0);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could inidicate either faultly links on your site, or$CRLF";
	print OUT "a perpetrator looking for vulnerabilities.$CRLF";
	printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
	foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%4d %7d  %-15s  %s$CRLF",  $xx, $s0{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        printf OUT "None. $CRLF";
    }
    
	
    
    # 5xx Status
    print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
    sumhash (\%s42);
    if ($uniq > 0) {
	$xx = 1;
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could indicate various attempts to cause your web server$CRLF";
	print OUT "to produce erronous results.$CRLF";  
	printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
	foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-15s %s$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	    if ($xx++ == $topmax) { last; }
	}
   
    
	# 5xx Status
	print OUT "$CRLF********** Top $topmax URL\'s causing Server Errors (5xx) ********** $CRLF";
	$xx = 1;
	sumhash (\%s4);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
	foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-20s$CRLF",  $s4{$k},$_[0], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
	$xx = 1;
	sumhash (\%s41);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
	foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-7d  %-15s  %s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
        printf OUT "None. $CRLF";
    }
 
    # Top Referers
    $xx = 1;
    print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
    sumhash (\%s11);
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Referer' ;
	foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s11{$k},$_[0]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
    }
    
    # Top Browsers
    $xx = 1;
    print OUT "$CRLF********** Top $topmax Browsers ********** $CRLF";      
    sumhash (\%s12);
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
	foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s12{$k},$_[0]);             
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
    }

    # Check for Cookie Manipulation
    $xx = 1;
    print OUT "$CRLF********** Same Cookie from different IP-addresses ********** $CRLF";
    sumhash (\%s14);
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
	print OUT "This could inidicate attempted session hijacking,$CRLF";
	print OUT "or users coming via a non-ip session aware proxy.$CRLF";
	printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
	#foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
	$old = '';
	foreach $k (sort keys %s14)
	{
	    #print "\$k: $k\n";
	    @@_ = split "¤", $k;
	    #print "\$_\[0\]:$_[0]$CRLF";
	    if ($old ne $_[0]) {
		print OUT "$CRLF";
		#$co = $cookie;
		$co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
		    
		printf OUT "Cookie: %s$CRLF", $co;
	    }
	    printf OUT "%9d %-15s %s$CRLF", $s14{$k}, $_[1], resolve($_[1]);
	    
	    $old = $_[0];
	    #if ($xx++ == $topmax) { last; }
	}
    } else {
	print OUT "None found.$CRLF";
    }

    # Check for Directory scanning / Listing
    $xx = 1;
    print OUT "$CRLF********** Unsuccessful Subdirectory Listing Attempts ********** $CRLF";
    sumhash (\%s15);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        #print OUT "This could inidicate attempted session hijacking.$CRLF";
        printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %7s %-40s %-15s %s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }

    # List attempted form manipulation
    $xx = 1;
    print OUT "$CRLF********** Suspected Form Data Manipulation ********** $CRLF";
    sumhash (\%s16);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "This could inidicate attempted unauthorized database access.$CRLF";
        printf OUT "%7s %-30s %-15s %-15s %-20s$CRLF", 'Count', 'Query', 'IP', 'FQDN' ;
        foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %-30s %-15s %-15s$CRLF",  $s16{$k}, $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }

    # List attempted Anonymous Proxy Scans
    $xx = 1;
    print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
    sumhash (\%s17);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "Successfull attempts could indicate that your web server can$CRLF";
	print OUT "be used for staging Internet Attacks and fraud.$CRLF";
        printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6d %-40s %-15s %s$CRLF",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
    }

    # List exceedingly Long URL's
    $xx = 1;
    print OUT "$CRLF********** Exceedingly Long URL's ********** $CRLF";
    sumhash (\%s18);
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
        print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
        printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
        foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6s %10s  %-30s\n%26s %-15s %s $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] ,'', $_[1], resolve($_[1]));
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	print OUT "None found.$CRLF";
    }
    
    close OUT;
}

@


1.49
log
@fixes to report sorting
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.48 2003/04/16 14:43:31 mibl Exp $
# $Revision: 1.48 $
d50 5
a54 1
#
d57 1
a57 1
$VERSION = '2.32';
d320 1
d359 1
a359 1
	$logformat{'Ignored'}++;
d361 1
a361 1
	    $logformat{'Comments'}++;
d364 2
a365 1
            $iisext = 1;
d367 4
a370 4
	#else
	#{
	#    $logformat{'Unknown'}++;
	#}
d379 1
d386 6
d399 5
d412 5
d419 3
d430 5
a434 5
	$date =~ m/(\d\d\d\d)\-(\d\d)\-(\d\d)\s(\d\d)\:(\d\d)\:(\d\d)/;
	$day = $3; $mon = $2; $yr = $1; $hr = $4; $mi = $5; $se = $6;
	#if ($date =~ m/(\d\d\d\d)\-(\d\d)\-(\d\d)\s(\d\d)\:(\d\d)\:(\d\d)/) {
	#    $day = $3; $mon = $2; $yr = $1; $hr = $4; $mi = $5; $se = $6;
	#}
d488 1
d595 3
a597 1
	if ($sip{$ip} eq undef) {	$sip{$ip} = resolve($ip) };
d685 5
d1317 9
a1342 31
    # Show number of hits/hour in PNG format

    #my $data = GD::Graph::Data->new();
    #my $name = '/usr/local/apache/htdocs/toptalk';
    #print OUT "$CRLF********** Hits / hour ********** $CRLF";
    #sumhash (\%s7);
    #for ($k=0;$k<24;$k++)
    #{
#	$hits = $s7{sprintf("%02d", $k)};
#        if ($hits eq '') { $hits = '0'};
#	$data->add_point($k, $hits);
#}
    #my $my_graph = GD::Graph::bars->new();
    #$my_graph->set(x_label  => 'Hour',
#		   y_label  => 'Hits',
#		   title           => "Hits per hour, $mindate",
#		   y_max_value     => $max,
#		   y_tick_number   => 8,
#		   y_label_skip    => 2,
#		   #x_labels_vertical => 1,
#		   # shadows
#		   bar_spacing     => 8,
#		   shadow_depth    => 2,
#		   shadowclr       => 'dred',
#      		   transparent     => 0,
#		   )
#	or warn $my_graph->error;

    #$my_graph->plot($data) or die $my_graph->error;
    #save_chart($my_graph, $name);

@


1.48
log
@Modified 'Dangerous Files'
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.47 2003/04/16 14:09:33 mibl Exp mibl $
# $Revision: 1.47 $
d320 1
d342 1
d354 1
a354 1
	$logformat{'Unknown'}++;
d356 1
d361 4
d402 2
d406 4
d512 1
d514 1
a514 1
    $numlines++;
d655 2
d1423 1
a1423 1
    foreach $k (sort keys %s6 )
d1437 1
a1437 1
	foreach $k (sort keys %s61 )
@


1.47
log
@Fixed New Subdir listing per IP and Status
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.46 2003/04/16 13:27:06 mibl Exp mibl $
# $Revision: 1.46 $
d542 1
a542 1
	if ($url =~ m/passwd|shadow|nc.exe|cmd1\.exe|ncx\.exe|inetd|\/services|access\.log|cmd\.exe|\.\%..\%..|\.url|\.bat/ix) {
@


1.46
log
@Added more subdir listing features
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.45 2003/04/16 12:27:06 mibl Exp mibl $
# $Revision: 1.45 $
d505 1
a505 1
        $url = substr($url, 0, 15) . ' [Truncated...] ' . substr($url, length($url)-15,15);
d1119 1
a1119 1
	    $co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated by SLAC ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
d1590 1
a1590 1
		$co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated by SLAC ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
d1618 2
d1622 1
a1622 1
	    ($ip1, $url1) = split "¤", $k;
d1624 5
a1628 2
		($ip2, $url2, $status2) = split "¤", $k;
		if ($ip1 eq "") {} 
d1630 1
d2054 1
a2054 1
		$co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated by SLAC ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
@


1.45
log
@Save before adding modified subdir listing report
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.44 2003/04/14 12:30:59 mibl Exp mibl $
# $Revision: 1.44 $
d1617 10
d1631 2
@


1.44
log
@*** empty log message ***
@
text
@d1 3
a3 3
#!/usr/local/bin/perl
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.43 2003/04/08 09:04:22 mibl Exp mibl $
# $Revision: 1.43 $
d87 3
a89 3
use GD::Graph::bars;
use GD::Graph::hbars;
use GD::Graph::Data;
d621 1
d1853 1
a1853 1
    foreach $k (sort keys %s6 )
d1867 1
a1867 1
	foreach $k (sort keys %s61 )
@


1.43
log
@*** empty log message ***
@
text
@d2 3
a4 3
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.42 2003/03/31 20:23:21 mibl Exp mibl $
# $Revision: 1.42 $
# Mike Blomgren 2001-02-21
d55 3
a57 3
#$res = 'true';  # Set to true if we should attempt to resolve IP's to FQDN
$res = 'false';

d102 1
a102 1

d576 2
a577 1
    if ((not $httpver =~ m/^HTTP\/\d\.\d$|N\/A/i) && (defined $httpver))
d1231 3
d1680 448
@


1.42
log
@Added CONNECT method to Proxy Scan
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.41 2003/03/31 14:22:56 mibl Exp mibl $
# $Revision: 1.41 $
d409 1
a448 2
		#if (($date le $mindate) || ($mindate eq '')) {$mindate = $date};
		#if (($date gt $maxdate) || ($maxdate eq '')) {$maxdate = $date};
a449 1
	    
@


1.41
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.39 2003/03/30 19:49:05 mibl Exp mibl $
# $Revision: 1.39 $
d630 3
a632 2
    # Check for Anonymous Proxy Scanning, i.e. URL starts with 'HTTP...' 
    if ($url =~ m/^[\w]+?\s+HTTP[s]*\:/i) {
a640 1

@


1.40
log
@*** empty log message ***
@
text
@d728 1
a728 1
    prntx('title','Attempts to retrieve \'dangerous\' files');
a808 1
    
d810 1
a828 1
    
d830 1
a830 1
    
d849 1
d867 1
a867 1

d886 1
a902 1

a903 1
    
a905 1

a907 1
    
a908 1

d910 1
d919 2
a920 1
	prntx('url',uri_escape($_[1]));
d932 1
d955 1
d981 1
a981 1
    
d1008 1
d1028 1
d1030 1
d1047 1
d1053 1
d1056 2
d1062 1
a1062 1
	$xy = $_[0];
d1064 1
a1064 1
	    $urlstr = uri_escape($1); $uristr = uri_escape($2);
d1067 1
a1067 1
	    $urlstr = uri_escape($_[0]); $uristr = '';
d1085 1
a1085 1
    
d1106 1
d1135 1
d1157 1
d1177 1
d1203 1
@


1.39
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.38 2003/03/28 14:04:12 mibl Exp mibl $
# $Revision: 1.38 $
d676 1
d728 1
d741 1
a741 1
	print OUT "<dangerousfile count=\"$s3{$k}\" srcip=\"$_[0]\" url=\"$_[1]\"/>\n";
d806 1
d808 18
@


1.38
log
@modofied xml output to to print each data in it's own <tag>.
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.37 2003/03/28 12:47:49 mibl Exp mibl $
# $Revision: 1.37 $
d412 1
a412 1
	     \s\"(.*\s)               # Url
d678 1
a678 1
	#print OUT "<entry>\n";
d680 1
a680 1
	print OUT "<logformat>\n";
d683 2
a684 2
	print OUT "</logformat>\n";
	#print OUT "</entry>\n";
d701 1
d713 1
a713 1
	print OUT "<rec>\n";
d716 1
a716 1
	print OUT "</rec>\n";
a724 2


a725 1

d727 1
a727 1
    
a746 1

d749 1
d772 1
a788 1
    
d790 1
a804 18
    sumhash (\%s5);
    
    print OUT "<statuscodes total=\"$sum\" uniq=\"$uniq\">\n";
    foreach $k (sort keys %s5 )
    {
	@@_ = split "¤", $k;
	print OUT "  <rec>\n";
	prntx('count',$s5{$k});
	prntx('status',$_[0]);
	prntx('statusname',$STATCODE{$_[0]});
	print OUT "  </rec>\n";
	
	#printf(OUT "<codes count=\"%d\" status=\"%s\" statusname=\"%s\"/>\n",  $s5{$k}, $_[0], $STATCODE{$_[0]});
	#print OUT "</entry>\n";
    }
    print OUT "</statuscodes>\n\n";
    

d916 1
a916 1
	#print OUT "<entry>\n";
d918 7
a924 2
	printf(OUT "  <top4xxerror rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	#print OUT "</entry>\n";
d942 8
a949 3
	#print OUT "<entry>\n";
	printf(OUT "  <top4xxerroripurl rank=\"%d\" count=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $xx, $s0{$k},$_[0], $_[1]);
	#print OUT "</entry>\n";
d960 1
d969 7
a975 3
	#print OUT "<entry>\n";
	printf(OUT "  <top5xxerrors count=\"%d\" status=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	#print OUT "</entry>\n";
d992 6
a997 3
	#print OUT "<entry>\n";
	printf(OUT "  <top5xxerrorurl count=\"%d\" status=\"%d\" url=\"%s\" />\n",  $s4{$k},$_[0], $_[1]);
	#print OUT "</entry>\n";
d1012 7
a1018 3
	#print OUT "<entry>\n";
	printf(OUT "  <top5xxerroripurl count=\"%d\" status=\"%d\" srcip=\"%s\" url=\"%s\" />\n",  $s41{$k},$_[0], $_[2], $_[1]);
	#print OUT "</entry>\n";
d1033 1
a1033 1
	#print OUT "<entry>\n";
d1043 5
a1047 2
	printf(OUT "  <refstr count=\"%d\"  refurl=\"%s\" refuri=\"%s\" />\n",  $s11{$k}, $urlstr, $uristr );
	#print OUT "</entry>\n";
d1050 1
a1050 1
    print OUT "</topreferers>\n"; 
d1063 5
a1067 3
	#print OUT "<entry>\n"; 
	printf(OUT "  <topbrows count=\"%d\" browser=\"%s\" />\n",  $s12{$k}, uri_escape($_[0]));             
	#print OUT "</entry>\n";
d1071 1
a1071 1
    print OUT "</topbrowsers>\n";
d1095 1
d1109 8
a1116 3
	#print OUT "<entry>\n";
	printf(OUT "  <listing count=\"%d\" status=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s15{$k},$_[2], uri_escape($_[1]), $_[0], resolve($_[0]));
	#print OUT "</entry>\n";
d1130 7
a1136 3
	#print OUT "<entry>\n";
	printf(OUT "  <formstr count=\"%d\" query=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s16{$k}, uri_escape($_[1]), $_[0], resolve($_[0]));
	#print OUT "</entry>\n";
d1153 9
a1161 3
	#print OUT "<entry>\n";
	printf(OUT "  <locprox count=\"%d\" status=\"%d\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
	#print OUT "</entry>\n";
d1166 1
d1177 10
a1186 3
	#print OUT "<entry>\n";
	printf(OUT "<longurl count=\"%d\" status=\"%s\" length=\"%s\" url=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n  $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] , $_[1], resolve($_[1]));
	#print OUT "</entry>\n";
@


1.37
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.36 2003/03/28 12:46:47 mibl Exp mibl $
# $Revision: 1.36 $
a53 1
$REV = "$Revision: $";
d705 1
d711 5
a715 1
	printf (OUT "  <hits hour=\"%d\">%s</hits>\n",  $_[0], $hits);
d717 1
a717 1
    
d736 5
d742 1
a746 3

    

a750 1

d756 8
a763 1
	printf OUT " <unauthorized_user count=\"%s\" status=\"%s\" srcip=\"%s\" user=\"%s\" url=\"%s\"/>\n", $s2{$k},$_[0], $_[1], $_[3], $_[2];
d779 5
a783 4
	#print OUT "<entry>\n";
	printf(OUT " <loggedinuser count=\"%d\" user=\"%s\"/>\n",  $s10{$k}, $_[0]);
	#print OUT "</entry>\n";
	
d795 7
a801 3
	#print OUT "<entry>\n";
	printf OUT " <userperip count=\"%d\" user=\"%s\" srcip=\"%s\" fqdn=\"%s\"/>\n",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
	#print OUT "</entry>\n";
d812 7
a818 2
	#print OUT "<entry>\n";
	printf(OUT "<codes count=\"%d\" status=\"%s\" statusname=\"%s\"/>\n",  $s5{$k}, $_[0], $STATCODE{$_[0]});
d833 4
a836 1
	#print OUT "<entry>\n";
a837 2
	#print OUT "</entry>\n";
	
d851 4
d856 1
a856 1
	printf(OUT "  <version count=\"%d\" versionstr=\"%s\"/>\n",  $s6{$k}, $_[0]);
d869 7
a875 1
	printf(OUT "<badhttp count=\"%s\" httpstr=\"%s\" srcip=\"%s\" fqdn=\"%s\" />\n",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
d892 7
a898 3
	#print OUT "<entry>\n";
	printf(OUT "  <hitter rank=\"%d\" count=\"%d\" srcip=\"%s\" fqdn=\"%s\" />\n", $xx, , $iptab{$k},$_[0], resolve($_[0]));
	#print OUT "</entry>\n";
d917 6
a922 3
	#print OUT "<entry>\n";
	printf(OUT "  <error4xx count=\"%d\" httpstatus=\"%d\" url=\"%s\" />\n",  $s01{$k}, $_[0], uri_escape($_[1]));
	#print OUT "</entry>\n";
@


1.36
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.35 2003/03/25 21:43:20 mibl Exp mibl $
$rev =" $Revision: 1.35 $ ";
d54 1
@


1.35
log
@xml mods.
@
text
@d2 2
a3 3
# $Header: /usr/local/secsrch/RCS/secsrch.pl,v 1.34 2003/03/25 08:47:18 mibl Exp mibl $

# $Revision: 1.34 $
@


1.34
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.33 2003/03/24 20:17:34 mibl Exp mibl $
d4 1
a4 1
# $Revision: 1.33 $
d43 1
d54 1
a54 1
$VERSION = '2.31';
d62 3
d654 1
d657 11
a667 4
    print OUT "<stats execstart=\"$starttimetext\" execstop=\"" . localtime();
    print OUT "\" rowsanalysed=\"$numlines\" nripaddr=\"$numip\" perf=\"";
    print OUT $numlines / (time - $starttime + 1) . "\" ";
    print OUT "nameresoff=\"$opt_N\">\n";
d675 1
a675 1
    print OUT "</stats>\n";
d680 5
a684 1
	printf OUT "  <logformat format=\"%s\" nrfound=\"%d\" />\n", $x, $logformat{$x};
d1592 10
@


1.33
log
@*** empty log message ***
@
text
@a0 1

d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.32 2003/03/24 19:51:01 mibl Exp mibl $
d4 1
a4 1
# $Revision: 1.32 $
@


1.32
log
@*** empty log message ***
@
text
@d1 1
d3 1
a3 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.31 2003/03/24 13:16:10 root Exp mibl $
d5 1
a5 1
# $Revision: 1.31 $
@


1.31
log
@*** empty log message ***
@
text
@d2 3
a4 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.30 2003/03/24 08:40:07 root Exp root $
# $Revision: 1.30 $
@


1.30
log
@XML fixes
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.29 2003/03/20 14:49:20 root Exp root $
# $Revision: 1.29 $
d646 2
a647 1
    print OUT "<secsrchreport version=\"$VERSION\" logdatestart=\"$mindate\" logdateend=\"$maxdate\">\n";
d708 1
d1102 1
a1102 1
    print OUT "</secsrchreport>\n";
d1600 2
a1601 2
    #if ($opt_N eq 1) {return $mhost;}
    if ($opt_N eq 1) {return ''}
d1618 1
a1618 1
    openlog('SecSrch.pl', 'cons,pid', 'user');
@


1.29
log
@Changed XML output
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.28 2003/03/19 13:27:17 root Exp root $
# $Revision: 1.28 $
d57 5
d77 2
d640 1
a640 1
    print OUT '<?xml version="1.0" ?>' . "\n";
d665 3
a667 3
	print OUT "<entry>\n";
	printf OUT "  <logformat>%s</logformat>\n  <nrfound>%d</nrfound>\n", $x, $logformat{$x};
	print OUT "</entry>\n";
d706 1
a706 1
    print OUT "<dangerousfiles>\n";
d830 1
a830 1
    print OUT "<tophitters>\n";
d861 1
a861 1
	printf(OUT "  <error4xx count=\"%d\" httpstatus=\"%d\" url=\"%s\" />\n",  $s01{$k},$_[0], $_[1]);
d875 1
a875 1
	print OUT "<entry>\n";
d877 2
a878 2
	printf(OUT "  <rank>%d</rank>\n  <count>%d</count>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	print OUT "</entry>\n";
d896 3
a898 3
	print OUT "<entry>\n";
	printf(OUT "  <rank>%d</rank>\n  <count>%d</count>\n  <srcip>%s</srcip>\n  <url>%s</url>\n",  $xx, $s0{$k},$_[0], $_[1]);
	print OUT "</entry>\n";
d917 4
a920 4
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	print OUT "</entry>\n";
	if ($xx++ == $topmax) { last; }
d936 3
a938 3
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <url>%s</url>\n",  $s4{$k},$_[0], $_[1]);
	print OUT "</entry>\n";
d953 4
a956 4
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <srcip>%s</srcip>\n  <url>%s</url>\n",  $s41{$k},$_[0], $_[2], $_[1]);
	print OUT "</entry>\n";
	if ($xx++ == $topmax) { last; }
d970 13
a982 4
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <referer>%s</referer>\n  ",  $s11{$k},$_[0]);
	print OUT "</entry>\n";
	if ($xx++ == $topmax) { last; }
d997 4
a1000 4
	print OUT "<entry>\n"; 
	printf(OUT "  <count>%d</count>\n  <browser>%s</browser>\n",  $s12{$k},$_[0]);             
	print OUT "</entry>\n";
	if ($xx++ == $topmax) { last; }
d1023 1
a1023 1
	    printf OUT "  <cookie>%s</cookie>\n", $co;
d1025 1
a1025 1
	printf OUT "    <count>%d</count>\n    <srcip>%s</srcip>\n    <fqdn>%s</fqdn>\n", $s14{$k}, $_[1], resolve($_[1]);
d1040 4
a1043 4
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <status>%s</status>\n  <url>%s</url>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
	print OUT "</entry>\n";
	if ($xx++ == $topmax) { last; }
d1056 4
a1059 4
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <query>%s</query>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $s16{$k}, $_[1], $_[0], resolve($_[0]));
	print OUT "</entry>\n";
	if ($xx++ == $topmax) { last; }
d1075 3
a1077 3
	print OUT "<entry>\n";
	printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <url>%s</url>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
	print OUT "</entry>\n";
d1085 1
a1085 1
    print OUT "<longurl total=\"$sum\" uniq=\"$uniq\">\n";
d1092 3
a1094 3
	print OUT "<entry>\n";
	printf(OUT "<count>%d</count>\n  <status>%s</status>\n  <length>%s</length>\n  <url>%s</url>\n <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n  $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] ,'', $_[1], resolve($_[1]));
	print OUT "</entry>\n";
d1098 1
a1098 1
    print OUT "</longurl>\n\n"; 
d1641 5
@


1.28
log
@more xml output
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.27 2003/03/18 21:52:36 root Exp root $
# $Revision: 1.27 $
d82 1
a82 1
getopts('hvNsX');  # If set, then don't do a name lookup
d88 1
d241 1
a241 1
if (-f $outfile) 
d401 4
a404 3
	     \s\"(.*?)\s*               # Request
	     (?:(\?.*?))?
	     (?:(HTTP\/.*?))?\" 		  # Match regardless of HTTP Version.
d410 1
a410 1
	     /ox )                    
d416 1
d422 5
d563 1
d567 1
a567 1
    if ((not $httpver =~ m/^HTTP\/\d\.\d$|N\/A/) && (defined $httpver))
d619 1
a619 1
    # Check for Anonymous Proxy Scanning
d639 1
a640 1
    print OUT "<version>$VERSION</version>\n";
d642 5
a647 2
    print OUT "<logdatestart>" . $mindate . "</logdatestart>\n";
    print OUT "<logdateend>" . $maxdate . "</logdateend>\n";
d650 1
a650 1
    printf OUT "<analyzedrows>%d</analyzedrows>\n", $numlines;
d652 3
a654 1
    printf OUT "<nrofipaddresses>%d</nrofipaddresses>\n", $numip;
d658 3
a660 1
	printf OUT "<logformat>%s</logformat><nrfound>%d</nrfound>\n", $x, $logformat{$x};
d670 4
a673 4
    if ($opt_N ne '') 
    {  print OUT "<nameresolution>Off</nameresolution>\n"; }
    else
    {  print OUT "<nameresolution>On</nameresolution>\n"; }
d686 1
a686 1
	printf (OUT "  <hour>%d</hour><hits>%s</hits>\n",  $_[0], $hits);
d698 10
a707 13
    if ($uniq gt 0) {
	print OUT "<dangerousfiles>\n";
	print OUT "This could inidicate a serious security breach.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s  %-50s$CRLF",  'Count', 'Src IP', 'URL' ;
	foreach $k (sort {$s3{$b} <=> $s3{$a}} keys %s3 )
	{
	    @@_ = split "¤", $k;
	    printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k},$_[0], $_[1]);
	}
	print OUT "</dangerousfiles>\n\n";
    } else {
	#printf OUT "None. $CRLF";
d709 2
a710 1

d718 9
a726 9
    if ($uniq gt 0) {
	print OUT "<unauthorized total=\"$sum\" uniq=\"$uniq\">\n";
	foreach $k (sort {$s2{$b} <=> $s2{$a}} keys %s2 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf OUT " <count>%s</count>\n <status>%s</status>\n <srcip>%s</srcip>\n <user>%s</user>\n <url>%s</url>\n", $s2{$k},$_[0], $_[1], $_[3], $_[2];
	    print OUT "</entry>\n";
	}
d728 2
a729 2
    	print OUT "</unauthorized>\n\n";
    }
d733 11
a743 15
    if ($uniq gt 0) {   
	print OUT "<logged_in_users total=\"$sum\" uniq=\"$uniq\">\n";
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
	foreach $k (sort {$s10{$b} <=> $s10{$a}} keys %s10 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT " <count>%d</count>\n <user>%s</user>\n",  $s10{$k},$_[0]);
	    print OUT "</entry>\n";
	    
	}
	print OUT "</logged_in_users>\n\n";
    } else {
        printf OUT "None. $CRLF";
d745 1
d747 1
a747 1

d750 8
a757 12
    if ($uniq gt 0) {
	print OUT "<logged_in_users_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
	foreach $k (sort {$s1{$b} <=> $s1{$a}} keys %s1 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf OUT " <count>%d</count>\n <user>%s</user>\n <srcip>%s</srcip>\n <fqdn>%s</fqdn>\n",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
	    print OUT "</entry>\n";
	}
	print OUT "</logged_in_users_per_ip>\n\n";
    } else {
        printf OUT "None. $CRLF";
d759 2
a760 1
    
d763 8
a770 10
    if (uniq gt 0)  {
	print OUT "<statuscodes total=\"$sum\" uniq=\"$uniq\">\n";
	foreach $k (sort keys %s5 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <count>%d</count>\n  <status>%s</status>\n  <statusname>%s</statusname>\n",  $s5{$k}, $_[0], $STATCODE{$_[0]});
	    print OUT "</entry>\n";
	}
	print OUT "</statuscodes>\n\n";
d772 2
d778 12
a789 2
    if ($uniq gt 0) {
	print OUT "<httpmethods total=\"$sum\" uniq=\"$uniq\">\n";
a790 10
	foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <count>%d</count>\n  <method>%s</method>\n",  $s19{$k}, $k,);
	    print OUT "</entry>\n";
	    
	}
	print OUT "</httpmethods>\n\n";	
    }
d796 8
a803 8
    #if ($uniq gt 0) {
	print OUT "<httpversions total=\"$sum\" uniq=\"$uniq\">\n";
	foreach $k (sort keys %s6 )
	{
	    @@_ = split "¤", $k;
	    #printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	    printf(OUT "  <count>%d</count>\n  <version>%s</version>\n",  $s6{$k}, $_[0]);
	}
d805 1
a805 1
    #}
d815 1
a815 1
	printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
d832 3
a834 2
	print OUT "<entry>\n";
	printf(OUT "  <rank>%d</rank>\n  <count>%d</count>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n", $xx, , $iptab{$k},$_[0], resolve($_[0]));
d836 1
a836 1
	print OUT "</entry>\n";
a845 13
    if ($uniq gt 0) {
	print OUT "<4xx_errors total=\"$sum\" uniq=\"$uniq\">\n";
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
	foreach $k (sort {$s01{$b} <=> $s01{$a}} keys %s01 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <count>%d</count>\n  <httpstatus>%d</httpstatus>\n  <url>%s</url>\n",  $s01{$k},$_[0], $_[1]);
	    print OUT "</entry>\n";
	}
	
	print OUT "</4xx_errors>\n\n";
d847 26
a872 41

	#Top IP\'s generating 403/404 **********
	$xx = 1;
	sumhash (\%s02);
	print OUT "<top_4xx_errors_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#print OUT "The top IP's on this list could be the source for vulnerability scans of your  site.$CRLF";
	#printf(OUT "%4s %7s   %-15s  %s$CRLF",  'Rank', "Count", "IP-Address", "FQDN");
	foreach $k (sort {$s02{$b} <=> $s02{$a}} keys %s02 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    #printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
	    printf(OUT "  <rank>%d</rank>\n  <count>%d</count>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $xx, $s02{$k},$_[0], $sip{$_[0]});
	    print OUT "</entry>\n";
	    if ($xx++ == $topmax) { last; }
	}
	
	print OUT "</top_4xx_errors_per_ip>\n\n";


	#********** Top $topmax Files per IP genererating 403/404 *********
	$xx = 1;
	sumhash (\%s0);
	print OUT "<top_4xx_errors_per_ip_url total=\"$sum\" uniq=\"$uniq\">\n";
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#print OUT "This could inidicate either faultly links on your site, or$CRLF";
	#print OUT "a perpetrator looking for vulnerabilities.$CRLF";
	#printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
	foreach $k (sort {$s0{$b} <=> $s0{$a}} keys %s0 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <rank>%d</rank>\n  <count>%d</count>\n  <srcip>%s</srcip>\n  <url>%s</url>\n",  $xx, $s0{$k},$_[0], $_[1]);
	    print OUT "</entry>\n";
	    if ($xx++ == $topmax) { last; }
	}
	print OUT "</top_4xx_errors_per_ip_url>\n\n";
	
    } else {
        printf OUT "None. $CRLF";
d875 20
d896 1
a896 1
    
a899 17
    if ($uniq > 0) {
	print OUT "<top_5xx_errors_per_ip total=\"$sum\" uniq=\"$uniq\">\n";
	$xx = 1;
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#print OUT "This could indicate various attempts to cause your web server$CRLF";
	#print OUT "to produce erronous results.$CRLF";  
	#printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
	foreach $k (sort {$s42{$b} <=> $s42{$a}} keys %s42 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <srcip>%s</srcip>\n  <fqdn>%s</fqdn>\n",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
	    print OUT "</entry>\n";
	    if ($xx++ == $topmax) { last; }
	}
   
	print OUT "</top_5xx_errors_per_ip>\n\n";
d901 34
a935 16
	# 5xx Status
	#******* Top $topmax URL\'s causing Server Errors (5xx) 
	$xx = 1;
	sumhash (\%s4);
	print OUT "<top_5xx_errors_per_url total=\"$sum\" uniq=\"$uniq\">\n";
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
	foreach $k (sort {$s4{$b} <=> $s4{$a}} keys %s4 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <url>%s</url>\n",  $s4{$k},$_[0], $_[1]);
	    print OUT "</entry>\n";
	    if ($xx++ == $topmax) { last; }
	}
	print OUT "</top_5xx_errors_per_url>\n\n"; 
d937 14
d952 2
a953 20
	#print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
	$xx = 1;
	sumhash (\%s41);
	print OUT "<top_5xx_errors_per_ip_url total=\"$sum\" uniq=\"$uniq\">\n";  
	#print OUT "Totally $sum and $uniq unique.$CRLF";
	#printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
	foreach $k (sort {$s41{$b} <=> $s41{$a}} keys %s41 )
	{
	    @@_ = split "¤", $k;
	    print OUT "<entry>\n";
	    printf(OUT "  <count>%d</count>\n  <status>%d</status>\n  <srcip>%s</srcip>\n  <url>%s</url>\n",  $s41{$k},$_[0], $_[2], $_[1]);
	    print OUT "</entry>\n";
	    if ($xx++ == $topmax) { last; }
	}

	print OUT "</top_5xx_errors_per_ip_url>\n\n"; 
    } else {
        printf OUT "None. $CRLF";
    }
 
a972 1
    print OUT "$CRLF********** Top $topmax Browsers ********** $CRLF";      
a990 1
    print OUT "$CRLF********** Same Cookie from different IP-addresses ********** $CRLF";
d1016 1
a1018 1
    # ********** Unsuccessful Subdirectory Listing Attempts 
d1021 7
a1027 14
    if ($uniq gt 0) {
        #print OUT "Totally $sum and $uniq unique.$CRLF";
        #print OUT "This could inidicate attempted session hijacking.$CRLF";
        #printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s15{$b} <=> $s15{$a}} keys %s15)
        {
            @@_ = split "¤", $k;

            printf(OUT "%7d %7s %-40s %-15s %s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));

            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
d1029 2
a1033 1
    print OUT "$CRLF********** Suspected Form Data Manipulation ********** $CRLF";
d1035 9
a1043 12
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "This could inidicate attempted unauthorized database access.$CRLF";
        printf OUT "%7s %-30s %-15s %-15s %-20s$CRLF", 'Count', 'Query', 'IP', 'FQDN' ;
        foreach $k (sort {$s16{$b} <=> $s16{$a}} keys %s16)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %-30s %-15s %-15s$CRLF",  $s16{$k}, $_[1], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
d1045 1
d1049 1
a1049 1
    print OUT "$CRLF********** Attempts to locate Proxy ********** $CRLF";
d1051 12
a1062 13
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "Successfull attempts could indicate that your web server can$CRLF";
	print OUT "be used for staging Internet Attacks and fraud.$CRLF";
        printf OUT "%7s %6s %-40s %-15s %-15s %s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
        foreach $k (sort {$s17{$b} <=> $s17{$a}} keys %s17)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6d %-40s %-15s %s$CRLF",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
            if ($xx++ == $topmax) { last; }
        }
    } else {
        print OUT "None found.$CRLF";
d1064 1
a1067 1
    print OUT "$CRLF********** Exceedingly Long URL's ********** $CRLF";
d1069 11
a1079 13
    if ($uniq gt 0) {
        print OUT "Totally $sum and $uniq unique.$CRLF";
        print OUT "These could indicate attempts to locate and use Buffer Overflows$CRLF";
        print OUT "to compromise the Web Server, and shoud be considererd as serious attempts to breach Security.$CRLF";
        printf OUT "%7s %6s %10s  %-15s %-30s %-15s$CRLF", 'Count', 'Status', 'Length', 'URL', 'FQDN' ;
        foreach $k (sort {$s18{$b} <=> $s18{$a}} keys %s18)
        {
            @@_ = split "¤", $k;
            printf(OUT "%7d %6s %10s  %-30s\n%26s %-15s %s $CRLF",  $s18{$k}, $_[3], $_[2], $_[0] ,'', $_[1], resolve($_[1]));
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	print OUT "None found.$CRLF";
d1082 4
@


1.27
log
@First xml-output attempt
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.26 2003/03/18 09:53:20 root Exp $
# $Revision: 1.26 $
d82 1
a82 1
getopts('hvNs');  # If set, then don't do a name lookup
d87 1
d316 6
a321 3
} else
{
    printall();
d624 1
d629 4
a632 4
    slog('Printing text output');
    print OUT "Security Log File Analysis$CRLF";
    print OUT "SLAC v $VERSION$CRLF$CRLF";
    print OUT "Inputfile(s): " . join (" ",@@list). "$CRLF";
d634 5
a638 5
    print OUT "Log Start: $mindate$CRLF";
    print OUT "Log Stopp: $maxdate$CRLF";
    #print OUT "Execution started: " . $starttimetext . "$CRLF";
    #print OUT "Execution stopped: " . localtime() . "$CRLF";
    printf OUT "nr of analyzed rows:        %7d $CRLF", $numlines;
d640 3
a642 2
    printf OUT "nr of unique IP-addresses:  %7d $CRLF", $numip;
    print OUT "Rows identified as:$CRLF";
d644 1
a644 1
	printf OUT " %-24s %9d$CRLF", $x, $logformat{$x};
d647 2
d655 3
a657 3
    {  print OUT "Name Resolution has NOT been performed.$CRLF$CRLF"; }
    #else
    #{  print OUT "Name Resolution has been performed.$CRLF$CRLF"; }
d660 1
a660 1
    print OUT "$CRLF********** Hits / hour ********** $CRLF";
d663 1
a663 1
    printf OUT "%7s  %9s$CRLF",  'Hour', 'Hits';
d670 1
a670 1
	printf (OUT "%7d  %9s  %-50s$CRLF",  $_[0], $hits, "*" x ($hits / ($hrmax+1) * 40));
d673 1
a675 1
    # Show number of hits/hour in PNG format
d677 2
a678 25
    #my $data = GD::Graph::Data->new();
    #my $name = '/usr/local/apache/htdocs/toptalk';
    #print OUT "$CRLF********** Hits / hour ********** $CRLF";
    #sumhash (\%s7);
    #for ($k=0;$k<24;$k++)
    #{
#	$hits = $s7{sprintf("%02d", $k)};
#        if ($hits eq '') { $hits = '0'};
#	$data->add_point($k, $hits);
#}
    #my $my_graph = GD::Graph::bars->new();
    #$my_graph->set(x_label  => 'Hour',
#		   y_label  => 'Hits',
#		   title           => "Hits per hour, $mindate",
#		   y_max_value     => $max,
#		   y_tick_number   => 8,
#		   y_label_skip    => 2,
#		   #x_labels_vertical => 1,
#		   # shadows
#		   bar_spacing     => 8,
#		   shadow_depth    => 2,
#		   shadowclr       => 'dred',
#      		   transparent     => 0,
#		   )
#	or warn $my_graph->error;
a679 2
    #$my_graph->plot($data) or die $my_graph->error;
    #save_chart($my_graph, $name);
a680 3

    # Dangerous files...
    print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
d683 1
d692 1
d694 1
a694 1
	printf OUT "None. $CRLF";
d696 2
d699 1
d701 2
a702 1
    print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
d705 1
a705 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT  "%7s  %5s  %-15s  %-9s %s$CRLF", 'Count', 'Status', 'Src IP', 'User', 'URL';
d709 3
a711 1
	    printf(OUT  "%7d  %5s   %-15s  %-9s %s$CRLF",  $s2{$k},$_[0], $_[1], $_[3], $_[2]);
d713 2
a714 2
    } else {
	printf OUT "None. $CRLF";
d717 1
a717 2
    
    print OUT "$CRLF********** Logged in Users **********$CRLF";
d720 3
a722 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s  %-15s$CRLF",  'Count', 'User');
d726 4
a729 1
	    printf(OUT "%9d  %-15s$CRLF",  $s10{$k},$_[0]);
d731 1
d736 2
a737 1
    print OUT "$CRLF********** Logged in users per IP-address (excl Anonymous) **********$CRLF";
d740 1
a740 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%9s  %-15s  %-15s  %s$CRLF",  'Count', 'User', 'Src-IP', 'FQDN';
d744 3
a746 1
	    printf OUT "%9d  %-15s  %-15s  %s$CRLF",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
d748 1
a753 1
    print OUT "$CRLF********** Count of HTTP statuscodes ********** $CRLF";
d755 10
a764 8
    
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Status $CRLF";
    foreach $k (sort keys %s5 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d (%6.2f%%) HTTP Status: %-4d  %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
	printf(OUT "%9d (%6.2f%%)    %4s %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
d767 1
a768 1
    print OUT "$CRLF********** Count of HTTP Methods ********** $CRLF";
d770 2
a771 7
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )     HTTP-Method $CRLF";
    foreach $k (sort {$s19{$b} <=> $s19{$a}} keys %s19 )
    {
        @@_ = split "¤", $k;
	printf(OUT "%9d (%6.2f%%)     %s$CRLF",  $s19{$k}, ($s19{$k}*100/$sum),    $k,);
}
d773 10
d786 1
a786 1
    print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
d788 10
a797 8
    print OUT "Totally $sum and $uniq unique.$CRLF";
    print OUT "    Count     ( % )    HTTP-Version $CRLF";
    foreach $k (sort keys %s6 )
    {
	@@_ = split "¤", $k;
	#printf(OUT "Count: %9d %s  %s %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	printf(OUT "%9d (%6.2f%%)    %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
    }
a799 1
    print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
d801 7
a807 11
    if ($uniq gt 0) {
	print OUT "This could inidicate attempts to manipulate and compromise the webserver.$CRLF";
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%9s %-25s %-15s %s %-s$CRLF", 'Count' , 'HTTP String',  'IP', 'FQDN');
	foreach $k (sort keys %s61 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%9s %-25s %-15s %s  %s$CRLF",  $s61{$k}, $_[0], $_[2], resolve($_[2]));
	}
    } else {
	printf OUT "None. $CRLF";
d809 1
d811 1
d815 2
a816 1
    print OUT "$CRLF$CRLF********** Top " . ( ($uniq > $topmax) ? $topmax : $uniq)  . " HIT\'ers **********$CRLF";
d819 2
a820 2
    print OUT "Totally $sum and $uniq unique.$CRLF";
    printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
d824 2
a825 1
	printf(OUT "%4d (%6.2f%%)  %7d  %-15s  %-30s$CRLF", $xx, ($iptab{$k}*100/$sum), $iptab{$k},$_[0], resolve($_[0]));
d827 1
d830 3
a832 1
    
d834 1
a834 1
    print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
d838 3
a840 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf(OUT "%7s  %7s  %-15s$CRLF",  'Count', 'Status', 'URL');
d844 3
a846 1
	    printf(OUT "%7d  %7d  %-15s$CRLF",  $s01{$k},$_[0], $_[1]);
d849 4
a852 1
	print OUT "$CRLF$CRLF********** Top $topmax IP\'s generating 403/404 **********$CRLF";
d855 4
a858 3
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "The top IP's on this list could be the source for vulnerability scans of your  site.$CRLF";
	printf(OUT "%4s %7s   %-15s  %s$CRLF",  'Rank', "Count", "IP-Address", "FQDN");
d862 1
d864 2
a865 1
	    printf(OUT "%4d %7d   %-15s  %s$CRLF",  $xx, $s02{$k},$_[0], $sip{$_[0]});
d869 4
a872 1
	print OUT "$CRLF$CRLF********** Top $topmax Files per IP genererating 403/404 **********$CRLF";
d875 5
a879 4
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could inidicate either faultly links on your site, or$CRLF";
	print OUT "a perpetrator looking for vulnerabilities.$CRLF";
	printf(OUT "%4s %7s  %-15s  %s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
d883 3
a885 1
	    printf(OUT "%4d %7d  %-15s  %s$CRLF",  $xx, $s0{$k},$_[0], $_[1]);
d888 2
d897 1
a897 1
    print OUT "$CRLF********** Top $topmax IP\'s causing Server Errors (5xx) ********** $CRLF";
d900 1
d902 4
a905 4
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "This could indicate various attempts to cause your web server$CRLF";
	print OUT "to produce erronous results.$CRLF";  
	printf OUT "%7s  %-7s  %-15s %s$CRLF",  'Count', 'Status', 'Src IP', 'FQDN';
d909 3
a911 1
	    printf(OUT "%7d  %-7d  %-15s %s$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
d915 3
a917 1
    
d919 1
a919 1
	print OUT "$CRLF********** Top $topmax URL\'s causing Server Errors (5xx) ********** $CRLF";
d922 3
a924 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-20s$CRLF",  'Count', 'Status', 'URL';
d928 3
a930 1
	    printf(OUT "%7d  %-7d  %-20s$CRLF",  $s4{$k},$_[0], $_[1]);
d933 4
a936 2
	
	print OUT "$CRLF********** Top $topmax URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
d939 3
a941 2
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-7s  %-15s  %s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
d945 3
a947 1
	    printf(OUT "%7d  %-7d  %-15s  %s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
d950 2
d958 1
a958 1
    print OUT "$CRLF********** Top $topmax Referers ********** $CRLF";
d960 9
a968 11
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Referer' ;
	foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s11{$k},$_[0]);
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
d970 2
d977 11
a987 11
    if ($uniq > 0 ) {
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
	foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s $CRLF",  $s12{$k},$_[0]);             
	    if ($xx++ == $topmax) { last; }
	}
    } else {
	printf OUT "Not Available$CRLF";
d989 2
d996 16
a1011 23
    if ($uniq gt 0) {
	print OUT "Totally $sum and $uniq unique. Showing at maximum the top $topmax.$CRLF";
	print OUT "This could inidicate attempted session hijacking,$CRLF";
	print OUT "or users coming via a non-ip session aware proxy.$CRLF";
	printf OUT "%9s %-15s %s$CRLF", 'Count', 'IP', 'FQDN';
	#foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
	$old = '';
	foreach $k (sort keys %s14)
	{
	    #print "\$k: $k\n";
	    @@_ = split "¤", $k;
	    #print "\$_\[0\]:$_[0]$CRLF";
	    if ($old ne $_[0]) {
		print OUT "$CRLF";
		#$co = $cookie;
		$co = (length($_[0]) > 60) ? substr($_[0],0,20) . ".. [ Truncated by SLAC ] .." . substr($_[0], length($$_[0])-20,20) : $_[0];
		    
		printf OUT "Cookie: %s$CRLF", $co;
	    }
	    printf OUT "%9d %-15s %s$CRLF", $s14{$k}, $_[1], resolve($_[1]);
	    
	    $old = $_[0];
	    #if ($xx++ == $topmax) { last; }
d1013 4
a1016 2
    } else {
	print OUT "None found.$CRLF";
d1018 2
a1019 1

d1022 1
a1022 1
    print OUT "$CRLF********** Unsuccessful Subdirectory Listing Attempts ********** $CRLF";
d1024 1
d1026 1
a1026 1
        print OUT "Totally $sum and $uniq unique.$CRLF";
d1028 1
a1028 1
        printf OUT "%7s %7s %-40s %-15s %-4s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
d1032 1
d1034 1
@


1.26
log
@test
@
text
@d1 3
a3 3
#!/usr/bin/perl
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.25 2003/03/18 09:47:57 root Exp root $
# $Revision: 1.25 $
d82 6
a87 1
getopts('hvN');  # If set, then don't do a name lookup
d167 1
a167 1

d176 3
a178 3
    print "or      [perl] secsrch.pl [\-N] <infile> [outfile]$CRLF";
    print "or      [perl] secsrch.pl [\-N] \'<infile\*.gz>\' [outfile]$CRLF$CRLF";
    print "or      [perl] secsrch.pl [\-N] \'<infile\*.gz>\' [outdir]$CRLF$CRLF";
d313 6
a318 1
printall();
d619 446
d1513 8
a1520 4
    print STATS "<PeriodStart>$mindate</PeriodStart>";
    print STATS "<PeriodEnd>
    
    
d1522 2
a1523 1
}
d1525 2
d1528 1
d1552 1
@


1.25
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.24 2003/03/18 08:00:37 root Exp root $
# $Revision: 1.24 $
d241 1
a241 1
open (STATS, ">$statsfile" || die "Can't open $statsfile for output\.";
d1057 2
a1058 1
    print STATS $mindate;
@


1.24
log
@*** empty log message ***
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.23 2003/03/18 07:58:33 root Exp root $
# $Revision: $
d161 1
d241 1
d487 1
d495 1
d1054 12
@


1.23
log
@Started working on lon-time statistics gatering
@
text
@d2 2
a3 2
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.22 2003/02/20 21:28:42 root Exp $
# $Id:$
@


1.22
log
@*** empty log message ***
@
text
@d2 2
a3 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.21 2003/02/11 09:03:34 mibl Exp $
d41 1
d52 1
a52 1
$VERSION = '2.30';
@


1.21
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.20 2003/01/14 12:45:34 mibl Exp mibl $
d53 1
a53 1
#$res = 'false';
d115 18
a132 9
	      '204' => 'NO_CONTENT', '205' => 'RESET_CONTENT', 
	      '206' => 'PARTIAL_CONTENT', '300' => 'AMBIGUOUS', 
	      '301' => 'MOVED', '302' => 'REDIRECT', 
	      '303' => 'REDIRECT_METHOD', '304' => 'NOT_MODIFIED', 
	      '305' => 'USE_PROXY','307' => 'REDIRECT_KEEP_VERB', 
	      '400' => 'BAD_REQUEST', '401' => 'DENIED', 
	      '402' => 'PAYMENT_REQ', '403' => 'FORBIDDEN', 
	      '404' => 'NOT_FOUND', '405' => 'BAD_METHOD', 
	      '406' => 'NONE_ACCEPTABLE', '407' => 'PROXY_AUTH_REQ', 
d134 12
a145 5
	      '409' => 'CONFLICT', '410' => 'GONE', 
	      '411' => 'LENGTH_REQUIRED', '412' => 'PRECOND_FAILED',
	      '413' => 'REQUEST_TOO_LARGE', '414' => 'URI_TOO_LONG', 
	      '415' => 'UNSUPPORTED_MEDIA', '449' => 'RETRY_WITH', 
	      '500' => 'SERVER_ERROR', '501' => 'NOT_SUPPORTED', 
d148 2
a149 1
	      '504' => 'GATEWAY_TIMEOUT', '505' => 'VERSION_NOT_SUPPORTED');
d504 5
a508 3
    if (($status eq '200') && ($url =~ m/passwd|shadow|inetd|\/services|access\.log|cmd\.exe|\.\%..\%..|\.url|\.bat/ix))
    {
	$s3{"$ip¤$url"}++;
@


1.20
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.18 2002/11/27 08:23:24 mibl Exp mibl $
d11 2
a12 1
# Handles 'Common Log Format' (e.g. Weblogic), Standard IIS (IN??????.LOG).
a18 8
# I am definitely no Perl expert, and I know there are several 
# improvements to be made. But it at least suits my needs. And
# hopefully someone else can benefit from it, too.
#
# Even if I asked you nicely to send me any modifications and improvements
# you make to the script, you probably wouldn't do it anyway. So I won't 
# bother asking.... But you may surprise me... ;o)
#
d39 1
d45 4
a48 2
# 

d73 5
d109 6
a114 3
%STATCODE = ( '100' => 'CONTINUE', '101' => 'SWITCH_PROTOCOLS', 
	      '200' => 'OK', '201' => 'CREATED', 
	      '202' => 'ACCEPTED', '203' => 'PARTIAL', 
d143 2
d166 2
d228 1
d334 1
d586 1
a586 1
    # Check of results are OK, before mailing report
d631 34
d743 1
a743 1
    foreach $k (sort keys %s19 )
d746 1
a746 2
        #printf(OUT "Count: %9d (%6.2f%%) HTTP Status: %-4d  %s$CRLF",  $s19{$k},\($s19{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
	printf(OUT "%9d (%6.2f%%)    %4s %s$CRLF",  $s19{$k},($s19{$k}*100/$sum),    $_[0], $STATCODE{$_[0]});
d1020 6
a1025 9
if ($xx++ == $topmax) { last; }
}
} else {
    print OUT "None found.$CRLF";
}




d1031 3
a1033 1
    $sum = 0; $uniq = 0;
d1038 7
a1044 1
	    $sum = $sum + $value; $uniq++ ; 
d1096 16
@


1.19
log
@added HTTP method listing
@
text
@a696 1

a706 3



@


1.18
log
@*** empty log message ***
@
text
@d1 2
a2 2
#!/usr/local/bin/perl
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.17 2002/11/26 13:17:07 root Exp root $
d72 1
a72 1
$timing = 0;
d324 1
d414 1
d567 5
d693 18
d1033 1
d1040 1
@


1.17
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.16 2002/07/02 08:22:44 root Exp root $
d448 1
a448 1
    if (($status =~ m/404|403/))
@


1.16
log
@Removed a '^' so Common Log Format will be parsed
if sent to a syslog file
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.15 2002/06/25 15:23:25 root Exp root $
d569 4
@


1.15
log
@Fixes...
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.14 2002/06/25 14:35:25 root Exp root $
d350 1
a350 1
	if ( m/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # IP Address
@


1.14
log
@Some channges...[D[D[3~
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.13 2002/06/18 10:18:40 root Exp root $
d52 1
a52 1
#
d470 1
a470 1
	$s2{"$status¤$ip¤$url"}++;
d631 1
a631 1
	printf OUT  "%7s  %5s  %-15s  %-50s$CRLF", 'Count', 'Status', 'Src IP', 'URL';
d635 1
a635 1
	    printf(OUT  "%7d  %5s   %-15s  %-50s$CRLF",  $s2{$k},$_[0], $_[1], $_[2]);
d807 1
a807 1
	printf OUT "%7s  %-7s  %-15s  %-50s$CRLF", 'Count', 'Status', 'Src IP', 'URL' ;
d811 1
a811 1
	    printf(OUT "%7d  %-7d  %-15s  %-50s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
d860 1
a860 1
	printf OUT "%-35s$CRLF%9s %-15s %s$CRLF",  'Cookie', 'Count', 'IP', 'FQDN' ;
d865 1
a865 1
	    #print OUT "\$k: $k\n";
d867 1
d870 2
a871 3
		$co = (length($_[0]) > 60) ? 
		    substr($cookie,0,20) . ".. [ Truncated by SLAC ] .." . substr($cookie, length($cookie)-20,20)  
			: $cookie;
d928 1
a928 1
        printf OUT "%7s %6s %-40s %-15s %-15s %-20s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN';
d932 1
a932 1
            printf(OUT "%7d %6d %-40s %-15s %-15s$CRLF",  $s17{$k}, $_[1], $_[2], $_[0], resolve($_[0]));
@


1.13
log
@Remodeled Cookie Handling
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.12 2002/06/18 09:22:46 root Exp $
d527 1
a527 1
	    if ($s13{$cookie} ne $ip) {
d529 3
a531 1
		# Then we have problems...
d533 3
a535 1
	    }
d537 1
d539 4
a542 2
	    $s14{"$cookie¤$ip"}++;
	    #print "$cookie = $ip\n";
a543 7
	

	#if (defined $s13{$ip}) {
	#    
	#} else {
	#    $s13{$ip} = $cookie;
	#}
d545 1
a545 1

d858 16
a873 12
	print OUT "This could inidicate attempted session hijacking.$CRLF";
	printf OUT "%-35s$CRLF%9s %-15s$CRLF",  'Cookie', 'Count', 'IP', 'FQDN' ;
	foreach $k (sort {$s14{$b} <=> $s14{$a}} keys %s14)
	{
	    @@_ = split "¤", $k;
	    printf(OUT "%-35s$CRLF",$_[0]);
	    foreach $l (sort {$s14{$b} <=> $s14{$a}} keys %s14) {
		($a, $b) = split "¤", $l;
		if ($a eq $_[0]) {
		    printf OUT "%9d %-15s %s $CRLF", $s14{$l}, $b, resolve($b);
		}
		
d875 4
a878 1
	    if ($xx++ == $topmax) { last; }
d928 1
a928 1
        printf OUT "%7s %6s %-40s %-15s %-15s %-20s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN' ;
d1007 12
@


1.12
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.11 2002/06/17 13:19:50 root Exp root $
d72 1
a72 1
$timing =1;
d528 1
a528 1
		#print "$cookie $ip\n";
a529 1
		$s14{"$cookie¤$s13{$cookie}"}++;
d534 1
d537 7
d857 1
a857 1
	print OUT "Totally $sum and $uniq unique.$CRLF";
d859 1
a859 1
	printf OUT "%7s  %-35s %-15s %-30s$CRLF", 'Count', 'Cookie', 'IP', 'FQDN' ;
d863 8
a870 1
	    printf(OUT "%7d  %-35s %-15s %-30s$CRLF",  $s14{$k},$_[0], $_[1], resolve($_[1]));
@


1.11
log
@Added Lon URL detection
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.10 2002/06/16 22:15:48 root Exp root $
d70 3
d91 1
a91 1
else {
d217 1
d285 6
d341 4
d426 6
a482 1
	
d507 1
a507 1
    if ((not $httpver =~ m/HTTP\/\d\.\d|N\/A/) && (defined $httpver))
d517 2
a518 1
    $s11{$referer}++;
d521 1
a521 1
    $s12{$browser}++;
d547 1
a547 1
    # For example 'SELECT' in the Query, or other 'abnormal' crahacters
d553 2
a554 1
    if ($url =~ m/^.*?\shttp:\/\//ig) {
d576 1
a576 1
	printf OUT " %-25s %9d$CRLF", $x, $logformat{$x};
d578 3
d684 1
a684 1
	#printf(OUT "Count: %9d (%6.2f%%)  HTTP Version: %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
d692 1
d694 1
d698 1
a698 1
	    printf(OUT "Count: %7d (%6.2f%%) HTTP Ver: %s  IP: %s  URL: %s$CRLF",  $s61{$k}, ($s61{$k}*100/$sum), $_[0],  $_[2], $_[1]);
d706 5
a710 3
    print OUT "$CRLF$CRLF********** Top HIT\'ers **********$CRLF";
    sumhash (\%iptab);
    print OUT "Totally $sum and $uniq unique. (Only showing top $topmax)$CRLF";
d737 1
d743 1
a743 1
	    printf(OUT "%4d %7d   %-15s %s$CRLF",  $xx, $s02{$k},$_[0], $sip{$_[0]});
d751 3
a753 1
	printf(OUT "%4s %7s  %-15s  %-20s$CRLF", 'Rank', 'Count', 'Src IP', 'URL' );
d757 1
a757 1
	    printf(OUT "%4d %7d  %-15s  %-20s$CRLF",  $xx, $s0{$k},$_[0], $_[1]);
d772 2
d778 1
a778 1
	    printf(OUT "%7d  %-7d  %-15s (%s)$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
d815 11
a825 7
    print OUT "Totally $sum and $uniq unique.$CRLF";
    printf OUT "%7s  %-50s$CRLF", 'Count', 'Referer' ;
    foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
    {
	@@_ = split "¤", $k;
	printf(OUT "%7d  %-50s $CRLF",  $s11{$k},$_[0]);
	if ($xx++ == $topmax) { last; }
d832 11
a842 7
    print OUT "Totally $sum and $uniq unique.$CRLF";
    printf OUT "%7s  %-50s$CRLF", 'Count', 'Browser' ;
    foreach $k (sort {$s12{$b} <=> $s12{$a}} keys %s12 )
    {
	@@_ = split "¤", $k;
	printf(OUT "%7d  %-50s $CRLF",  $s12{$k},$_[0]);             
	if ($xx++ == $topmax) { last; }
d920 1
a920 1
    print OUT "$CRLF********** List Exceedingly Long URL's ********** $CRLF";
d980 6
a985 1
    
@


1.10
log
@Added better IIS Standard logformat handling
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.9 2002/06/16 20:56:59 root Exp root $
d354 1
d407 1
a407 1
	    print;
d417 8
d531 6
a536 1
	
d542 1
a542 1
    print OUT "Security Log File Analysis Center$CRLF";
d738 1
a738 1
    if ($uniq gt 0) {
d858 41
d918 2
a919 1
    if ($opt_N eq 1) {return $mhost;}
@


1.9
log
@Added detection of URI Query manipulation (use of SELECT, and other 'funny' charcaters)
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.8 2002/06/16 18:49:52 mibl Exp root $
d44 2
d330 1
d341 1
d353 5
a357 13
	    $url = $5; $httpver = $6; $status = $7; $len = $8;
	    if ($url =~ m/(.*?)\?(.*)/) {
		$url = $1;
		$query = $2;
		#print "query: $query\n";
	    }
	    $referer = $9; $browser = $10; $cookie = $11;
	    #if ($ip eq '131.116.254.198' ) { 
		#print "$_\nSta $status\nLen $len\n";
		#print("ref: $referer\nBro $browser\nCoo$cookie\n");
	    #}
	    #print "CLF $5\n$httpver\n\n";
	    #print "$browser\n";
d371 1
d377 14
a390 11
	       \,\x20(.+?)\,\x20(\d\d\d\d\-\d\d\-\d\d)
	       \,\x20(\d\d:\d\d:\d\d)
	       \,\x20(\w+?)
	       \,\x20(\w+?)
	       \,\x20(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})
	       \,\x20(\d+?)
	       \,\x20(\d+?)\,\x20(\d+?)\,\x20(\d+?)
	       \,\x20(\d+?)
	       \,\x20(\w+?)
	       \,\x20(.+?) 
	       \,\x20(.+)
d394 5
a398 2
	    $ip = $1; $user=$2; $date = $3 . ' ' . $4;
	    $url = $13 . ' ' . $14; $status = $11; $len = $10;
d400 1
d474 3
a476 1
    $s6{$httpver}++;
d479 1
a479 1
    if (not $httpver =~ m/HTTP\/\d\.\d|N\/A/)
d512 1
a512 1
    if (($url =~ m/\/$/) && ($status ne '200') && ($status ne '304')) {
d569 1
d815 1
a815 1
        printf OUT "%7s %7s %-40s %-15s %-20s$CRLF", 'Count', 'Status', 'URL', 'IP', 'FQDN' ;
d819 1
a819 1
            printf(OUT "%7d %7s %-40s %-15s %-20s$CRLF",  $s15{$k},$_[2], $_[1], $_[0], resolve($_[0]));
@


1.8
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.7 2002/06/16 13:51:50 mibl Exp mibl $
d52 1
a52 1
$VERSION = '2.29';
d284 1
a284 1
	$logformat{'UNKNOWN'}++;
d298 1
a298 1
	$logformat{'IISEXT'}++;
d313 1
d347 1
a347 1
	    $logformat{'CLF'}++;
d393 1
a393 1
	    $logformat{'IISSTD'}++;
d403 1
a403 1
	    $logformat{'UNKNOWN'}++;
d512 3
a514 4
    # For example 'SELECT' after the ?
    
    if ($query =~ m/select|\'|\"/gi) {
	$s16{"$ip$$query"}++;
d535 1
a535 1
	printf OUT " %-8s %9d$CRLF", $x, $logformat{$x};
d715 1
a715 1
    print OUT "$CRLF********** IP\'s causing Server Errors (5xx) ********** $CRLF";
d718 1
d725 1
d730 2
a731 1
	print OUT "$CRLF********** URL\s causing Server Errors (5xx) ********** $CRLF";
d739 1
d742 2
a743 1
	print OUT "$CRLF********** URL\'s & IP\'s causing Server Errors (5xx) ********** $CRLF";
d751 1
d821 1
a821 1
    print OUT "$CRLF********** Unsuccessful Subdirectory Listing Attempts ********** $CRLF";
d826 1
a826 1
        printf OUT "%7s %7s %-40s %-15s %-20s$CRLF", 'Count', 'Query', 'IP', 'FQDN' ;
d829 2
a830 2
            @@_ = split "$", $k;
            printf(OUT "%7d %7s %-40s %-15s %-20s$CRLF",  $s16{$k},$_[2], $_[1], $_[0], resolve($_[0]));
a836 1
    
@


1.7
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.6 2002/06/14 13:51:10 mibl Exp mibl $
d349 5
d509 7
d807 18
@


1.6
log
@Added Cokki manipulation
Added Directory Traversal browsing
@
text
@d2 1
a2 1
# $Header: /usr/local/bin/RCS/secsrch.pl,v 1.5 2002/06/14 12:15:22 mibl Exp mibl $
d283 2
a284 1
	$badlines++;
d298 1
d345 1
d387 1
d397 2
a398 1
	    $badlines++;
d502 1
a502 1
	$s15{"$ip¤$url"}++;
d519 1
a519 1
    printf OUT "nr of non-analyzed rows:    %7d $CRLF", $badlines;
d521 4
d790 1
a790 1
        printf OUT "%7s  %-40s %-15s %-20s$CRLF", 'Count', 'URL', 'IP', 'FQDN' ;
d794 1
a794 1
            printf(OUT "%7d  %-40s %-15s %-20s$CRLF",  $s15{$k},$_[1], $_[0], resolve($_[0]));
@


1.5
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Header$
d119 1
a119 2
	      '415' => 'UNSUPPORTED_MEDIA',
	      '449' => 'RETRY_WITH', 
a124 1

d229 10
a238 10
	#slog("Zip File");
    	#$zip = Archive::Zip->new();
    	#die 'read error' unless $zip->read($file) == AZ_OK;
	#my @@member = $zip->memberNames();
	#print $zip->numberOfMembers();
	##print $zip->memberNames;
	#foreach $x (@@member) {
	#    print "$x\n";
	#    $zip->extractMember($x, '/tmp/' . $x);

d240 13
a252 13
	#    open (IN, "</tmp/$x") || die "Can't open $file for input.$CRLF";
	#    while (<IN>)
	#    {
	#	# Can we parse the current line?
	#	if (splitline() != -1) {
	#	    if (($date le $mindate) || ($mindate eq '')) {$mindate = $date};
	#	    if (($date gt $maxdate) || ($maxdate eq '')) {$maxdate = $date};
	#	    # Yepp, then make statistics...
	#	    makestats();
	#	}
	#    }
	#    close IN;
	#} 
a313 1
	
d334 1
a334 1
	     \s\"(.*?)               # Request
d338 1
a338 1
	     (?:\s\"(.*?)\")?                    # Optional Referer
d347 4
d479 1
d482 1
d489 1
a489 1
	    print " $cookie = $ip\n";
d494 4
a497 3
    if (($url =~ m/\/$/) && ($status ne '200')) {
	$s15{'$ip¤$url'};

d755 37
a792 3
    
    
    #close IN;
@


1.4
log
@*** empty log message ***
@
text
@d2 1
a2 1
# $Revision$
@


1.3
log
@*** empty log message ***
@
text
@d2 1
@


1.2
log
@Lots of changes!
@
text
@d51 1
a51 1
$VERSION = '2.28';
d449 2
a450 1
    
d472 1
d476 1
a476 1
    if ($cookie ne '-') {
d479 1
a481 1
		# problems
d488 7
@


1.1
log
@Initial revision
@
text
@d42 1
d51 1
a51 1
$VERSION = '2.25';
d59 1
a59 1

d65 7
d73 2
a74 1
getopts('N');  # If set, then don't do a name lookup
d77 7
a83 4
if ($ENV{'OS'} =~ m/windows/i) 
{
	$os = 'win'; 		#Windows
	$osenv = 'OS';
d85 2
a86 8
elsif ($ENV{'OSTYPE'} =~ m/solaris/i) 
{
	$os = 'sol';		#Solaris
	$osenv = 'OSTYPE';
}
else
{
	$os = 'unknown';
d95 5
a99 3
%MONS = ( 'Jan' => '01', 'Feb' => '02', 'Mar' => '03', 'Apr' => '04', 'May' => '05', 'Jun' => '06',
					'Jul' => '07', 'Aug' => '08', 'Sep' => '09', 'Oct' => '10', 'Nov' => '11', 'Dec' => '12');
					
d102 22
a123 11
%STATCODE = ( '100' => 'CONTINUE', '101' => 'SWITCH_PROTOCOLS', '200' => 'OK', '201' => 'CREATED', 
'202' => 'ACCEPTED', '203' => 'PARTIAL', '204' => 'NO_CONTENT', '205' => 'RESET_CONTENT', 
'206' => 'PARTIAL_CONTENT', '300' => 'AMBIGUOUS', '301' => 'MOVED', '302' => 'REDIRECT', 
'303' => 'REDIRECT_METHOD', '304' => 'NOT_MODIFIED', '305' => 'USE_PROXY', 
'307' => 'REDIRECT_KEEP_VERB', '400' => 'BAD_REQUEST', '401' => 'DENIED', 
'402' => 'PAYMENT_REQ', '403' => 'FORBIDDEN', '404' => 'NOT_FOUND', '405' => 'BAD_METHOD', 
'406' => 'NONE_ACCEPTABLE', '407' => 'PROXY_AUTH_REQ', '408' => 'REQUEST_TIMEOUT',
'409' => 'CONFLICT', '410' => 'GONE', '411' => 'LENGTH_REQUIRED', '412' => 'PRECOND_FAILED',
'413' => 'REQUEST_TOO_LARGE', '414' => 'URI_TOO_LONG', '415' => 'UNSUPPORTED_MEDIA',
'449' => 'RETRY_WITH', '500' => 'SERVER_ERROR', '501' => 'NOT_SUPPORTED', '502' => 'BAD_GATEWAY',
'503' => 'SERVICE_UNAVAILABLE', '504' => 'GATEWAY_TIMEOUT', '505' => 'VERSION_NOT_SUPPORTED');
d138 1
a138 1
if (($infile eq '-h') || ($infile eq '/?') || ($infile eq '--help')) {
d151 1
a151 1
if (($infile eq '-v') || ($infile eq '-V')) {	
d164 1
a164 3
}
else 
{
d167 2
a168 2
    if (join( '', @@list) eq "")
    {
d173 1
a173 2
    if ($outfile eq '-')
    {
d179 1
a179 2
	if ( -d $outfile) 
	{
d181 2
a182 5
	} 
	else 
	{
	    if ($outfile eq '')
	    {	
d209 1
a209 1
print "Infile(s): " . join (" $CRLF",@@list) . " $CRLFOutfile: $outfile $CRLF";
d228 28
a255 3
    }
    else
    {
d269 1
d275 1
d278 1
d280 1
a280 1
    # Split Logfile line into values. Dirty, but it works...
d282 2
a283 72
    # Common Log Format (Weblogic, Apache etc)
    if ( m/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})   # IP Address
	 \x20(.+?)                        # User
	 \x20(.+?)                        # unused
	 \x20(\[.+\])                     # Date
	 \x20\"(.*?\n*?.*?)               # Request
	 (HTTP\/.*?|)\" 		  # Match regardless of HTTP Version.
	 \x20(\d+?)                       # Statuscodes
	 \x20([\-\d]+?)                   # Size
	 (?:\x20(\".*?\"))?                    # Optional Referer
	 (?:\x20(\".*?\"))?                    # Optinal Browser type
	 /ox )                    
    {
	$logformat{'CLF'}++;
	$ip = $1; $na1 = $2; $user=$3; $date = $4;
	$url = $5; $httpver = $6; $status = $7; $len = $8;
	$referer = $9; $browser = $10;
	#print "$referer\n";
	#print "$browser\n";
	if ( $date =~ m/^\[(\d{1,2})
	     \/(.{3})
	     \/(\d\d\d\d)
	     \:(\d+?)
	     \:(\d+?)
	     \:(\d+?)
	     \x20(.+?)\]/ox)
	{
	    $day = $1; $mon = $2; $yr = $3; $hr = $4; $mi = $5; $se = $6;
	    $date = "$yr\-$MONS{$mon}\-$day $hr:$mi:$se";
	    #if (($date le $mindate) || ($mindate eq '')) {$mindate = $date};
	    #if (($date gt $maxdate) || ($maxdate eq '')) {$maxdate = $date};
	}
	return 1;
    }
    
    #IIS Logs Standard Logs (INxxxxxx.log)
    elsif (m/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})
	   \,\x20(.+?)\,\x20(\d\d\d\d\-\d\d\-\d\d)
	   \,\x20(\d\d:\d\d:\d\d)
	   \,\x20(\w+?)
	   \,\x20(\w+?)
	   \,\x20(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})
	   \,\x20(\d+?)
	   \,\x20(\d+?)\,\x20(\d+?)\,\x20(\d+?)
	   \,\x20(\d+?)
	   \,\x20(\w+?)
	   \,\x20(.+?) 
	   \,\x20(.+)
	   \,.*/ox)
    {
	$ip = $1; $user=$2; $date = $3 . ' ' . $4;
	$url = $13 . ' ' . $14; $status = $11; $len = $10;
	return 1;
    }
    # Extended IIS logs, with very few options...
    elsif (m/^(\d\d:\d\d:\d\d)
	   \x20(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})
	   \x20(\w+?\x20.+)
	   \x20(\d+)/ox)
    {
	$ip =$2; $date = $exdate . ' ' . $1; $url = $3; $status = $4;
	$httpver = 'N/A'; $user = 'N/A';
	#if (($date le $mindate) || ($mindate eq '')) {$mindate = $date};
	#if (($date gt $maxdate) || ($maxdate eq '')) {$maxdate = $date};
	
	#print "$url \- $status\n";
    }
    # Here you could easily add other Logfile formats...
    
    # No Match...
    else 
    {
d285 6
a290 4
	#print "Unparsed Line: $_$CRLF";
	# Check if an unmatched line is actually a header of an IIS extended logfile
	if (m/\#Date\: (\d\d\d\d\-\d\d\-\d\d)\s(\d\d\:\d\d:\d\d)/)
	{
d292 1
a292 1
	    print "Assuming IIS EX file: $1 - $2$CRLF";
d294 36
d331 55
d387 6
a392 1
	return -1;
a395 1

d402 2
a403 2
    if (($status =~ m/404|403/) && 
	(not $url =~ m/favicon|GET.\/images|\/img\/meny/ix))
d471 15
a485 2
    $s12{'$browser'}++;
    
a488 19
	
	print OUT "Security Analysis of webserver logfiles$CRLF";
	print OUT "SecSrch v $VERSION$CRLF$CRLF";
	print OUT "Inputfile(s): " . join (" ",@@list). "$CRLF";
	print OUT "Outputfile: $outfile $CRLF";
	print OUT "Log Start: $mindate$CRLF";
	print OUT "Log Stopp: $maxdate$CRLF";
	print OUT "Execution started: " . $starttimetext . "$CRLF";
	print OUT "Execution stopped: " . localtime() . "$CRLF";
	printf OUT "nr of analyzed rows:        %7d $CRLF", $numlines;
	printf OUT "nr of non-analyzed rows:    %7d $CRLF", $badlines;
	printf OUT "nr of unique IP-addresses:  %7d $CRLF", $numip;
	printf OUT "nr of analyzed rows/second: %7d $CRLF", $numlines / (time - $starttime + 1);
	printf OUT "nr of $logformat{'CLF'}\n";
 
	if ($opt_N ne '') 
	{  print OUT "Name Resolution has NOT been performed.$CRLF$CRLF"; }
	else
	{  print OUT "Name Resolution has been performed.$CRLF$CRLF"; }
d490 38
a527 14
	# Show number of hits/hour
	print OUT "$CRLF********** Hits / hour ********** $CRLF";
	sumhash (\%s7);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	printf OUT "%7s  %-15s$CRLF",  'Hour', 'Count';
	foreach $k (sort keys %s7)
	{
		@@_ = split "¤", $k;
		printf (OUT "%7d  %9s  %-50s$CRLF",  $_[0], $s7{$k}, "*" x ($s7{$k} / $hrmax * 40));
	}

	# Dangerous files...
	print OUT "$CRLF********** Successful attempts to retrieve \'Dangerous\' files ********** $CRLF";
	sumhash (\%s3);
d532 2
a533 2
		@@_ = split "¤", $k;
		printf (OUT "%7d  %-15s  %-50s$CRLF",  $s3{$k},$_[0], $_[1]);
d535 8
a542 4
		
	# Unauthorized
	print OUT "$CRLF********** Users who have accessed protected pages ********** $CRLF";
	sumhash (\%s2);
d547 2
a548 2
		@@_ = split "¤", $k;
		printf(OUT  "%7d  %5s   %-15s  %-50s$CRLF",  $s2{$k},$_[0], $_[1], $_[2]);
d550 8
a557 3
	
	print OUT "$CRLF********** Logged in Users **********$CRLF";
	sumhash (\%s10);
d562 2
a563 2
		@@_ = split "¤", $k;
		printf(OUT "%9d  %-15s$CRLF",  $s10{$k},$_[0]);
d565 7
a571 3
	
	print OUT "$CRLF********** Logged in users per IP-address (excl Anonymous) **********$CRLF";
	sumhash (\%s1);
d576 2
a577 2
		@@_ = split "¤", $k;
		printf OUT "%9d  %-15s  %-15s  %s$CRLF",  $s1{$k},$_[0], $_[1], $sip{$_[1]};
d579 33
a611 5
	
	# Count of all Statuscodes...
	print OUT "$CRLF********** Count of HTTP statuscodes ********** $CRLF";
	sumhash (\%s5);
	
d613 1
a613 2
	print OUT "    Count     ( % )     HTTP-Status $CRLF";
	foreach $k (sort keys %s5 )
d615 2
a616 3
		@@_ = split "¤", $k;
		#printf(OUT "Count: %9d (%6.2f%%) HTTP Status: %-4d  %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
		printf(OUT "%9d (%6.2f%%)    %4s %s$CRLF",  $s5{$k},($s5{$k}*100/$sum), $_[0], $STATCODE{$_[0]});
d618 3
d622 19
a640 40
	# Count of all HTTP Versions...
	print OUT "$CRLF********** Count of HTTP Versions ********** $CRLF";
	sumhash (\%s6);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	print OUT "    Count     ( % )    HTTP-Version $CRLF";
	foreach $k (sort keys %s6 )
	{
		@@_ = split "¤", $k;
		#printf(OUT "Count: %9d (%6.2f%%)  HTTP Version: %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
		printf(OUT "%9d (%6.2f%%)    %s$CRLF",  $s6{$k}, ($s6{$k}*100/$sum), $_[0]);
	}

	# List illegal HTTP Versions...
	print OUT "$CRLF********** List illegal HTTP Versions ********** $CRLF";
	sumhash (\%s61);
	print OUT "Totally $sum and $uniq unique.$CRLF";
	foreach $k (sort keys %s61 )
	{
		@@_ = split "¤", $k;
		printf(OUT "Count: %7d (%6.2f%%) HTTP Ver: %s  IP: %s  URL: %s$CRLF",  $s61{$k}, ($s61{$k}*100/$sum), $_[0],  $_[2], $_[1]);
	}
	
	# List the Top HIT'ers
	
	print OUT "$CRLF$CRLF********** Top HIT\'ers **********$CRLF";
	sumhash (\%iptab);
	print OUT "Totally $sum and $uniq unique. (Only showing top $topmax)$CRLF";
	printf(OUT "%4s %8s   %7s  %-15s  %-30s$CRLF", 'Rank', '%', 'Count', 'IP', 'FQDN');
	foreach $k (sort {$iptab{$b} <=> $iptab{$a}} keys %iptab )
	{
		@@_ = split "¤", $k;
		printf(OUT "%4d (%6.2f%%)  %7d  %-15s  %-30s$CRLF", $xx + 1, ($iptab{$k}*100/$sum), $iptab{$k},$_[0], resolve($_[0]));
		if (++$xx == $topmax) 
		{ last; }
	}
				

	# List attempts to access non-existing pages
	print OUT "$CRLF$CRLF********** Access attempts generating 403/404 messages **********$CRLF";
	sumhash (\%s01);
d645 2
a646 2
		@@_ = split "¤", $k;
		printf(OUT "%7d  %7d  %-15s$CRLF",  $s01{$k},$_[0], $_[1])
d648 3
a650 2
				
	print OUT "$CRLF$CRLF********** IP\'s generating 403/404 **********$CRLF";
d653 1
a653 1
	printf(OUT "%7s   %-15s  %s$CRLF",  "Count", "IP-Address", "FQDN");
d656 4
a659 3
		@@_ = split "¤", $k;
		#printf(OUT "Count:  %7d  IP: %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
		printf(OUT "%7d   %-15s (%s)$CRLF",  $s02{$k},$_[0], $sip{$_[0]})
d662 2
a663 1
	print OUT "$CRLF$CRLF********** Files per IP genererating 403/404 (filtered) **********$CRLF";
d666 1
a666 1
	printf(OUT "%7s  %-15s  %-20s$CRLF", 'Count', 'Src IP', 'URL' );
d669 3
a671 2
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-15s  %-20s$CRLF",  $s0{$k},$_[0], $_[1])
d673 4
d678 5
a682 3
	# 5xx Status
	print OUT "$CRLF********** IP\'s causing Server Errors (5xx) ********** $CRLF";
	sumhash (\%s42);
d687 2
a688 2
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-7d  %-15s (%s)$CRLF",  $s42{$k},$_[0], $_[1], $sip{$_[1]});
d690 2
a691 1

d699 2
a700 2
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-7d  %-20s$CRLF",  $s4{$k},$_[0], $_[1]);
d702 1
a702 1

d709 2
a710 2
		@@_ = split "¤", $k;
		printf(OUT "%7d  %-7d  %-15s  %-50s$CRLF",  $s41{$k},$_[0], $_[2], $_[1]);
d712 34
a745 17

	# Top Referers
        print OUT "$CRLF********** Top Referers (5xx) ********** $CRLF";
        sumhash (\%s11);
        print OUT "Totally $sum and $uniq unique.$CRLF";
        printf OUT "%7s  %-50s$CRLF", 'Count', 'Referer' ;
        foreach $k (sort {$s11{$b} <=> $s11{$a}} keys %s11 )
        {
	    @@_ = split "¤", $k;
	    printf(OUT "%7d  %-50s  %-15s  %-50s$CRLF",  $s11{$k},$_[0], $_[2], $_[1]);
        }



	
	close IN;
	close OUT;
d750 4
a753 2
	$sum = 0; $uniq = 0;
	foreach $href (@@_)
d755 1
a755 4
		while ( ($key, $value) = each %$href ) 
		{
			$sum = $sum + $value; $uniq++ ; 
		}
d757 1
d762 23
a784 15
	
  local ($mname, $miaddr, $mhost = shift);
	if ($opt_N eq 1) {return $mhost;}
	# if (not $res eq 'true') { return $mhost }
  $miaddr = inet_aton($mhost);
  $HOSTS{$mhost} = gethostbyaddr($miaddr, AF_INET);
  if (!$HOSTS{$mhost}) {
    $mname ="";
    #die if $@@ && $@@ ne "alarm\n";  # propagate errors
    if ($mname =~ /^$/) {
      $mname = $mhost;
    }
    $HOSTS{$mhost} = $mname;
  }
  return $HOSTS{$mhost};
@
